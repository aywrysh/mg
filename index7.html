<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex-(XAU/USD)</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --gray:#C7C7C7; --accent:#F36523;
      --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --top:54px; --radius:14px; --top-icon:#1E3A8A;
      --surface:#f7f8fa; --shadow:0 8px 16px rgba(0,0,0,.06); --shadow-2:0 14px 26px rgba(0,0,0,.10);
      --success:#16a34a; --danger:#ef4444;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff;min-height:100dvh;overflow-x:hidden}

    .appbar{position:fixed;top:0;inset-inline:0;height:var(--top);z-index:50;background:var(--gray);
      display:flex;align-items:center;justify-content:space-between;padding:4px 10px;box-shadow:0 1px 0 #bfbfbf}
    .accent-line{height:3px;background:var(--accent)}
    .btn{width:40px;height:40px;border-radius:12px;background:#fff;border:1px solid #d3d3d3;display:grid;place-items:center;cursor:pointer;color:var(--top-icon);position:relative;overflow:hidden}
    .btn.orange{color:var(--accent)}
    .ms{font-family:'Material Symbols Rounded';font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24;line-height:1}

    .page{width:min(520px,92vw);margin:0 auto;padding:14px 0 84px; padding-top:calc(var(--top) + 16px);}
    h1{margin:8px 10px 10px;font-size:20px}

    .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 10px;margin-bottom:10px}
    .stat{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:6px}
    .stat .label{color:var(--muted);font-weight:800;font-size:12px}
    .stat .value{font-weight:900;font-size:18px}

    .summary{background:var(--surface);border:1px solid var(--line);border-radius:18px;padding:12px;margin:0 10px 12px;box-shadow:var(--shadow)}
    .pair{font-weight:900;font-size:18px}
    .price{font-size:22px;font-weight:900}
    .chg.up{color:var(--success)} .chg.down{color:var(--danger)}
    .row{display:flex;align-items:center;gap:10px}
    .btn-solid{padding:10px 12px;border-radius:12px;border:1px solid var(--line);font-weight:800;cursor:pointer;background:#fff}
    .btn-solid.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .ghost{opacity:.7}

    .chart-card{background:#fff;border:1px solid var(--line);border-radius:18px;margin:0 10px 12px;box-shadow:var(--shadow-2);padding:10px}
    .chart-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap}
    .canvas-wrap{position:relative;border:1px dashed #e5e7eb;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa)}
    #candle{display:block;width:100%;height:320px}

    .tools{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .zoom-range{appearance:none;width:140px;height:6px;border-radius:999px;background:#f1f5f9;border:1px solid #e5e7eb;overflow:hidden}
    .zoom-range::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);border:none;box-shadow:0 0 0 3px rgba(243,101,35,.18)}

    .progress{height:8px;border-radius:999px;background:#f1f5f9;border:1px solid #e5e7eb;overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#f59e0b,#F36523);transition:width .25s}

    .list{display:grid;gap:10px;padding:0 10px}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
    .mini{display:flex;align-items:center;justify-content:space-between}
    .mini .l{display:flex;align-items:center;gap:10px}
    .mini .icon{width:36px;height:36px;border-radius:10px;background:#fff;border:1px solid var(--line);display:grid;place-items:center}
    .mini .name{font-weight:900}
    .mini .val{font-weight:900}

    .side-backdrop,.sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;visibility:hidden;pointer-events:none;transition:.25s;z-index:60}
    .sidepanel{
      position:fixed;top:var(--top);bottom:0;right:0;width:320px;max-width:86vw;background:#fff;border-left:1px solid var(--line);
      box-shadow:0 -10px 30px rgba(0,0,0,.2);transform:translateX(100%);transition:.3s;z-index:61;padding:12px 12px 18px;overflow:auto
    }
    .sidepanel.active{transform:translateX(0)}
    .side-backdrop.active{opacity:1;visibility:visible;pointer-events:auto}

    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -10px 28px rgba(0,0,0,.2);
      transform:translateY(100%);transition:.3s;z-index:61;padding:14px;border:1px solid #ececec;max-width:520px;margin:0 auto}
    .sheet.active{transform:translateY(0)}
    .sheet-backdrop.active{opacity:1;visibility:visible;pointer-events:auto}
    .grab{width:40px;height:4px;border-radius:3px;background:#e5e7eb;margin:4px auto 12px}

    .toast{position:fixed;bottom:78px;left:50%;transform:translateX(-50%) scale(.96);background:rgba(17,17,17,.92);color:#fff;
      padding:8px 12px;border-radius:10px;font-weight:800;font-size:12px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:70}
    .toast.show{opacity:1;transform:translateX(-50%) scale(1)}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(0,0,0,.18);animation:ripple .6s linear;pointer-events:none}
    @keyframes ripple{to{transform:scale(3);opacity:0}}

    /* === إضافات زر الأرباح السابقة + شيت السجل === */
    .fab{
      position:fixed; right:14px; bottom:18px; z-index:65;
      width:54px; height:54px; border-radius:16px;
      display:grid; place-items:center; cursor:pointer;
      background:#fff; border:1px solid var(--line); box-shadow:0 10px 26px rgba(0,0,0,.18);
      color:var(--accent); font-weight:900;
    }
    .hist-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .hist-list{max-height:52vh; overflow:auto; display:grid; gap:8px}
    .hist-item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fafafa}
    .hist-item .amt{font-weight:900}
    .hist-empty{padding:12px;border:1px dashed #e5e7eb;border-radius:12px;text-align:center;color:#6b7280}
  </style>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e5e7eb">
  
  <link rel="icon" type="image/png" sizes="32x32" href="32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="16x16.png">
<link rel="shortcut icon" href="/favicon.ico">

<!-- iOS -->
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">

<!-- Android / PWA -->
<link rel="manifest" href="/site.webmanifest">

<!-- Safari pinned tab (اختياري) -->
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#e5e7eb">

<!-- ألوان النظام (اختياري) -->

<meta name="msapplication-TileColor" content="#e5e7eb">





  
  
</head>
<body>

  <!-- الشريط العلوي -->
  <header class="appbar">
    <button class="btn orange" id="backBtn" title="خروج"> <img src="ايقونةخروج.png" alt="back" width="24" height="24" loading="lazy"></button>
    <div class="row" style="gap:8px;align-items:center">
      <button class="btn" id="refreshBtn" title="تحديث">  <img class="ms" src="تحديث.png" alt="تحديث" width="24" height="24" loading="lazy"></button>
      <button class="btn" id="optBtn" title="المؤشرات"><img class="ms" src="الاماشرات.png" alt="تحديث" width="24" height="24" loading="lazy"></button>
    
      <button class="btn" id="supportBtn" title="خدمة العملاء"><img class="ms" src="ايقوناتتواصل.png" alt="تحديث" width="24" height="24" loading="lazy"></button>
     <button class="btn orange" id="langBtn" title="تغيير اللغة">
 <img src="ايقونةترجمه.png" alt="translate" width="24" height="24" loading="lazy">
</button>
    </div>
  </header>
  <div class="accent-line"></div>

  <main class="page">
    <h1>تداول الذهب</h1>

    <div class="stats">
      <div class="stat"><div class="label">الرصيد الحالي</div><div class="value" id="balVal">--.- USD</div></div>
      <div class="stat"><div class="label">الأرباح المتراكمة</div><div class="value" id="profitVal">--.- USD</div></div>
    </div>

   <div class="summary">
  <div class="row" style="justify-content:space-between">
    <div>
      <div class="pair" id="pairTxt">XAU / USD</div>
      <div class="row" style="gap:8px;margin-top:6px">
        <div class="row ghost" style="gap:6px"><span id="hi">—</span></div>
        <div class="row ghost" style="gap:6px"><span id="lo">—</span></div>
        <div class="row ghost" style="gap:6px">24h</div>
      </div>
    </div>
    <div style="text-align:end">
      <div class="price" id="priceNow">—</div>
      <div class="chg" id="chg24">—</div>
    </div>
  </div>
  <div class="row" style="gap:8px;margin-top:10px;flex-wrap:wrap">
    <button class="btn-solid primary" id="startBtn">بدء التداول 24h</button>
    <div class="tools">
      <button class="btn" id="zoomOut" title="تصغير">
        <img class="ms" src="تسغير.png" alt="zoom out" width="24" height="24" loading="lazy">
      </button>
      <input id="zoomRange" class="zoom-range" type="range" min="0.5" max="2.0" step="0.05" value="1">
      <button class="btn" id="zoomIn" title="تكبير">
        <img class="ms" src="تكبير.png" alt="zoom in" width="24" height="24" loading="lazy">
      </button>
    </div>
  </div>
  <div class="progress" style="margin-top:10px"><div class="bar" id="progBar"></div></div>
  <div class="ghost" id="simNote" style="margin-top:6px;font-size:12px">
    جلسة تداول مؤقتة تستمر 24 ساعة (تعمل حتى لو أغلقت الصفحة).
  </div>
</div>

    <div class="chart-card" id="chartCard">
      <div class="chart-head">
        <div class="row" style="gap:8px">
        
          <b>الرسم البياني (XAU/USD)</b>
        </div>
        <div class="row" style="gap:6px">
          <button class="btn" id="resetZoom" title="إعادة الضبط"><img class="ms" src="الاماشرات.png" alt="تحديث" width="24" height="24" loading="lazy"></button>
        </div>
      </div>
      <div class="canvas-wrap">
        <canvas id="candle"></canvas>
      </div>
    </div>

    <div class="list" id="miniList">
      <div class="card">
        <div class="mini">
          <div class="l">
            <div class="icon"> <img class="ms" src="ذهب.png" alt="zoom in" width="24" height="24" loading="lazy"></div>
            <div><div class="name">XAU / USD</div><div class="ghost" style="font-size:12px">ذهب × دولار</div></div>
          </div>
          <div style="text-align:end">
            <div class="val" id="miniVal">—</div>
            <div class="ghost" id="miniChg" style="font-size:12px">—</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- لوحة المؤشرات -->
  <div class="side-backdrop" id="optBack"></div>
  <aside class="sidepanel" id="optPanel" aria-modal="true" role="dialog">
    <h3 style="font-weight:900;margin:0 0 8px">المؤشرات</h3>

    <div class="card" style="margin:0 0 10px">
      <div class="row" style="justify-content:space-between">
        <label><input type="checkbox" id="sma20" checked> SMA</label>
        <div class="row" style="gap:6px"><small class="ghost">الفترة</small><input type="number" id="smaPeriod" value="20" min="2" max="200" style="width:84px;padding:8px;border:1px solid var(--line);border-radius:10px"></div>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <label><input type="checkbox" id="sma50"> SMA</label>
        <div class="row" style="gap:6px"><small class="ghost">الفترة</small><input type="number" id="smaPeriod2" value="50" min="2" max="400" style="width:84px;padding:8px;border:1px solid var(--line);border-radius:10px"></div>
      </div>
    </div>

    <div class="card" style="margin:0 0 10px">
      <div class="row" style="justify-content:space-between">
        <label><input type="checkbox" id="ema12"> EMA</label>
        <div class="row" style="gap:6px"><small class="ghost">الفترة</small><input type="number" id="emaPeriod" value="12" min="2" max="200" style="width:84px;padding:8px;border:1px solid var(--line);border-radius:10px"></div>
      </div>
    </div>

    <div class="card" style="margin:0 0 10px">
      <div class="row" style="justify-content:space-between;flex-wrap:wrap">
        <label><input type="checkbox" id="boll"> Bollinger Bands</label>
        <div class="row" style="gap:6px"><small class="ghost">الفترة</small><input type="number" id="bollPeriod" value="20" min="5" max="400" style="width:84px;padding:8px;border:1px solid var(--line);border-radius:10px"></div>
        <div class="row" style="gap:6px"><small class="ghost">الانحراف</small><input type="number" id="bollStd" value="2" min="1" max="4" step="0.5" style="width:84px;padding:8px;border:1px solid var(--line);border-radius:10px"></div>
      </div>
    </div>

    <div class="card" style="margin:0 0 10px">
      <div class="row" style="justify-content:space-between">
        <label class="ghost">عرض الشموع</label>
        <input type="range" id="widthRange" min="0.4" max="0.9" step="0.02" value="0.6" style="flex:1">
      </div>
    </div>

    <div class="row" style="gap:8px">
      <button class="btn-solid" id="optClose" style="flex:1">إغلاق</button>
      <button class="btn-solid primary" id="optApply" style="flex:1">تطبيق</button>
    </div>
  </aside>

  <!-- شيت اللغة -->
  <div class="sheet-backdrop" id="sheetBack"></div>
  <div class="sheet" id="langSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>
    <div class="row" style="gap:8px">
      <button class="btn-solid" data-setlang="ar" style="flex:1">العربية</button>
      <button class="btn-solid" data-setlang="en" style="flex:1">English</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- === زر الأرباح السابقة === -->
  <button class="fab" id="histBtn" title="عرض الأرباح السابقة"><img class="ms" src="سابق.png" alt="zoom in" width="24" height="24" loading="lazy"></button>

  <!-- شيت سجل الأرباح -->
  <div class="sheet-backdrop" id="histBack"></div>
  <div class="sheet" id="histSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>
    <div class="hist-head">
      <b>الأرباح السابقة</b>
      <div class="ghost" id="histTotal">الإجمالي: 0.00 USD</div>
    </div>
    <div id="histList" class="hist-list">
      <div class="hist-empty">لا توجد أرباح محفوظة بعد.</div>
    </div>
    <div class="row" style="gap:8px;margin-top:10px">
      <button class="btn-solid" id="histClose" style="flex:1">إغلاق</button>
    </div>
  </div>

  <!-- i18n -->
  <script src="i18n.js"></script>

  <!-- ✅ Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    /* ===== Helpers ===== */
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const on = (sel, ev, cb) => { const el = (typeof sel === 'string') ? $(sel) : sel; if (el) el.addEventListener(ev, cb, false); };
    const fmtUSD = n => (n||0).toFixed(2) + ' USD';
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }

    // === i18n helpers ===
    function curLang(){ return (localStorage.getItem('lang')||'ar'); }
    function T(ar, en){ return curLang()==='en' ? en : ar; }
    function i18nSet(el, ar, en){
      if(!el) return;
      el.innerHTML = T(ar,en);
      document.dispatchEvent(new CustomEvent('i18n:change',{detail:{lang:curLang()}}));
    }

    // Ripple
    document.addEventListener('click', (e)=>{
      const host = e.target.closest('.btn, .btn-solid'); if(!host) return;
      const r=document.createElement('span'); const d=Math.max(host.clientWidth, host.clientHeight);
      const rect=host.getBoundingClientRect(); r.className='ripple'; r.style.width=r.style.height=d+'px';
      r.style.left=(e.clientX-rect.left-d/2)+'px'; r.style.top=(e.clientY-rect.top-d/2)+'px';
      const old=host.querySelector('.ripple'); if(old) old.remove(); host.appendChild(r); setTimeout(()=>r.remove(),600);
    }, false);

    /* ===== Firebase ===== */
    const cfg = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain:"dynex-f4486.firebaseapp.com",
      databaseURL:"https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId:"dynex-f4486",
      storageBucket:"dynex-f4486.firebasestorage.app"
    };
    if(!firebase.apps.length) firebase.initializeApp(cfg);
    const db = firebase.database();

    /* ===== Session ===== */
    const SESSION = (function(){ try{ return JSON.parse(localStorage.getItem('dynex_session')||'null'); }catch(_){ return null; }})();
    if(!SESSION || !SESSION.uid){ toast('الرجاء تسجيل الدخول'); setTimeout(()=>{ window.location.replace('index.html'); }, 900); return; }
    const UID = SESSION.uid;

    /* ===== Wallet live ===== */
    const WAL = { balance:0, locked:0, profitLocal:0 };
    db.ref('users/'+UID).on('value', s=>{
      const u=s.val()||{};
      WAL.balance = Number(u.balance||0);
      WAL.locked  = Number(u.lockedAmount||0);   /* ← نقرأ العقد المقفل */
      $('#balVal').textContent = fmtUSD(WAL.balance);
    }, err=>{ console.error(err); toast('تعذّر جلب الرصيد'); });

    /* ===== Trading state ===== */
    const TREF = db.ref('trading/'+UID+'/current'); // {startAt,durationMs,seed,startBalance,startLocked,status,profit,profitApplied}
    const DURATION_MS = 24*60*60*1000; // 24h
    const STEP_MS = 5*60*1000;         // 5m per candle -> 288 شمعة
    const TOTAL_STEPS = Math.floor(DURATION_MS/STEP_MS);

    /* ✅ الحد الأدنى لبدء التداول (كما هو) */
    const MIN_BALANCE = 25;

    // pending profit (للخروج/انقطاع النت)
    const PENDING_KEY='xau_pending_profit';
    function savePending(p){ localStorage.setItem(PENDING_KEY, JSON.stringify(p)); }
    function loadPending(){ try{return JSON.parse(localStorage.getItem(PENDING_KEY)||'null');}catch(_){return null;} }
    function clearPending(){ localStorage.removeItem(PENDING_KEY); }

    async function tryApplyPending(){
      const p=loadPending(); if(!p || !p.amount || p.uid!==UID) return;
      try{
        await applyProfitTx(p.amount, p.sessionId);
        clearPending();
      }catch(e){ console.warn('apply pending failed, will retry', e.message); }
    }
    window.addEventListener('online', tryApplyPending);

    /* ✅ الربح حسب العقد المقفل: كل 50$ ⇒ (2..4)$ */
    function profitRangeForLocked(locked){
      const cap = Math.min(100000, Math.max(0, Number(locked)||0));
      const chunks = Math.floor(cap/50);
      if(chunks<=0) return {min:0,max:0};
      return {min:2*chunks, max:4*chunks};
    }
    function randomBetween(min,max,seed){
      let s=seed>>>0;
      s = (s*1664525 + 1013904223)>>>0;
      const r = s/4294967296;
      return min + (max-min)*r;
    }

    async function startTrading(){
      const snap = await TREF.get();
      const cur = snap.val();
      if(cur && cur.startAt && (Date.now() - cur.startAt) < (cur.durationMs||DURATION_MS)){
        toast('جلسة قيد التشغيل'); return;
      }
      if (WAL.balance < MIN_BALANCE) {
        toast(`الحد الأدنى للرصيد ${MIN_BALANCE} USD`);
        return;
      }

      const startAt = Date.now();
      const seed = (UID.length*2654435761 ^ startAt) >>> 0;
      const state = {
        startAt, durationMs:DURATION_MS, seed,
        startBalance: WAL.balance,          /* يبقى كما هو */
        startLocked:  WAL.locked,           /* ← نخزن قيمة العقد المقفل عند البدء */
        status:'running',
        profit:0, profitApplied:false
      };
      await TREF.set(state);
      toast('تم بدء جلسة 24 ساعة');
      syncUI(state);
    }

    async function finalizeIfNeeded(state){
      if(!state || state.status!=='running') return;
      const elapsed = Date.now() - state.startAt;
      if(elapsed < (state.durationMs||DURATION_MS)) return;

      /* ✅ استخدم startLocked لحساب هامش الربح */
      const {min,max} = profitRangeForLocked(state.startLocked||0);
      const profit = Number(randomBetween(min, max, state.seed)).toFixed(2)*1;

      await TREF.transaction(cur=>{
        if(!cur || cur.status!=='running') return cur;
        return {...cur, status:'done', endAt:Date.now(), profit, profitApplied:false};
      });

      try{
        await applyProfitTx(profit, String(state.startAt));
      }catch(e){
        savePending({uid:UID, amount:profit, sessionId:String(state.startAt)});
      }
    }

    function applyProfitTx(amount, sessionId){
      return new Promise(async (resolve,reject)=>{
        try{
          await db.ref('users/'+UID).transaction(cur=>{
            if(!cur) return cur;
            const bal = Number(cur.balance||0);
            return {...cur, balance: +(bal + Number(amount)).toFixed(2)};
          });
          await TREF.update({ profitApplied:true, appliedAt: Date.now(), appliedSession: sessionId||null });

          const txId = 'trade_'+(sessionId||Date.now());
          await db.ref('transfers/'+txId).set({
            type:'trade_profit', uid:UID, amount:Number(amount),
            at:new Date().toISOString()
          });

          /* تقرير */
          const stSnap = await TREF.get();
          const st = stSnap.val() || {};
          const report = {
            uid: UID,
            type: 'trade_profit',
            pair: 'XAUUSD',
            amount: Number(amount),
            startAt: st.startAt || null,
            endAt: st.endAt || Date.now(),
            durationMs: st.durationMs || DURATION_MS,
            appliedAt: Date.now(),
            sessionId: sessionId || null
          };
          await db.ref('reports/'+UID+'/'+txId).set(report);

          resolve();
        }catch(e){ reject(e); }
      });
    }

    TREF.on('value', async (s)=>{
      const st=s.val();
      syncUI(st);
      tryApplyPending();
      finalizeIfNeeded(st);
    });

    /* ===== الرسم البياني ===== */
    const canvas = $('#candle'); const ctx = canvas.getContext('2d');
    let chart = { candles:[], zoom:1.0, widthFactor:0.6 };

    function hashInt(x){ x=(x|0)>>>0; x^=x<<13; x^=x>>>17; x^=x<<5; return x>>>0; }
    function seededRand(seed){ let s=seed>>>0; return ()=>{ s = (s*1664525 + 1013904223)>>>0; return s/4294967296; } }

    function genCandlesFor(state){
      if(!state || !state.startAt) return [];
      const steps = clamp(Math.floor((Date.now() - state.startAt)/STEP_MS), 0, TOTAL_STEPS);
      const seed = hashInt(state.seed||1);
      const rnd = seededRand(seed);
      let price = 2100 + rnd()*50;
      const list=[];
      for(let i=0;i<steps;i++){
        const o = price;
        const drift = (rnd() - 0.49) * (o*0.004);
        let c = Math.max(1, o + drift);
        let h = Math.max(o,c) + rnd()*(o*0.003);
        let l = Math.min(o,c) - rnd()*(o*0.003);
        list.push({t: state.startAt + i*STEP_MS, o, h, l, c});
        price = c;
      }
      return list.length ? list : [{t:state.startAt, o:price, h:price, l:price, c:price}];
    }

    function resizeCanvas(){
      const pr = Math.max(1, window.devicePixelRatio||1);
      const rect = canvas.getBoundingClientRect();
      const cw = Math.max(320, rect.width||520), ch = Math.max(220, rect.height||320);
      canvas.width = Math.floor(cw*pr); canvas.height = Math.floor(ch*pr);
      ctx.setTransform(pr,0,0,pr,0,0);
      draw();
    }
    window.addEventListener('resize', resizeCanvas);
    document.addEventListener('fullscreenchange', resizeCanvas);

    function drawLine(xs, ys, color, pad, minP, maxP, H){
      const [padL,padT,padR,padB]=pad; const vh = H - padT - padB; const range = (maxP-minP)||1;
      const yOf = p => padT + vh - ((p-minP)/range)*vh;
      ctx.strokeStyle=color; ctx.lineWidth=1.6; ctx.beginPath(); let start=true;
      ys.forEach((v,i)=>{ if(v==null||isNaN(v)){start=true;return;} const y=yOf(v); if(start){ctx.moveTo(xs[i],y);start=false;} else ctx.lineTo(xs[i],y); });
      ctx.stroke();
    }

    function draw(){
      const W = canvas.clientWidth, H = canvas.clientHeight;
      ctx.clearRect(0,0,W,H);
      if(!chart.candles.length) return;

      const pad=[40,10,16,20]; const vw=W-pad[0]-pad[2], vh=H-pad[1]-pad[3];
      const N = Math.max(10, Math.floor(chart.candles.length/(chart.zoom||1)));
      const data = chart.candles.slice(-N);
      const xStep = vw/data.length; const bodyW = Math.max(3, xStep*chart.widthFactor);
      const maxP=Math.max(...data.map(d=>d.h)), minP=Math.min(...data.map(d=>d.l)), range=maxP-minP||1;
      const yOf = p => pad[1] + vh - ((p-minP)/range)*vh;

      ctx.strokeStyle='#eaecef'; ctx.lineWidth=1; for(let i=0;i<=4;i++){ const y=pad[1]+vh*i/4; ctx.beginPath(); ctx.moveTo(pad[0],y); ctx.lineTo(pad[0]+vw,y); ctx.stroke(); }

      const xs=[], closes=[];
      data.forEach((d,i)=>{
        const x = pad[0] + i*xStep + xStep/2; xs.push(x); closes.push(d.c);
        const up = d.c>=d.o; const col = up?'#16a34a':'#ef4444';
        ctx.strokeStyle=col; ctx.beginPath(); ctx.moveTo(x,yOf(d.h)); ctx.lineTo(x,yOf(d.l)); ctx.stroke();
        ctx.fillStyle=col; const yO=yOf(d.o), yC=yOf(d.c); const top=Math.min(yO,yC); const h=Math.max(2, Math.abs(yO-yC));
        ctx.fillRect(x-bodyW/2, top, bodyW, h);
      });

      const last=data[data.length-1]; const yLast=yOf(last.c);
      ctx.strokeStyle='rgba(243,101,35,.6)'; ctx.setLineDash([6,4]); ctx.beginPath(); ctx.moveTo(pad[0],yLast); ctx.lineTo(pad[0]+vw,yLast); ctx.stroke(); ctx.setLineDash([]);
      ctx.fillStyle='#64748b'; ctx.font='12px Cairo, sans-serif';
      ctx.fillText(maxP.toFixed(2), 4, pad[1]+10); ctx.fillText(minP.toFixed(2), 4, pad[1]+vh); ctx.fillText(last.c.toFixed(2), 4, yLast+4);

      const SMA = (arr,p)=>arr.map((_,i)=> i+1<p?null:(arr.slice(i-p+1,i+1).reduce((a,b)=>a+b,0)/p));
      drawLine(xs, SMA(closes, 20), '#0ea5e9', [40,10,16,20], Math.min(...data.map(d=>d.l)), Math.max(...data.map(d=>d.h)), H);
    }

    function renderSummary(){
      const d=chart.candles; if(!d.length) return;
      const o=d[0].o, c=d[d.length-1].c, hi=Math.max(...d.map(x=>x.h)), lo=Math.min(...d.map(x=>x.l));
      const chg=((c-o)/o)*100;
      $('#priceNow').textContent=c.toFixed(2)+' USD';
      $('#chg24').textContent=(chg>=0?'+':'')+chg.toFixed(2)+'%';
      $('#chg24').className='chg '+(chg>=0?'up':'down');
      $('#hi').textContent=hi.toFixed(2); $('#lo').textContent=lo.toFixed(2);
      $('#miniVal').textContent=c.toFixed(2)+' USD';
      $('#miniChg').textContent=(chg>=0?'+':'')+chg.toFixed(2)+'%';
      $('#miniChg').className='ghost '+(chg>=0?'chg up':'chg down');
    }

    function updateChartFromState(state){
      chart.candles = genCandlesFor(state);
      resizeCanvas(); renderSummary();
      const elapsed = state? (Date.now()-state.startAt):0;
      const prog = clamp(elapsed/(state?.durationMs||DURATION_MS),0,1);
      $('#progBar').style.width = (prog*100).toFixed(1)+'%';
    }

    let tickTimer=null;
    function syncUI(state){
      const btn=$('#startBtn');
      if(!state){
        btn.disabled=false;
        i18nSet(btn,
          '<span class="ms"></span> بدء التداول 24h',
          '<span class="ms">play_arrow</span> Start 24h trading'
        );
        i18nSet($('#simNote'),
          'لا توجد جلسة نشطة.',
          'No active session.'
        );
        chart.candles=[]; resizeCanvas(); return;
      }
      updateChartFromState(state);

      const elapsed = Date.now()-state.startAt;
      const left = (state.durationMs||DURATION_MS) - elapsed;

      if(state.status==='running' && left>0){
        btn.disabled=true;
        i18nSet(btn,
          '<span class="ms">pause</span> جاري التداول…',
          '<span class="ms">pause</span> Trading…'
        );
        i18nSet($('#simNote'),
          'جلسة نشطة – ينتهي بعد: ~'+Math.ceil(left/3600000)+'h',
          'Active session – ends in: ~'+Math.ceil(left/3600000)+'h'
        );
        if(!tickTimer){
          tickTimer=setInterval(()=>{ updateChartFromState(state); }, 1000*20);
        }
      }else{
        btn.disabled = (state.startAt && (Date.now()-state.startAt)<(state.durationMs||DURATION_MS));
        if(btn.disabled){
          i18nSet(btn,
            '<span class="ms">hourglass_bottom</span> بانتظار انتهاء 24h',
            '<span class="ms">hourglass_bottom</span> Waiting for 24h to finish'
          );
        }else{
          i18nSet(btn,
            '<span class="ms">play_arrow</span> بدء التداول 24h',
            '<span class="ms">play_arrow</span> Start 24h trading'
          );
        }

        const profitAr = 'الجلسة اكتملت. ربح: ' + (Number(state.profit||0)).toFixed(2) + ' USD' + (state.profitApplied?' (مضاف إلى الرصيد)':' (بانتظار الإضافة)');
        const profitEn = 'Session completed. Profit: ' + (Number(state.profit||0)).toFixed(2) + ' USD' + (state.profitApplied?' (added to balance)':' (pending addition)');
        i18nSet($('#simNote'),
          state.status==='done' ? profitAr : 'لا توجد جلسة نشطة.',
          state.status==='done' ? profitEn : 'No active session.'
        );
        if(tickTimer){ clearInterval(tickTimer); tickTimer=null; }
      }

      const pend = loadPending(); const pendAmt = (pend && pend.uid===UID) ? Number(pend.amount||0) : 0;
      const shown = Number(state?.profit||0) + pendAmt;
      $('#profitVal').textContent = fmtUSD(shown);
    }

    // Events
    on('#startBtn','click', startTrading);
    on('#refreshBtn','click', async()=>{ const s=(await TREF.get()).val(); syncUI(s); toast('تم التحديث'); });
    on('#zoomIn','click', ()=>{ chart.zoom=clamp((chart.zoom||1)+0.1,0.5,2.0); draw(); $('#zoomRange').value=chart.zoom.toFixed(2); });
    on('#zoomOut','click',()=>{ chart.zoom=clamp((chart.zoom||1)-0.1,0.5,2.0); draw(); $('#zoomRange').value=chart.zoom.toFixed(2); });
    on('#resetZoom','click',()=>{ chart.zoom=1.0; draw(); $('#zoomRange').value='1'; });

    // Options panel
    const optPanel=$('#optPanel'), optBack=$('#optBack');
    on('#optBtn','click', ()=>{ optPanel.classList.add('active'); optBack.classList.add('active'); });
    on('#optClose','click', ()=>{ optPanel.classList.remove('active'); optBack.classList.remove('active'); });
    on('#optBack','click', ()=>{ optPanel.classList.remove('active'); optBack.classList.remove('active'); });
    on('#optApply','click', ()=>{ optPanel.classList.remove('active'); optBack.classList.remove('active'); });

    // Fullscreen
    const card=$('#chartCard');
    on('#fullBtn','click', ()=>{ if(!document.fullscreenElement){ (card.requestFullscreen||card.webkitRequestFullscreen||Function.prototype).call(card); } else { (document.exitFullscreen||document.webkitExitFullscreen||Function.prototype).call(document); } });

    // Header
    on('#backBtn','click', ()=>{ if(history.length>1) history.back(); else window.location.replace('index1.html'); });
    on('#supportBtn','click', ()=> window.open('https://t.me/artikarbot','_blank'));

    // Lang sheet
    const langSheet=$('#langSheet'), langBack=$('#sheetBack');
    on('#langBtn','click', ()=>{ langSheet.classList.add('active'); langBack.classList.add('active'); });
    on('#sheetBack','click', ()=>{ langSheet.classList.remove('active'); langBack.classList.remove('active'); });
    $$('#langSheet [data-setlang]').forEach(b=>b.addEventListener('click', async ()=>{
      const l=b.dataset.setlang; localStorage.setItem('lang',l);
      if(typeof window.applyLang==='function'){ window.applyLang(l); }
      document.documentElement.lang=l; document.documentElement.dir=(l==='ar'?'rtl':'ltr');
      try{ const s=(await TREF.get()).val(); syncUI(s); }catch(_){}
      langBack.click();
    }));

    // === أرباح سابقة: فتح/إغلاق الشيت + الجلب من القاعدة ===
    const histBtn = $('#histBtn'), histBack = $('#histBack'), histSheet = $('#histSheet');
    const histClose = $('#histClose'), histList = $('#histList'), histTotal=$('#histTotal');

    function openHist(){ histSheet.classList.add('active'); histBack.classList.add('active'); }
    function closeHist(){ histSheet.classList.remove('active'); histBack.classList.remove('active'); }

    on(histBtn, 'click', async ()=>{
      await loadHistory();
      openHist();
    });
    on(histBack, 'click', closeHist);
    on(histClose, 'click', closeHist);

    async function loadHistory(){
      try{
        const snap = await db.ref('reports/'+UID).get();
        let items = [];
        if(snap.exists()){
          const all = snap.val()||{};
          items = Object.keys(all).map(k=>({id:k, ...all[k]}))
                    .filter(x=>String(x.type)==='trade_profit')
                    .sort((a,b)=> Number((b.appliedAt||b.endAt||0)) - Number((a.appliedAt||a.endAt||0)));
        }
        renderHistory(items);
      }catch(e){
        console.error(e);
        renderHistory([]);
        toast('تعذّر تحميل السجل');
      }
    }

    function renderHistory(items){
      histList.innerHTML='';
      if(!items.length){
        const d=document.createElement('div');
        d.className='hist-empty';
        d.textContent='لا توجد أرباح محفوظة بعد.';
        histList.appendChild(d);
        histTotal.textContent='الإجمالي: 0.00 USD';
        return;
      }
      let total=0;
      items.forEach(it=>{
        const wrap=document.createElement('div');
        wrap.className='hist-item';
        const dt = it.appliedAt ? new Date(it.appliedAt) : (it.endAt ? new Date(it.endAt) : null);
        const dateTxt = dt
  ? dt.toLocaleString('en-US', {
      year:'numeric', month:'short', day:'2-digit',
      hour:'2-digit', minute:'2-digit', hour12:false,
      numberingSystem:'latn'
    })
  : '—';
        const amt = Number(it.amount||0);
        total += amt;
        wrap.innerHTML = `
          <div>
            <div class="amt" style="color:var(--success)">+ ${fmtUSD(amt)}</div>
            <div class="ghost" style="font-size:12px">${dateTxt}</div>
          </div>
          <div class="ghost" style="display:flex;align-items:center;gap:6px"><span class="ms">playlist_add_check</span> ربح جلسة</div>
        `;
        histList.appendChild(wrap);
      });
      histTotal.textContent = 'الإجمالي: ' + fmtUSD(total);
    }

    // Initial
    function firstPaint(){ resizeCanvas(); }
    firstPaint();

    (async function init(){
      const s=(await TREF.get()).val();
      syncUI(s);
      tryApplyPending();
      finalizeIfNeeded(s);
    })();

  })();
  </script>
  
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(reg => console.log("✔ Service Worker registered"))
        .catch(err => console.error("❌ Service Worker failed:", err));
    }
  </script>
  

  
  
</body>
</html>