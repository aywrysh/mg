<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --gray:#C7C7C7; --accent:#F36523; --danger:#ef4444;
      --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --top:54px; --top-icon:#1E3A8A; --shadow:0 8px 16px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff;min-height:100dvh;overflow-x:hidden}

    .appbar{position:fixed;top:0;inset-inline:0;height:var(--top);z-index:40;background:var(--gray);
      display:flex;align-items:center;justify-content:space-between;padding:4px 10px;box-shadow:0 1px 0 #bfbfbf}
    .accent-line{height:3px;background:var(--accent)}
    .btn{width:40px;height:40px;border-radius:12px;background:#fff;border:1px solid #d3d3d3;display:grid;place-items:center;cursor:pointer;color:var(--top-icon);position:relative;overflow:hidden}
    .btn.orange{color:var(--accent)}
    .ms{font-family:'Material Symbols Rounded';font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24;line-height:1}

    .page{width:min(520px,92vw);margin:0 auto;padding:14px 10px 84px; padding-top:calc(var(--top) + 16px);}
    h1{margin:6px 0 12px;font-size:20px}

    .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    .warn{background:#fff7f7;border:1px solid #ffd1d1;color:#7f1d1d;padding:10px;border-radius:12px}
    .field{display:flex;gap:8px;align-items:center}
    .input{flex:1;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fafafa;font-weight:800}
    .input.error{border-color:#ef4444;background:#fff1f1}

    .check{display:flex;align-items:center;gap:8px}
    .check input{width:18px;height:18px}

    .btn-solid{padding:11px 12px;border-radius:12px;border:1px solid var(--line);font-weight:800;cursor:pointer;background:#fff}
    .btn-solid.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn-solid.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn-solid[disabled]{opacity:.6;cursor:not-allowed}

    .toast{position:fixed;bottom:78px;left:50%;transform:translateX(-50%) scale(.96);background:rgba(17,17,17,.92);color:#fff;
      padding:8px 12px;border-radius:10px;font-weight:800;font-size:12px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:70}
    .toast.show{opacity:1;transform:translateX(-50%) scale(1)}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(0,0,0,.18);animation:ripple .6s linear;pointer-events:none}
    @keyframes ripple{to{transform:scale(3);opacity:0}}

    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;visibility:hidden;pointer-events:none;transition:.25s;z-index:60}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -10px 28px rgba(0,0,0,.2);
      transform:translateY(100%);transition:.3s;z-index:61;padding:14px;border:1px solid #ececec;max-width:520px;margin:0 auto}
    .sheet.active{transform:translateY(0)}
    .sheet-backdrop.active{opacity:1;visibility:visible;pointer-events:auto}
    .grab{width:40px;height:4px;border-radius:3px;background:#e5e7eb;margin:4px auto 12px}
  </style>
  
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e5e7eb">


<link rel="icon" type="image/png" sizes="32x32" href="32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="16x16.png">
<link rel="shortcut icon" href="/favicon.ico">

<!-- iOS -->
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">

<!-- Android / PWA -->
<link rel="manifest" href="/site.webmanifest">

<!-- Safari pinned tab (اختياري) -->
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#e5e7eb">

<!-- ألوان النظام (اختياري) -->

<meta name="msapplication-TileColor" content="#e5e7eb">
  
  
  <!-- تحسين تحميل خط الأيقونات + منع وميضه وإخفاء الصفحة مؤقتًا -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
      onload="this.rel='stylesheet'">
<noscript>
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0">
</noscript>

<style>
  /* إخفاء الأيقونات مؤقتًا + إخفاء الصفحة لحين الجاهزية */
  html.icons-wait .ms,
  html.icons-wait .mi { visibility: hidden; }
  html.app-wait body { visibility: hidden; }
</style>
  
  
</head>
<body>

  <header class="appbar">
    <button class="btn orange" id="backBtn" title="خروج"><span class="ms">arrow_back_ios_new</span></button>
    <div class="row">
      <button class="btn" id="supportBtn" title="خدمة العملاء"><span class="ms">headset_mic</span></button>
      <button class="btn orange" disabled title="حذف الحساب"><span class="ms">delete_forever</span></button>
    </div>
  </header>
  <div class="accent-line"></div>

  <main class="page">
    <h1>حذف الحساب</h1>

    <div class="card" style="margin-bottom:12px">
      <div class="warn">
        <div class="row" style="gap:8px"><span class="ms">warning</span><b>تحذير هام</b></div>
        <ul style="margin:8px 0 0 0;padding:0 18px">
          <li class="hint">سيتم حذف بيانات حسابك من القاعدة نهائيًا.</li>
          <li class="hint">لا يمكن التراجع بعد التنفيذ.</li>
        </ul>
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:6px"><span class="ms">lock</span><b>أدخل كلمة المرور للتأكيد</b></div>
      <div class="field" style="margin-top:10px">
        <input id="pwd" class="input" type="password" placeholder="••••••••" aria-label="كلمة المرور">
        <button class="btn" id="togglePwd" title="إظهار"><span class="ms">visibility</span></button>
      </div>
      <div class="check" style="margin-top:10px">
        <input id="agree" type="checkbox">
        <label for="agree" class="hint">أفهم أن عملية الحذف نهائية.</label>
      </div>
    </div>

    <div class="row" style="gap:10px;margin-top:12px">
      <button class="btn-solid" id="cancelBtn" style="flex:1">إلغاء</button>
      <button class="btn-solid danger" id="deleteBtn" style="flex:1" disabled>حذف نهائي</button>
    </div>
  </main>

  <!-- شيت تأكيد -->
  <div class="sheet-backdrop" id="sheetBack"></div>
  <div class="sheet" id="confirmSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>
    <h3 style="text-align:center;margin:6px 0 10px">تأكيد الحذف؟</h3>
    <div class="row" style="gap:10px">
      <button class="btn-solid" id="noBtn" style="flex:1">لا</button>
      <button class="btn-solid danger" id="yesBtn" style="flex:1">نعم، احذف</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script src="i18n.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
    function ripple(ev){const t=ev.currentTarget||ev.target.closest('.btn,.btn-solid'); if(!t) return; const r=document.createElement('span'); const d=Math.max(t.clientWidth,t.clientHeight); const rect=t.getBoundingClientRect(); r.className='ripple'; r.style.width=r.style.height=d+'px'; r.style.left=(ev.clientX-rect.left-d/2)+'px'; r.style.top=(ev.clientY-rect.top-d/2)+'px'; const old=t.querySelector('.ripple'); if(old) old.remove(); t.appendChild(r); setTimeout(()=>r.remove(),600);}
    document.addEventListener('click',e=>{ if(e.target.closest('.btn, .btn-solid')) ripple(e); });
    function toast(msg){const t=$("#toast"); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1300);}

    // تنقل
    $('#backBtn').addEventListener('click', ()=> window.location.replace('index1.html#account'));
    $('#cancelBtn').addEventListener('click', ()=> window.location.replace('index1.html#account'));
    $('#supportBtn').addEventListener('click', ()=> window.open('https://t.me/artikarbot','_blank'));

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // جلسة المستخدم
    const session = (function(){ try{ return JSON.parse(localStorage.getItem('dynex_session')||'null'); }catch(_){ return null; }})();
    if(!session || !session.uid){
      toast('الرجاء تسجيل الدخول');
      setTimeout(()=> window.location.replace('index.html'), 900);
      return;
    }
    const uid = session.uid;

    // عناصر
    const pwd=$("#pwd"), agree=$("#agree"), del=$("#deleteBtn");
    const back=$("#sheetBack"), sheet=$("#confirmSheet");

    function openSheet(){ sheet.classList.add('active'); back.classList.add('active'); }
    function closeSheet(){ sheet.classList.remove('active'); back.classList.remove('active'); }
    back.addEventListener('click', closeSheet);
    $('#noBtn').addEventListener('click', closeSheet);

    // إظهار/إخفاء الباس
    $('#togglePwd').addEventListener('click', ()=>{
      const vis = pwd.type==='text';
      pwd.type = vis ? 'password' : 'text';
      $('#togglePwd').setAttribute('aria-pressed', (!vis).toString());
      $('#togglePwd').title = vis ? 'إظهار' : 'إخفاء';
    });

    // تفعيل الزر بمجرد الموافقة (التحقق سيتم عند الضغط)
    function setDelState(){ del.disabled = !agree.checked; }
    agree.addEventListener('change', setDelState);
    pwd.addEventListener('input', ()=> pwd.classList.remove('error'));
    setDelState();

    // يجلب كلمة المرور الحقيقية من القاعدة
    async function getPasswordFromDB(){
      try{
        const s1 = await db.ref('users/'+uid+'/password').get();
        if(s1.exists()) return String(s1.val());
      }catch(_){}
      try{
        const s2 = await db.ref('p2pAccounts/'+uid+'/password').get();
        if(s2.exists()) return String(s2.val());
      }catch(_){}
      return null;
    }

    // معلومات المستخدم (لاسم المستخدم لتفريغ الخرائط)
    async function getProfile(){
      let u = {};
      try{
        const a = await db.ref('p2pAccounts/'+uid).get();
        if(a.exists()) u = a.val()||{};
      }catch(_){}
      if(!u.username || !u.name){
        try{
          const b = await db.ref('users/'+uid).get();
          if(b.exists()){
            const v = b.val()||{};
            u.username = u.username || v.username;
            u.name     = u.name     || v.name;
          }
        }catch(_){}
      }
      return { username: u.username || session.username || null, name: u.name || session.name || null };
    }

    // عند الضغط: تحقّق كلمة السر ثم افتح الشيت
    $('#deleteBtn').addEventListener('click', async ()=>{
      if(!agree.checked){ toast('رجاءً وافق على التحذير'); return; }
      const typed = (pwd.value||'').trim();
      if(!typed){ pwd.classList.add('error'); toast('أدخل كلمة المرور'); return; }

      const real = await getPasswordFromDB();
      if(!real){ toast('تعذّر التحقق من القاعدة'); return; }
      if(typed !== real){ pwd.classList.add('error'); toast('كلمة المرور غير صحيحة'); return; }

      openSheet();
    });

    // حذف شامل متعدد المواقع
    async function doDelete(){
      // اجمع المفاتيح المراد حذفها
      const prof = await getProfile();

      // احذف جميع اعتراضات المستخدم (appeals) أولاً
      const updates = {};
      try{
        const apSnap = await db.ref('appeals').orderByChild('uid').equalTo(uid).get();
        if(apSnap.exists()){
          const obj = apSnap.val() || {};
          Object.keys(obj).forEach(k => { updates['appeals/'+k] = null; });
        }
      }catch(_){}

      // مسارات الحساب
      updates['users/'+uid] = null;
      updates['p2pAccounts/'+uid] = null;

      // خرائط الأسماء إن وُجدت
      if(prof.username){
        updates['usernames/'+prof.username] = null;
        updates['p2pUsernames/'+prof.username] = null;
      }

      // نفّذ الحذف دفعة واحدة
      await db.ref().update(updates);
    }

    // نعم، احذف
    $('#yesBtn').addEventListener('click', async ()=>{
      $('#yesBtn').disabled = true;
      $('#noBtn').disabled = true;

      try{
        await doDelete();

        // نظّف الجهاز
        try{
          localStorage.removeItem('dynex_session');
          localStorage.removeItem('last_username');
          localStorage.removeItem('acct_name');
          localStorage.removeItem('acct_phone');
          localStorage.removeItem('acct_pass');
        }catch(_){}

        closeSheet();
        toast('تم الحذف');
        setTimeout(()=> window.location.replace('index.html'), 800);
      }catch(e){
        console.error(e);
        closeSheet();
        toast('تعذّر الحذف من القاعدة');
        $('#yesBtn').disabled = false;
        $('#noBtn').disabled = false;
      }
    });
  })();
  </script>
  
    <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
</script>
  
  
  <script>
  // عند نهاية تهيئة الصفحة/الخطوط: أظهر الصفحة
  if (window.__fontsReady) {
    window.__fontsReady.finally(function(){
      document.documentElement.classList.remove('app-wait');
    });
  } else {
    document.documentElement.classList.remove('app-wait');
  }
</script>
  
  
</body>
</html>