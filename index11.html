<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex – اعتراض</title>

  <!-- خطوط وأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --gray:#C7C7C7; --accent:#F36523;
      --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --top:54px; --radius:14px; --top-icon:#1E3A8A;
      --surface:#f7f8fa; --shadow:0 8px 16px rgba(0,0,0,.06);
      --success:#16a34a; --danger:#ef4444;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff;min-height:100dvh;overflow-x:hidden}

    /* Appbar */
    .appbar{position:fixed;top:0;inset-inline:0;height:var(--top);z-index:40;background:var(--gray);
      display:flex;align-items:center;justify-content:space-between;padding:4px 10px;box-shadow:0 1px 0 #bfbfbf}
    .accent-line{height:3px;background:var(--accent)}
    .btn{width:40px;height:40px;border-radius:12px;background:#fff;border:1px solid #d3d3d3;display:grid;place-items:center;cursor:pointer;color:var(--top-icon);position:relative;overflow:hidden}
    .btn.orange{color:var(--accent)}
    .ms{font-family:'Material Symbols Rounded';font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24;line-height:1}

    /* Page */
    .page{width:min(520px,92vw);margin:0 auto;padding:14px 10px 84px; padding-top:calc(var(--top) + 16px);}
    h1{margin:6px 0 12px;font-size:20px}

    /* Cards & inputs */
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
    .group{display:grid;gap:10px}
    .label{font-weight:900;font-size:13px}
    .hint{font-size:12px;color:var(--muted)}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .input, select, textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fafafa;font-weight:800;font-family:inherit}
    .input[dir="ltr"]{direction:ltr}
    .input.readonly{background:#f3f4f6;color:#6b7280}
    .error{border-color:#ef4444 !important;background:#fff1f1 !important}
    textarea{min-height:120px;resize:vertical}

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:#fff;font-weight:800;cursor:pointer}
    .chip:active{transform:scale(.98)}

    .btn-solid{padding:11px 12px;border-radius:12px;border:1px solid var(--line);font-weight:800;cursor:pointer;background:#fff}
    .btn-solid.primary{background:var(--accent);border-color:var(--accent);color:#fff}

    /* Toast + ripple */
    .toast{position:fixed;bottom:78px;left:50%;transform:translateX(-50%) scale(.96);background:rgba(17,17,17,.92);color:#fff;
      padding:8px 12px;border-radius:10px;font-weight:800;font-size:12px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:70}
    .toast.show{opacity:1;transform:translateX(-50%) scale(1)}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(0,0,0,.18);animation:ripple .6s linear;pointer-events:none}
    @keyframes ripple{to{transform:scale(3);opacity:0}}

    /* Language sheet */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;visibility:hidden;pointer-events:none;transition:.25s;z-index:60}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -10px 28px rgba(0,0,0,.2);
      transform:translateY(100%);transition:.3s;z-index:61;padding:14px;border:1px solid #ececec;max-width:520px;margin:0 auto}
    .sheet.active{transform:translateY(0)}
    .sheet-backdrop.active{opacity:1;visibility:visible;pointer-events:auto}
    .grab{width:40px;height:4px;border-radius:3px;background:#e5e7eb;margin:4px auto 12px}
    .sheet .langs{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .sheet .langs button{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:800}
  </style>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f97316">
</head>
<body>

  <!-- Appbar -->
  <header class="appbar">
    <button class="btn orange" id="backBtn" title="خروج"><span class="ms">arrow_back_ios_new</span></button>
    <div class="row">
      <button class="btn" id="supportBtn" title="خدمة العملاء"><span class="ms">headset_mic</span></button>
      <button class="btn orange" id="langBtn" title="تغيير اللغة" style="font-weight:800">؏</button>
    </div>
  </header>
  <div class="accent-line"></div>

  <main class="page">
    <h1>اعتراض</h1>

    <!-- بيانات أساسية (تُجلب تلقائياً) -->
    <div class="card" style="margin-bottom:12px">
      <div class="group">
        <div>
          <div class="label">الاسم الكامل</div>
          <input id="nameInput" class="input readonly" type="text" maxlength="60" placeholder="اسم المستخدم" aria-label="الاسم" readonly>
        </div>

        <div>
          <div class="label">رقم الهاتف</div>
          <input id="phoneInput" class="input readonly" type="tel" inputmode="tel" dir="ltr" placeholder="+967 7XXXXXXXX" aria-label="رقم الهاتف" readonly>
          <div class="hint">يتم جلب الاسم والرقم من حسابك تلقائياً.</div>
        </div>
      </div>
    </div>

    <!-- نوع الاعتراض -->
    <div class="card" style="margin-bottom:12px">
      <div class="group">
        <div>
          <div class="label">نوع الاعتراض</div>
          <select id="typeSelect">
            <option value="withdraw">مشكلة سحب</option>
            <option value="deposit">مشكلة إيداع</option>
            <option value="balance">خطأ في الرصيد</option>
            <option value="freeze">النظام يعلق</option>
            <option value="change">طلب تغيير رقم</option>
            <option value="other">غير ذلك</option>
          </select>
          <div class="hint">يمكنك أيضاً استخدام الاختصارات أدناه.</div>
        </div>

        <div class="chips">
          <button class="chip" data-txt="تعليق النظام">تعليق النظام</button>
          <button class="chip" data-txt="مشكلة سحب">مشكلة سحب</button>
          <button class="chip" data-txt="مشكلة إيداع">مشكلة إيداع</button>
          <button class="chip" data-txt="خطأ في الرصيد">خطأ في الرصيد</button>
          <button class="chip" data-txt="تغيير رقم">تغيير رقم</button>
          <button class="chip" data-txt="موضوع آخر">موضوع آخر</button>
        </div>
      </div>
    </div>

    <!-- نص الاعتراض -->
    <div class="card">
      <div class="group">
        <div class="label">تفاصيل الاعتراض (اختياري)</div>
        <textarea id="bodyInput" placeholder="Write …"></textarea>
        <div class="hint" id="bodyHint">* إذا اخترت “غير ذلك” يجب كتابة التفاصيل.</div>
      </div>
    </div>

    <!-- أزرار -->
    <div class="row" style="gap:10px; margin-top:12px">
      <button class="btn-solid" id="cancelBtn" style="flex:1">إلغاء</button>
      <button class="btn-solid primary" id="sendBtn" style="flex:1">إرسال</button>
    </div>
  </main>

  <!-- شيت اللغة -->
  <div class="sheet-backdrop" id="sheetBack"></div>
  <div class="sheet" id="langSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>
    <div class="langs">
      <button class="btn-solid" data-setlang="ar">العربية</button>
      <button class="btn-solid" data-setlang="en">English</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ✅ مود الترجمة -->
  <script src="i18n.js"></script>

  <!-- ✅ Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
    function ripple(ev){const t=ev.currentTarget||ev.target.closest('.btn,.btn-solid,.chip'); if(!t) return; const r=document.createElement('span'); const d=Math.max(t.clientWidth,t.clientHeight); const rect=t.getBoundingClientRect(); r.className='ripple'; r.style.width=r.style.height=d+'px'; r.style.left=(ev.clientX-rect.left-d/2)+'px'; r.style.top=(ev.clientY-rect.top-d/2)+'px'; const old=t.querySelector('.ripple'); if(old) old.remove(); t.appendChild(r); setTimeout(()=>r.remove(),600);}
    document.addEventListener('click',e=>{ if(e.target.closest('.btn, .btn-solid, .chip')) ripple(e); });
    function toast(msg){const t=$("#toast"); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1400);}
    window.toast = toast; /* ←<<< هذا السطر يربط التوست مع i18n */

    // تنقل/لغة
    $("#backBtn").addEventListener('click', ()=>{ window.location.replace('index1.html#account'); });
    $("#supportBtn").addEventListener('click', ()=> window.open('https://t.me/artikarbot','_blank'));
    const langSheet=$("#langSheet"), back=$("#sheetBack");
    $("#langBtn").addEventListener('click', ()=>{ langSheet.classList.add('active'); back.classList.add('active'); });
    back.addEventListener('click', ()=>{ langSheet.classList.remove('active'); back.classList.remove('active'); });
    $$('#langSheet [data-setlang]').forEach(b=>b.addEventListener('click', ()=>{
      const l=b.dataset.setlang; localStorage.setItem('lang', l);
      if(typeof window.applyLang==='function') window.applyLang(l); else { document.documentElement.lang=l; document.documentElement.dir=(l==='ar')?'rtl':'ltr'; }
      back.click();
    }));

    // عناصر
    const nameInput=$("#nameInput");
    const phoneInput=$("#phoneInput");
    const typeSelect=$("#typeSelect");
    const bodyInput=$("#bodyInput");

    $$('.chip').forEach(c=>c.addEventListener('click', ()=>{
      const t=c.dataset.txt || c.textContent || '';
      if(!t) return;
      if(/Other|آخر/i.test(t)) typeSelect.value='other';
      if(!bodyInput.value) bodyInput.value=t; else bodyInput.value += (bodyInput.value.endsWith('\n')?'':'\n') + t;
      bodyInput.focus();
    }));

    // Firebase init (مع حارس)
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // جلسة المستخدم
    const session = (function(){ try{ return JSON.parse(localStorage.getItem('dynex_session')||'null'); }catch(_){ return null; }})();
    if(!session || !session.uid){
      toast('الرجاء تسجيل الدخول');
      setTimeout(()=> window.location.replace('index.html'), 800);
      return;
    }

    /* ========= جلب الاسم والرقم فوراً + من مسارات متعددة ========= */

    // 0) تعبئة فورية من الجلسة (لو موجود)
    if (session.name)  nameInput.value  = session.name;
    if (session.phone) phoneInput.value = session.phone;

    function fillOnce(el, val){
      if(!val) return;
      if(!el.value || el.value.trim()===''){
        el.value = String(val);
      }
    }

    // 1) مراقبة users/{uid}
    const pathUsers = 'users/'+session.uid;
    db.ref(pathUsers).on('value', s=>{
      const u = s.val()||{};
      fillOnce(nameInput,  u.name || u.username);
      fillOnce(phoneInput, u.phone);
    });

    // 2) مراقبة p2pAccounts/{uid}
    const pathP2P = 'p2pAccounts/'+session.uid;
    db.ref(pathP2P).on('value', s=>{
      const u = s.val()||{};
      fillOnce(nameInput,  u.name || u.username);
      fillOnce(phoneInput, u.phone);
    });

    // 3) استعلام بالـ username لو ما ظهر رقم/اسم
    async function tryLookupByUsername(){
      const uname = session.username || '';
      if(!uname) return;
      try{
        const q1 = await db.ref('users').orderByChild('username').equalTo(uname).get();
        if(q1.exists()){
          const u = Object.values(q1.val()||{})[0] || {};
          fillOnce(nameInput,  u.name || u.username);
          fillOnce(phoneInput, u.phone);
        }
      }catch(_){}
      try{
        const q2 = await db.ref('p2pAccounts').orderByChild('username').equalTo(uname).get();
        if(q2.exists()){
          const u = Object.values(q2.val()||{})[0] || {};
          fillOnce(nameInput,  u.name || u.username);
          fillOnce(phoneInput, u.phone);
        }
      }catch(_){}
    }
    setTimeout(()=>{ if(!nameInput.value || !phoneInput.value) tryLookupByUsername(); }, 2000);

    /* ========= إرسال الاعتراض ========= */

    $("#cancelBtn").addEventListener('click', ()=> window.location.replace('index1.html#account'));

    function validatePhone(v){ return /^\+?[0-9\s\-()]{8,16}$/.test((v||'').trim()); }
    $("#sendBtn").addEventListener('click', async ()=>{
      [nameInput, phoneInput, typeSelect, bodyInput].forEach(i=>i.classList.remove('error'));

      const name=(nameInput.value||'').trim();
      const phone=(phoneInput.value||'').trim();
      const type=typeSelect.value;
      const body=(bodyInput.value||'').trim();

      if(!name){ nameInput.classList.add('error'); nameInput.focus(); return toast('أدخل الاسم'); }
      if(!validatePhone(phone)){ phoneInput.classList.add('error'); phoneInput.focus(); return toast('رقم هاتف غير صالح'); }
      if(type==='other' && !body){ bodyInput.classList.add('error'); bodyInput.focus(); return toast('اكتب تفاصيل الاعتراض'); }

      const nowISO = new Date().toISOString();
      const payload = {
        uid: session.uid,
        name, phone, type,
        body: body || null,
        status: 'pending',
        created_at: nowISO,
        created_ts: firebase.database.ServerValue.TIMESTAMP
      };

      try{
        const ref = db.ref('appeals').push();
        await ref.set(payload);
        await db.ref('users/'+session.uid+'/appeals/'+ref.key).set(true);
        toast('تم إرسال الاعتراض');
        setTimeout(()=> window.location.replace('index1.html#account'), 700);
      }catch(e){
        console.error(e);
        toast('تعذّر الاتصال بالقاعدة');
      }
    });

    /* ===== مفاتيح ترجمة هذه الصفحة فقط ===== */
    if (window.DynexI18N && typeof DynexI18N.addPairs==='function'){
      DynexI18N.addPairs([
        ['Dynex – اعتراض','Dynex – Appeal'],
        ['اعتراض','Appeal'],
        ['خروج','Exit'],
        ['خدمة العملاء','Support'],
        ['تغيير اللغة','Change language'],
        ['الاسم الكامل','Full name'],
        ['اسم المستخدم','Username'],
        ['رقم الهاتف','Phone number'],
        ['يتم جلب الاسم والرقم من حسابك تلقائياً.','Name and phone are fetched from your account automatically.'],
        ['نوع الاعتراض','Appeal type'],
        ['مشكلة سحب','Withdrawal issue'],
        ['مشكلة إيداع','Deposit issue'],
        ['خطأ في الرصيد','Balance error'],
        ['النظام يعلق','App freezes'],
        ['طلب تغيير رقم','Phone number change request'],
        ['غير ذلك','Other'],
        ['يمكنك أيضاً استخدام الاختصارات أدناه.','You can also use the shortcuts below.'],
        ['تعليق النظام','System freeze'],
        ['تغيير رقم','Change number'],
        ['موضوع آخر','Other topic'],
        ['تفاصيل الاعتراض (اختياري)','Appeal details (optional)'],
        ['اكتب التفاصيل هنا…','Write details here…'],
        ['* إذا اخترت “غير ذلك” يجب كتابة التفاصيل.','* If you choose “Other”, you must write the details.'],
        ['إلغاء','Cancel'],
        ['إرسال','Send'],
        ['الاسم','Name'],
        ['رقم الهاتف','Phone'],
        ['+967 7XXXXXXXX','+967 7XXXXXXXX'],
        ['الرجاء تسجيل الدخول','Please sign in'],
        ['أدخل الاسم','Enter name'],
        ['رقم هاتف غير صالح','Invalid phone number'],
        ['اكتب تفاصيل الاعتراض','Please write the appeal details'],
        ['تم إرسال الاعتراض','Appeal submitted'],
        ['تعذّر الاتصال بالقاعدة','Failed to connect to database']
      ]);
      const L = localStorage.getItem('lang') || 'ar';
      if (typeof window.applyLang==='function'){ window.applyLang(L); }
    }
  })();
  </script>
  
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
  </script>
  
</body>
</html>