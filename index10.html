<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex – تغيير البيانات</title>

  <!-- خطوط وأيقونات جوجل -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --gray:#C7C7C7; --accent:#F36523;
      --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --top:54px; --radius:14px; --top-icon:#1E3A8A;
      --surface:#f7f8fa; --shadow:0 8px 16px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff;min-height:100dvh;overflow-x:hidden}

    /* Appbar */
    .appbar{position:fixed;top:0;inset-inline:0;height:var(--top);z-index:40;background:var(--gray);
      display:flex;align-items:center;justify-content:space-between;padding:4px 10px;box-shadow:0 1px 0 #bfbfbf}
    .accent-line{height:3px;background:var(--accent)}
    .btn{width:40px;height:40px;border-radius:12px;background:#fff;border:1px solid #d3d3d3;display:grid;place-items:center;cursor:pointer;color:var(--top-icon);position:relative;overflow:hidden}
    .btn.orange{color:var(--accent)}
    .ms{font-family:'Material Symbols Rounded';font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24;line-height:1}

    /* Page */
    .page{width:min(520px,92vw);margin:0 auto;padding:14px 10px 84px; padding-top:calc(var(--top) + 16px);}
    h1{margin:6px 0 12px;font-size:20px}

    /* Cards & inputs */
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
    .group{display:grid;gap:10px}
    .label{font-weight:900;font-size:13px}
    .hint{font-size:12px;color:var(--muted)}
    .row{display:flex;align-items:center;gap:10px}
    .field{display:flex;gap:8px;align-items:center}
    .input{flex:1;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fafafa;font-weight:800}
    .input[dir="ltr"]{direction:ltr}
    .input.error{border-color:#ef4444;background:#fff1f1}
    .btn-solid{padding:11px 12px;border-radius:12px;border:1px solid var(--line);font-weight:800;cursor:pointer;background:#fff}
    .btn-solid.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn[aria-pressed="true"] .ms{font-variation-settings:'FILL' 1,'wght' 700,'GRAD' 0,'opsz' 24}

    /* password strength */
    .strength{height:8px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb;overflow:hidden}
    .bar{height:100%;width:0%}

    /* Toast + ripple */
    .toast{position:fixed;bottom:78px;left:50%;transform:translateX(-50%) scale(.96);background:rgba(17,17,17,.92);color:#fff;
      padding:8px 12px;border-radius:10px;font-weight:800;font-size:12px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:70}
    .toast.show{opacity:1;transform:translateX(-50%) scale(1)}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(0,0,0,.18);animation:ripple .6s linear;pointer-events:none}
    @keyframes ripple{to{transform:scale(3);opacity:0}}

    /* Language sheet */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;visibility:hidden;pointer-events:none;transition:.25s;z-index:60}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -10px 28px rgba(0,0,0,.2);
      transform:translateY(100%);transition:.3s;z-index:61;padding:14px;border:1px solid #ececec;max-width:520px;margin:0 auto}
    .sheet.active{transform:translateY(0)}
    .sheet-backdrop.active{opacity:1;visibility:visible;pointer-events:auto}
    .grab{width:40px;height:4px;border-radius:3px;background:#e5e7eb;margin:4px auto 12px}
    .sheet .langs{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .sheet .langs button{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:800}

    /* حالات القراءة فقط */
    .readonly{background:#f3f4f6 !important; color:#6b7280}
  </style>
  
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f97316">
  
</head>
<body>

  <!-- Appbar -->
  <header class="appbar">
    <button class="btn orange" id="backBtn" title="خروج"><span class="ms">arrow_back_ios_new</span></button>
    <div class="row" style="gap:8px;align-items:center">
      <button class="btn" id="supportBtn" title="خدمة العملاء"><span class="ms">headset_mic</span></button>
      <button class="btn orange" id="langBtn" title="تغيير اللغة" style="font-weight:800">؏</button>
    </div>
  </header>
  <div class="accent-line"></div>

  <main class="page">
    <h1 data-i18n="edit_title">تغيير البيانات</h1>

    <!-- بيانات أساسية -->
    <div class="card" style="margin-bottom:12px">
      <div class="group">
        <div>
          <div class="label" data-i18n="full_name">الاسم الكامل</div>
          <div class="field">
            <input id="nameInput" class="input readonly" type="text" maxlength="60" placeholder=" " aria-label="الاسم" readonly>
            <button class="btn" id="clearName" title="مسح" disabled><span class="ms">backspace</span></button>
          </div>
        </div>

        <div>
          <div class="label" data-i18n="phone">رقم الهاتف</div>
          <div class="field">
            <input id="phoneInput" class="input readonly" type="tel" inputmode="tel" dir="ltr" placeholder=" " aria-label="رقم الهاتف" readonly>
            <button class="btn" id="formatPhone" title="تنسيق" disabled><span class="ms">dialpad</span></button>
          </div>
          <div class="hint" data-i18n="phone_hint">الاسم ورقم الهاتف للعرض فقط.</div>
        </div>
      </div>
    </div>

    <!-- تغيير كلمة المرور فقط -->
    <div class="card">
      <div class="group">
        <div class="hint" id="pwdNote" data-i18n="pwd_note">يمكنك تغيير كلمة المرور فقط. إذا كان لديك كلمة مرور حالية فيجب إدخالها.</div>

        <div>
          <div class="label" data-i18n="current_pwd">كلمة المرور الحالية</div>
          <div class="field">
            <input id="oldPwd" class="input" type="password" placeholder="••••••••" aria-label="القديمة">
            <button class="btn" data-toggle="oldPwd" title="إظهار"><span class="ms">visibility</span></button>
          </div>
        </div>

        <div>
          <div class="label" data-i18n="new_pwd">كلمة المرور الجديدة</div>
          <div class="field">
            <input id="newPwd" class="input" type="password" placeholder="••••••••" aria-label="الجديدة">
            <button class="btn" data-toggle="newPwd" title="إظهار"><span class="ms">visibility</span></button>
          </div>
          <div class="strength" aria-hidden="true"><div id="strBar" class="bar"></div></div>
          <div class="hint" data-i18n="pwd_req">6 أحرف على الأقل. يُفضّل أرقام وحروف.</div>
        </div>

        <div>
          <div class="label" data-i18n="confirm_pwd">تأكيد كلمة المرور</div>
          <div class="field">
            <input id="confirmPwd" class="input" type="password" placeholder="••••••••" aria-label="تأكيد">
            <button class="btn" data-toggle="confirmPwd" title="إظهار"><span class="ms">visibility</span></button>
          </div>
        </div>
      </div>
    </div>

    <!-- أزرار -->
    <div class="row" style="gap:10px; margin-top:12px">
      <button class="btn-solid" id="cancelBtn" style="flex:1" data-i18n="cancel">إلغاء</button>
      <button class="btn-solid primary" id="saveBtn" style="flex:1" data-i18n="save">حفظ</button>
    </div>
  </main>

  <!-- شيت اللغة -->
  <div class="sheet-backdrop" id="sheetBack"></div>
  <div class="sheet" id="langSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>
    <div class="langs">
      <button class="btn-solid" data-setlang="ar">العربية</button>
      <button class="btn-solid" data-setlang="en">English</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- مود الترجمة -->
  <script src="i18n.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
    function ripple(ev){const t=ev.currentTarget||ev.target.closest('.btn,.btn-solid'); if(!t) return; const r=document.createElement('span'); const d=Math.max(t.clientWidth,t.clientHeight); const rect=t.getBoundingClientRect(); r.className='ripple'; r.style.width=r.style.height=d+'px'; r.style.left=(ev.clientX-rect.left-d/2)+'px'; r.style.top=(ev.clientY-rect.top-d/2)+'px'; const old=t.querySelector('.ripple'); if(old) old.remove(); t.appendChild(r); setTimeout(()=>r.remove(),600);}
    document.addEventListener('click',e=>{ if(e.target.closest('.btn, .btn-solid')) ripple(e); });
    function toast(msg){const t=$("#toast"); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1400);}

    // header
    $("#backBtn").addEventListener('click', () => { window.location.replace('index1.html#account'); });
    $("#supportBtn").addEventListener('click', ()=> window.open('https://t.me/artikarbot','_blank'));

    // language sheet
    const langSheet=$("#langSheet"), back=$("#sheetBack");
    $("#langBtn").addEventListener('click', ()=>{ langSheet.classList.add('active'); back.classList.add('active'); });
    back.addEventListener('click', ()=>{ langSheet.classList.remove('active'); back.classList.remove('active'); });
    $$('#langSheet [data-setlang]').forEach(b=>b.addEventListener('click', ()=>{
      const l=b.dataset.setlang; localStorage.setItem('lang', l);
      if(typeof window.applyLang==='function') window.applyLang(l); else { document.documentElement.lang=l; document.documentElement.dir=(l==='ar')?'rtl':'ltr'; }
      back.click();
    }));

    // عناصر النموذج
    const nameInput = $("#nameInput");
    const phoneInput = $("#phoneInput");
    const oldPwd = $("#oldPwd");
    const newPwd = $("#newPwd");
    const confirmPwd = $("#confirmPwd");
    const strBar = $("#strBar");

    // قوة كلمة المرور
    function strength(p){
      let s=0;
      if(p.length>=6) s++;
      if(/[A-Z]/.test(p)) s++;
      if(/[a-z]/.test(p)) s++;
      if(/\d/.test(p)) s++;
      if(/[^A-Za-z0-9]/.test(p)) s++;
      return Math.min(s,5);
    }
    function renderStrength(){
      const st = strength(newPwd.value||'');
      const pct = (st/5)*100;
      strBar.style.width = pct+'%';
      strBar.style.background = st<2 ? '#ef4444' : st<4 ? '#f59e0b' : '#16a34a';
    }
    newPwd.addEventListener('input', renderStrength);
    renderStrength();

    // إظهار/إخفاء كلمات المرور
    $$(".btn[data-toggle]").forEach(b=>{
      b.addEventListener('click', ()=>{
        const id=b.getAttribute('data-toggle');
        const inp = document.getElementById(id);
        if(!inp) return;
        const vis = inp.type==='text';
        inp.type = vis ? 'password' : 'text';
        const pressed = b.getAttribute('aria-pressed')==='true';
        b.setAttribute('aria-pressed', (!pressed).toString());
        b.title = vis ? (DynexI18N?.current?.()==='en'?'Show':'إظهار') : (DynexI18N?.current?.()==='en'?'Hide':'إخفاء');
      });
    });

    // ===== Firebase init =====
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // جلسة المستخدم
    const session = (function(){ try{ return JSON.parse(localStorage.getItem('dynex_session')||'null'); }catch(_){ return null; }})();
    if(!session || !session.uid){
      toast('الرجاء تسجيل الدخول');
      setTimeout(()=> window.location.replace('index.html'), 800);
      return;
    }

    // جلب البيانات تلقائيًا (عرض الاسم والرقم فقط)
    const userRef = db.ref('users/'+session.uid);
    let storedPwd = ''; // كلمة المرور الحالية من القاعدة (إن وُجدت)
    userRef.on('value', snap=>{
      const u = snap.val() || {};
      nameInput.value  = (u.name || u.username || '').toString();
      phoneInput.value = (u.phone || '').toString();
      storedPwd = (u.password || '').toString();
    }, err=>{
      console.warn(err);
      toast('تعذّر تحميل البيانات');
    });

    // إلغاء
    $("#cancelBtn").addEventListener('click', ()=>{ history.back(); });

    // حفظ (تحديث كلمة المرور فقط)
    $("#saveBtn").addEventListener('click', async ()=>{
      [oldPwd, newPwd, confirmPwd].forEach(i=>i.classList.remove('error'));

      const cur = oldPwd.value || '';
      const np  = newPwd.value || '';
      const cp  = confirmPwd.value || '';

      // لو فيه كلمة مرور محفوظة مسبقًا، يلزم إدخال القديمة الصحيحة
      if(storedPwd){
        if(!cur || cur !== storedPwd){
          oldPwd.classList.add('error'); oldPwd.focus();
          return toast(DynexI18N?.current?.()==='en'?'Wrong current password':'كلمة المرور الحالية غير صحيحة');
        }
      }
      // التحقق من الجديدة/التأكيد
      if(np.length < 6){
        newPwd.classList.add('error'); newPwd.focus();
        return toast(DynexI18N?.current?.()==='en'?'Password too short':'كلمة المرور قصيرة');
      }
      if(np !== cp){
        confirmPwd.classList.add('error'); confirmPwd.focus();
        return toast(DynexI18N?.current?.()==='en'?'Passwords do not match':'كلمتا المرور غير متطابقتين');
      }

      try{
        await userRef.update({ password: np });
        storedPwd = np; // حدّث النسخة المحلية
        oldPwd.value = newPwd.value = confirmPwd.value = '';
        renderStrength();
        toast(DynexI18N?.current?.()==='en'?'Saved':'تم الحفظ');
        setTimeout(()=> history.back(), 600);
      }catch(e){
        console.error(e);
        toast('تعذّر الحفظ');
      }
    });

    // i18n
    if (window.DynexI18N && typeof DynexI18N.addPairs==='function'){
      DynexI18N.addPairs([
        ['تغيير البيانات','Edit Profile'],
        ['الاسم الكامل','Full name'],
        ['رقم الهاتف','Phone number'],
        ['الاسم ورقم الهاتف للعرض فقط.','Name and phone are read-only.'],
        ['يمكنك تغيير كلمة المرور فقط. إذا كان لديك كلمة مرور حالية فيجب إدخالها.','You can only change the password. If you have a current password, you must enter it.'],
        ['كلمة المرور الحالية','Current password'],
        ['كلمة المرور الجديدة','New password'],
        ['تأكيد كلمة المرور','Confirm password'],
        ['6 أحرف على الأقل. يُفضّل أرقام وحروف.','At least 6 characters. Use letters and digits.'],
        ['مسح','Clear'],
        ['تنسيق','Format'],
        ['إلغاء','Cancel'],
        ['حفظ','Save'],
        ['كلمة المرور الحالية غير صحيحة','Wrong current password'],
        ['كلمة المرور قصيرة','Password too short'],
        ['كلمتا المرور غير متطابقتين','Passwords do not match'],
        ['تم الحفظ','Saved'],
        ['إظهار','Show'],
        ['إخفاء','Hide']
      ]);
      const L = localStorage.getItem('lang') || 'ar';
      if (typeof window.applyLang==='function'){ window.applyLang(L); }
    }
  })();
  </script>
  
    <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
</script>
  
</body>
</html>