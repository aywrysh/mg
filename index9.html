<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex – دعوة صديق</title>

  <!-- خطوط وأيقونات جوجل (Material Symbols) -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --gray:#C7C7C7; --accent:#F36523; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --top:54px; --radius:14px; --top-icon:#1E3A8A; --surface:#f7f8fa;
      --shadow:0 8px 16px rgba(0,0,0,.06);
      --wa:#25D366; --tg:#229ED9; --fb:#1877F2; --x:#111; --mail:#6b7280;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff;min-height:100dvh;overflow-x:hidden}

    /* Appbar */
    .appbar{position:fixed;top:0;inset-inline:0;height:var(--top);z-index:40;background:var(--gray);
      display:flex;align-items:center;justify-content:space-between;padding:4px 10px;box-shadow:0 1px 0 #bfbfbf}
    .accent-line{height:3px;background:var(--accent)}
    .btn{width:40px;height:40px;border-radius:12px;background:#fff;border:1px solid #d3d3d3;display:grid;place-items:center;cursor:pointer;color:var(--top-icon);position:relative;overflow:hidden}
    .btn.orange{color:var(--accent)}
    .ms{font-family:'Material Symbols Rounded';font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24;line-height:1}

    /* Page */
    .page{width:min(520px,92vw);margin:0 auto;padding:14px 10px 84px; padding-top:calc(var(--top) + 16px);}
    h1{margin:6px 0 12px;font-size:20px}

    /* Cards & ui */
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;align-items:center;gap:10px}
    .muted{color:var(--muted)}
    .warn{display:flex;gap:10px;align-items:flex-start;background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12;padding:10px;border-radius:12px}

    /* Inputs group */
    .field{display:flex;gap:8px;align-items:center}
    .field input{
      flex:1;padding:12px 12px;border:1px solid var(--line);border-radius:12px;font-weight:800;outline:none;background:#fafafa
    }
    .field input[readonly]{background:#f6f7f9}

    /* Social grid */
    .socials{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .soc{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:14px;background:#fff;cursor:pointer;text-decoration:none;color:inherit}
    .soc .badge{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;color:#fff}
    .wa .badge{background:var(--wa)}
    .tg .badge{background:var(--tg)}
    .fb .badge{background:var(--fb)}
    .x  .badge{background:var(--x)}
    .mail .badge{background:var(--mail)}

    /* Toast + ripple */
    .toast{position:fixed;bottom:78px;left:50%;transform:translateX(-50%) scale(.96);background:rgba(17,17,17,.92);color:#fff;
      padding:8px 12px;border-radius:10px;font-weight:800;font-size:12px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:70}
    .toast.show{opacity:1;transform:translateX(-50%) scale(1)}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(0,0,0,.18);animation:ripple .6s linear;pointer-events:none}
    @keyframes ripple{to{transform:scale(3);opacity:0}}

    /* Language sheet */
    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;visibility:hidden;pointer-events:none;transition:.25s;z-index:60}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -10px 28px rgba(0,0,0,.2);
      transform:translateY(100%);transition:.3s;z-index:61;padding:14px;border:1px solid #ececec;max-width:520px;margin:0 auto}
    .sheet.active{transform:translateY(0)}
    .sheet-backdrop.active{opacity:1;visibility:visible;pointer-events:auto}
    .grab{width:40px;height:4px;border-radius:3px;background:#e5e7eb;margin:4px auto 12px}
    .sheet .langs{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .sheet .langs button{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:800}
  </style>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f97316">
</head>
<body>

  <!-- Appbar -->
  <header class="appbar">
    <button class="btn orange" id="backBtn" title="خروج"><span class="ms">arrow_back_ios_new</span></button>
    <div class="row" style="gap:8px;align-items:center">
      <button class="btn" id="supportBtn" title="خدمة العملاء"><span class="ms">headset_mic</span></button>
      <button class="btn orange" id="langBtn" title="تغيير اللغة" style="font-weight:800">؏</button>
    </div>
  </header>
  <div class="accent-line"></div>

  <main class="page">
    <h1 data-i18n="invite_title">دعوة صديق</h1>

    <!-- تحذير -->
    <div class="warn card">
      <span class="ms" aria-hidden="true" data-i18n-skip>campaign</span>
      <div class="muted" data-i18n="invite_note">شارك رمزك مع أصدقائك فقط. لا تشارك بيانات حسّاسة.</div>
    </div>

    <!-- الحقول: رمز الإحالة + رابط الإحالة -->
    <div class="card" style="margin-top:10px">
      <div class="row" style="justify-content:space-between">
        <b data-i18n="invite_code_label">رمز الدعوة</b>
        <small class="muted" id="saveState" aria-live="polite"></small>
      </div>
      <div class="field" style="margin-top:8px">
        <input id="inviteCodeInput" type="text" inputmode="latin" readonly
               placeholder="DNX-XXXXXX" value="—" aria-label="رمز الدعوة">
        <button class="btn" id="copyCode" title="نسخ"><span class="ms">content_copy</span></button>
      </div>

      <div class="row" style="margin-top:12px">
        <b data-i18n="invite_link">رابط الإحالة</b>
      </div>
      <div class="field" style="margin-top:8px">
        <input id="inviteLinkInput" type="text" readonly dir="ltr" value="—" aria-label="رابط الإحالة">
        <button class="btn" id="copyLink" title="نسخ الرابط"><span class="ms">link</span></button>
      </div>
    </div>

    <!-- مشاركة عبر مواقع التواصل -->
    <div class="card" style="margin-top:10px">
      <div class="row" style="justify-content:space-between">
        <b data-i18n="share_title">أرسل عبر</b>
        <span class="row muted" style="gap:4px"><span class="ms">share</span><span data-i18n="share_any">مواقع التواصل</span></span>
      </div>
      <div class="socials" style="margin-top:10px">
        <a class="soc wa ripple-container" id="shareWa" href="#" target="_blank" rel="noopener">
          <div class="badge" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M20.5 3.5A11 11 0 0 0 3.4 20.6l-1.1 3.9 4-1a11 11 0 0 0 14-20z" fill="#fff" opacity=".15"/>
              <path d="M12.04 2a9.95 9.95 0 0 0-8.6 14.9L2 22l5.25-1.38A9.95 9.95 0 1 0 12.04 2z" fill="#fff" opacity=".2"/>
              <path d="M17.3 14.2c-.2-.1-1.3-.6-1.5-.7-.2-.1-.3-.1-.5.1s-.6.7-.7.8-.3.1-.5 0a7.9 7.9 0 0 1-2.3-1.4 8.4 8.4 0 0 1-1.6-2c-.1-.2 0-.3.1-.5l.3-.4c.1-.1.1-.2.2-.4a.5.5 0 0 0 0-.5c0-.1-.5-1.2-.7-1.6s-.4-.4-.6-.4h-.5c-.2 0-.4.2-.5.4a2 2 0 0 0-.3 1 3.6 3.6 0 0 0 .8 1.9 12.2 12.2 0 0 0 4.4 4c.5.2.9.4 1.1.5.5.2.9.2 1.2.1a2 2 0 0 0 1.3-.9c.1-.2.1-.7.1-.8 0-.2-.2-.3-.4-.4z" fill="#fff"/>
            </svg>
          </div>
          <div><div style="font-weight:900">WhatsApp</div><div class="muted">wa.me</div></div>
        </a>

        <a class="soc tg ripple-container" id="shareTg" href="#" target="_blank" rel="noopener">
          <div class="badge" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M9.5 16.8l-.3 4.4c.4 0 .6-.2 .9-.4l2.1-1.9 4.3 3.1c.8.4 1.3.2 1.5-.7l2.8-13.2c.3-1.2-.4-1.7-1.2-1.4L3 11.1c-1.1.4-1.1 1-.2 1.3l4.3 1.3 10-6.3c.5-.3.9-.1.5.2L9.5 16.8z" fill="#fff"/>
            </svg>
          </div>
          <div><div style="font-weight:900">Telegram</div><div class="muted">t.me</div></div>
        </a>

        <a class="soc fb ripple-container" id="shareFb" href="#" target="_blank" rel="noopener">
          <div class="badge" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M13 22v-8h3l.5-4H13V7.5c0-1 .3-1.7 1.8-1.7H17V2.2C16.4 2.1 15.4 2 14.2 2 11.6 2 9.8 3.6 9.8 6.6V10H7v4h2.8v8H13z" fill="#fff"/>
            </svg>
          </div>
          <div><div style="font-weight:900">Facebook</div><div class="muted">facebook.com</div></div>
        </a>

        <a class="soc x ripple-container" id="shareX" href="#" target="_blank" rel="noopener">
          <div class="badge" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M17.6 2H20l-6 7.1L21.5 22H16l-4.4-5.8L6.4 22H4l6.4-7.6L2.5 2H8l3.9 5.2L17.6 2zM6.1 3.7l9.8 13h2L8.1 3.7h-2z" fill="#fff"/>
            </svg>
          </div>
          <div><div style="font-weight:900">X</div><div class="muted">twitter.com</div></div>
        </a>

        <a class="soc mail ripple-container" id="shareMail" href="#" target="_blank" rel="noopener">
          <div class="badge" aria-hidden="true"><span class="ms" style="color:#fff">mail</span></div>
          <div><div style="font-weight:900" data-i18n="email">البريد</div><div class="muted">mailto:</div></div>
        </a>

        <a class="soc ripple-container" id="shareNative" href="#">
          <div class="badge" style="background:#0ea5e9" aria-hidden="true"><span class="ms" style="color:#fff">ios_share</span></div>
          <div><div style="font-weight:900" data-i18n="native_share">مشاركة النظام</div><div class="muted">navigator.share</div></div>
        </a>
      </div>
    </div>

    <!-- إحصائيات -->
    <div class="row" style="gap:10px;margin-top:10px">
      <div class="card" style="flex:1">
        <div class="muted" data-i18n="invited_label">عدد المدعوين</div>
        <div style="font-weight:900;font-size:18px" id="invitedCount">0</div>
      </div>
      <div class="card" style="flex:1">
        <div class="muted" data-i18n="earnings_label">إجمالي الأرباح</div>
        <div style="font-weight:900;font-size:18px"><span id="earningsVal">0.00</span> <span class="muted">USDT</span></div>
      </div>
    </div>
  </main>

  <!-- شيت اللغة -->
  <div class="sheet-backdrop" id="sheetBack"></div>
  <div class="sheet" id="langSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>
    <div class="langs">
      <button class="btn-solid" data-setlang="ar">العربية</button>
      <button class="btn-solid" data-setlang="en">English</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- مود الترجمة -->
  <script src="i18n.js"></script>

  <!-- ✅ Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
    function ripple(ev){const t=ev.currentTarget||ev.target.closest('.ripple-container,.btn'); if(!t) return; const r=document.createElement('span'); const d=Math.max(t.clientWidth,t.clientHeight); const rect=t.getBoundingClientRect(); r.className='ripple'; r.style.width=r.style.height=d+'px'; r.style.left=(ev.clientX-rect.left-d/2)+'px'; r.style.top=(ev.clientY-rect.top-d/2)+'px'; const old=t.querySelector('.ripple'); if(old) old.remove(); t.appendChild(r); setTimeout(()=>r.remove(),600);}
    function toast(msg){const t=$("#toast"); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200);}
    document.addEventListener('click',e=>{ if(e.target.closest('.btn, .soc')) ripple(e); });

    $("#backBtn").addEventListener('click', ()=>{ if(history.length>1) history.back(); else window.location.replace('index1.html'); });
    $("#supportBtn").addEventListener('click', ()=> window.open('https://t.me/artikarbot','_blank'));

    const langSheet=$("#langSheet"), back=$("#sheetBack");
    $("#langBtn").addEventListener('click', ()=>{ langSheet.classList.add('active'); back.classList.add('active'); });
    back.addEventListener('click', ()=>{ langSheet.classList.remove('active'); back.classList.remove('active'); });
    $$('#langSheet [data-setlang]').forEach(b=>b.addEventListener('click', ()=>{
      const l=b.dataset.setlang; localStorage.setItem('lang', l);
      if(typeof window.applyLang==='function') window.applyLang(l); else { document.documentElement.lang=l; document.documentElement.dir=(l==='ar')?'rtl':'ltr'; }
      back.click();
    }));

    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const SESSION = (function(){ try{ return JSON.parse(localStorage.getItem('dynex_session')||'null'); }catch(_){ return null; }})();
    const UID = SESSION?.uid || null;
    if(!UID){
      toast('الرجاء تسجيل الدخول');
      setTimeout(()=>{ window.location.replace('index.html'); }, 900);
      return;
    }

    const codeInp = $("#inviteCodeInput");
    const linkInp = $("#inviteLinkInput");
    const invitedCountEl = $("#invitedCount");
    const earningsEl = $("#earningsVal");

    const REF_BASE = "https://aywrysh.github.io/mg/";

    function buildLink(code){
      return `${REF_BASE}/?ref=${encodeURIComponent(code||'')}`;
    }
    function updateShareLinks(){
      const url = encodeURIComponent(linkInp.value.trim());
      const L = (localStorage.getItem('lang')||'ar');
      const msg = (L==='en')
        ? `Join me on Dynex! Use my invite code: ${codeInp.value.trim()}`
        : `انضم إليَّ في Dynex! استخدم رمز دعوتي: ${codeInp.value.trim()}`;
      const txt = encodeURIComponent(msg);
      $("#shareWa").href   = `https://wa.me/?text=${txt}%0A${url}`;
      $("#shareTg").href   = `https://t.me/share/url?url=${url}&text=${txt}`;
      $("#shareFb").href   = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
      $("#shareX").href    = `https://twitter.com/intent/tweet?text=${txt}&url=${url}`;
      $("#shareMail").href = `mailto:?subject=${(L==='en')?'Join Dynex':'انضم إلى Dynex'}&body=${txt}%0A${url}`;
    }

    db.ref('users/'+UID).on('value', s=>{
      const v = s.val() || {};
      const code = (v.inviteCode || v.accountId || '').toString().trim();
      codeInp.value = code || '—';
      codeInp.readOnly = true;
      linkInp.value = code ? buildLink(code) : '—';
      linkInp.dir = 'ltr';
      updateShareLinks();
    }, _=> toast('تعذّر جلب رمز الدعوة'));

    // ✅ تحديث فوري للإحصاءات
    function setStats(c,e){ invitedCountEl.textContent = Number(c||0); earningsEl.textContent = Number(e||0).toFixed(2); }
    const refRef = db.ref('referrals/'+UID);
    refRef.on('value', async (snap)=>{
      if (snap.exists()){
        const x = snap.val()||{};
        setStats(x.count ?? x.invited ?? 0, x.earnings ?? x.total ?? 0);
      }else{
        // Fallback لمرة واحدة من users
        try{
          const u = (await db.ref('users/'+UID).get()).val()||{};
          setStats(u.refCount ?? 0, u.refEarnings ?? 0);
        }catch(_){ setStats(0,0); }
      }
    }, _=> setStats(0,0));

    $("#copyCode").addEventListener('click', async ()=>{
      const c = codeInp.value.trim();
      if(!c || c==='—'){ toast('لا يوجد رمز'); return; }
      try{ await navigator.clipboard.writeText(c); toast('تم النسخ'); }catch{ toast(c); }
    });
    $("#copyLink").addEventListener('click', async ()=>{
      const l = linkInp.value.trim();
      if(!l || l==='—'){ toast('لا يوجد رابط'); return; }
      try{ await navigator.clipboard.writeText(l); toast('تم نسخ الرابط'); }catch{ toast(l); }
    });

    $("#shareNative").addEventListener('click', async (e)=>{
      e.preventDefault();
      const url = linkInp.value.trim();
      const L = (localStorage.getItem('lang')||'ar');
      const msg = (L==='en')
        ? `Join me on Dynex! Use my invite code: ${codeInp.value.trim()}`
        : `انضم إليَّ في Dynex! استخدم رمز دعوتي: ${codeInp.value.trim()}`;
      try{
        if (navigator.share) await navigator.share({title:'Dynex', text:msg, url});
        else { await navigator.clipboard.writeText(`${msg}\n${url}`); toast((L==='en')?'Copied to clipboard':'تم النسخ إلى الحافظة'); }
      }catch(_){}
    });

    if (window.DynexI18N && typeof DynexI18N.addPairs==='function'){
      DynexI18N.addPairs([
        ['دعوة صديق','Invite Friend'],
        ['شارك رمزك مع أصدقائك فقط. لا تشارك بيانات حسّاسة.','Share your code only with people you trust. Do not share sensitive info.'],
        ['رمز الدعوة','Invite Code'],
        ['رابط الإحالة','Referral Link'],
        ['أرسل عبر','Share via'],
        ['مواقع التواصل','Social'],
        ['عدد المدعوين','Invited'],
        ['إجمالي الأرباح','Total Earnings'],
        ['البريد','Email'],
        ['مشاركة النظام','Native Share'],
        ['تم النسخ','Copied'],
        ['تم نسخ الرابط','Link copied']
      ]);
      const L = localStorage.getItem('lang') || 'ar';
      if (typeof window.applyLang==='function'){ window.applyLang(L); }
    }
  })();
  </script>
  
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
  </script>
</body>
</html>