<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex</title>

  <!-- Ø®Ø·ÙˆØ· ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />

  <style>
    :root{
      --bg-img: url('https.png');
      --ink:#1f2937;
      --muted:#94a3b8;
      --stroke:#e5e7eb;
      --panel:#ffffffcc;
      --input:#ffffffb3;
      --accent:#f97316;    /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù…Ø«Ù„ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
      --radius:20px;
      --shadow:0 10px 25px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Cairo", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink);
      background: var(--bg-img) center/cover no-repeat fixed;
      min-height:100vh; display:grid; place-items:center;
      position: relative;
    }
    .wrap{width:min(560px, 92vw);}

    /* Ø²Ø± Ø§Ù„Ù„ØºØ© (Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„) */
    .lang-btn{
      position:fixed; top:14px; inset-inline-end:14px;
      background:#ffffff99; border:1px solid var(--stroke); backdrop-filter:blur(6px);
      width:44px; height:44px; border-radius:12px; display:grid; place-items:center;
      cursor:pointer; z-index:20;
    }
    .ms{font-family:'Material Symbols Rounded'}

    .topbar{display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:8px}
    .logo-mini{width:76px; height:76px; border-radius:14px; display:grid; place-items:center; overflow:hidden}
    .logo-mini img{width:100%; height:100%; object-fit:cover}

    .card{background:var(--panel); border:1px solid var(--stroke); border-radius:28px; padding:24px 18px; box-shadow:var(--shadow)}
    h1.title{margin:0 0 14px; text-align:center; font-size:26px}
    .sub{margin:-8px 0 10px; text-align:center; color:#475569; font-weight:700}

    /* Ø­Ù‚ÙˆÙ„ + Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© */
    .field{position:relative; display:grid; gap:8px; margin:10px 0}
    .label{font-weight:900; font-size:13px}
    .input{
      width:100%; padding:14px 46px; background:var(--input); border:1px solid var(--stroke);
      border-radius:14px; outline:none; font-weight:700; font-size:16px; color:var(--ink)
    }
    .input::placeholder{color:#94a3b8}
    .input[dir="ltr"]{direction:ltr}
    .input.error{border-color:#ef4444; background:#fff1f1}
    .icon{
      position:absolute; inset-inline-start:12px; top:50%; transform:translateY(calc(-50% + 12px));
      width:22px; height:22px; color:#334155; opacity:.9; pointer-events:none;
    }
    .toggle{
      position:absolute; inset-inline-end:10px; top:50%; transform:translateY(calc(-50% + 12px));
      width:34px; height:34px; border:none; background:transparent; cursor:pointer; color:#475569;
    }

    .row{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
    .btn{display:inline-grid; place-items:center; min-width:42px; height:42px; border:1px solid var(--stroke); background:#fff; border-radius:12px; cursor:pointer}
    .btn:disabled{opacity:.6; pointer-events:none}

    .actions{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:14px}
    .btn-solid{padding:14px 16px; border-radius:14px; border:1px solid var(--stroke); background:#fff; font-weight:900; cursor:pointer; text-align:center}
    .btn-solid.primary{background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 10px 20px rgba(249,115,22,.25)}

    .toast{
      position:fixed; bottom:22px; left:50%; transform:translateX(-50%) scale(.96);
      background:rgba(17,17,17,.92); color:#fff; padding:8px 12px; border-radius:10px; font-weight:800; font-size:12px;
      opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:120;
    }
    .toast.show{opacity:1; transform:translateX(-50%) scale(1)}

    /* Ø´ÙŠØª Ø§Ù„Ù„ØºØ© (Ù†ÙØ³ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„) */
    .sheet-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; visibility:hidden; transition:.25s; z-index:19}
    .sheet{position:fixed; left:0; right:0; bottom:0; background:#fff; border-radius:20px 20px 0 0; box-shadow:0 -10px 30px rgba(0,0,0,.2);
      transform:translateY(100%); transition:.3s; z-index:20; padding:14px 16px; max-width:560px; margin:0 auto}
    .sheet.active{transform:translateY(0)}
    .sheet-backdrop.active{opacity:1; visibility:visible}
    .sheet .grab{width:42px; height:5px; border-radius:3px; background:#e5e7eb; margin:6px auto 12px}
    .sheet .langs{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .sheet .langs button{padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; cursor:pointer; font-weight:700}

    /* === Ù†Ø§ÙØ°Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù†Ø´Ø£ (Ø´ÙŠØª) === */
    .created-back{position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; visibility:hidden; transition:.25s; z-index:98}
    .created-sheet{position:fixed; left:0; right:0; bottom:0; background:#fff; border-radius:20px 20px 0 0; box-shadow:0 -10px 30px rgba(0,0,0,.2);
      transform:translateY(100%); transition:.3Ø³; z-index:99; padding:14px 16px; max-width:560px; margin:0 auto}
    .created-sheet.active{transform:translateY(0)}
    .created-back.active{opacity:1; visibility:visible}
    .created-sheet .grab{width:42px; height:5px; border-radius:3px; background:#e5e7eb; margin:6px auto 12px}

    /* ÙƒØ±Øª Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª (Ù„Ù„ØªØµØ¯ÙŠØ± ÙƒØµÙˆØ±Ø©) */
    #createdCard{
      background:#fff; border:1px solid var(--stroke); border-radius:16px; padding:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.06);
    }
    #brandHead{display:flex; align-items:center; justify-content:space-between; margin-bottom:6px}
    #brandHead .brand{display:flex; align-items:center; gap:8px; font-weight:900}
    #brandHead .dot{width:12px;height:12px;border-radius:50%;background:var(--accent)}
    #brandHead .app{font-weight:900;color:#0f172a}
    .created-title{display:flex;align-items:center;gap:8px;font-weight:900;margin:6px 0 10px}
    .created-ok{width:10px;height:10px;border-radius:50%;background:#22c55e}
    .kv{display:grid; grid-template-columns:150px 1fr; gap:8px 12px; margin:10px 0}
    .kv .k{color:#475569; font-weight:800; font-size:13px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .actions-row{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .warn{margin-top:10px; font-size:13px; color:#b91c1c; background:#fef2f2; border:1px solid #fee2e2; padding:8px 10px; border-radius:12px; font-weight:800}
  </style>
  
     <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e5e7eb">
  
  <link rel="icon" type="image/png" sizes="32x32" href="32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="16x16.png">
<link rel="shortcut icon" href="/favicon.ico">

<!-- iOS -->
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">

<!-- Android / PWA -->
<link rel="manifest" href="/site.webmanifest">

<!-- Safari pinned tab (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#e5e7eb">

<!-- Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
<meta name="msapplication-TileColor" content="#e5e7eb">

<!-- ğŸ”¥ ØªØ­Ø³ÙŠÙ† ØªØ­Ù…ÙŠÙ„ Ø®Ø· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª + Ù…Ù†Ø¹ ÙˆÙ…ÙŠØ¶Ù‡ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
      onload="this.rel='stylesheet'">
<noscript>
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0">
</noscript>
<style>
  html.icons-wait .ms{visibility:hidden}
  html.app-wait body{visibility:hidden}
</style>
<script>
  document.documentElement.classList.add('icons-wait','app-wait');
  window.__fontsReady = Promise.race([
    (document.fonts ? document.fonts.ready : Promise.resolve()),
    new Promise(r => setTimeout(r, 1500))
  ]).then(()=>{ document.documentElement.classList.remove('icons-wait'); });
</script>
  
  
</head>
<body>

  <!-- Ø²Ø± Ø§Ù„Ù„ØºØ© -->
  <button class="lang-btn" id="langBtn" title="language"><span class="ms">g_translate</span></button>

  <div class="wrap">
    <div class="topbar">
      <div class="logo-mini" title="Dynex"><img src="https1.png" alt="Dynex"></div>
    </div>

    <form class="card" id="createForm" autocomplete="off">
      <h1 class="title">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h1>
      <div class="sub">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ</div>

      <!-- Ø§Ù„Ø§Ø³Ù… -->
      <div class="field">
        <label class="label" for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <input id="name" class="input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <span class="icon ms">person</span>
      </div>

      <!-- Ø§Ù„Ù‡Ø§ØªÙ -->
      <div class="field">
        <label class="label" for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input id="phone" class="input" type="tel" inputmode="tel" dir="ltr" placeholder=" XXXXXXXX">
        <span class="icon ms">call</span>
      </div>

      <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªÙ„Ù‚Ø§Ø¦ÙŠ) + Ø²Ø± ØªØ­Ø¯ÙŠØ« -->
      <div class="field">
        <label class="label" for="uname">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
        <div class="row" style="position:relative">
          <input id="uname" class="input" type="text" placeholder="Ø³ÙŠÙÙˆÙ„Ù‘ÙØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§" readonly>
          <button class="btn" id="regenU" type="button" title="ØªØ¬Ø¯ÙŠØ¯"><span class="ms">refresh</span></button>
          <span class="icon ms">badge</span>
        </div>
        <div style="font-size:12px;color:var(--muted)">7 Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (ÙƒØ¨ÙŠØ±Ø© ÙˆØµØºÙŠØ±Ø©).</div>
      </div>

      <!-- ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
      <div class="field">
        <label class="label" for="pwd">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="pwd" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        <span class="icon ms">lock</span>
        <button class="toggle" id="togglePwd" type="button" aria-label="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡"><span class="ms">visibility</span></button>
      </div>

      <!-- ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
      <div class="field">
        <label class="label" for="cpwd">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="cpwd" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        <span class="icon ms">lock_reset</span>
        <button class="toggle" id="toggleCPwd" type="button" aria-label="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡"><span class="ms">visibility</span></button>
      </div>

      <div class="actions">
        <button class="btn-solid" id="cancelBtn" type="button" onclick="window.location.href='index.html'">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn-solid primary" id="createBtn" type="submit">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
      </div>
    </form>
  </div>

  <!-- Ø´ÙŠØª Ø§Ù„Ù„ØºØ© -->
  <div class="sheet-backdrop" id="sheetBack"></div>
  <div class="sheet" id="langSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>
    <div class="langs">
      <button data-setlang="ar" id="btnAr">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
      <button data-setlang="en" id="btnEn">English</button>
    </div>
  </div>

  <!-- âœ… Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù†Ø´Ø£ -->
  <div class="created-back" id="createdBack"></div>
  <div class="created-sheet" id="createdSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>

    <div id="createdCard">
      <div id="brandHead">
        <div class="brand"><span class="dot"></span><span>Dynex</span></div>
        <div class="app">Account Created</div>
      </div>

      <h3 class="created-title"><span class="created-ok"></span>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­</h3>
      <div class="kv">
        <div class="k">Ø§Ù„Ø§Ø³Ù…</div><div id="c_name"></div>
        <div class="k">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div><div id="c_username" class="mono"></div>
        <div class="k">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</div><div id="c_phone" class="mono"></div>
        <div class="k">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</div><div id="c_accountId" class="mono"></div>
        <div class="k">Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ©</div><div id="c_invite" class="mono"></div>
        <div class="k">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div><div id="c_password" class="mono"></div>
      </div>
    </div>

    <div class="actions-row">
      <button class="btn-solid" id="copyCreated" type="button">Ù†Ø³Ø®</button>
      <button class="btn-solid primary" id="saveImg" type="button">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©</button>
    </div>
    <div class="actions-row" style="margin-top:8px">
      <a class="btn-solid" id="waShare" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨</a>
      <a class="btn-solid" id="tgShare" target="_blank" rel="noopener">ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</a>
    </div>
    <div class="warn">âš ï¸ ÙŠÙØ±Ø¬Ù‰ Ù†Ø³Ø® Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù† â€” Ø³ØªØ­ØªØ§Ø¬Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>

    <div class="actions-row" style="margin-top:12px">
      <button class="btn-solid" id="closeCreated" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- html2canvas Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ÙƒØ±Øª ÙƒØµÙˆØ±Ø© -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Ù…Ù„Ù Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¥Ù† ÙˆØ¬Ø¯ -->
  <script src="i18n.js"></script>

  <!-- ===== Firebase (Modules) + Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, push, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // === ØªÙˆØ³Øª
    const $ = s => document.querySelector(s);
    (function(){
      const box = $("#toast"); let t=null;
      window.toast = (msg='ØªÙ…')=>{
        box.textContent = msg; box.classList.add('show');
        clearTimeout(t); t=setTimeout(()=>box.classList.remove('show'),1600);
      };
    })();

    // === Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±
    function attachToggle(btnId, inputId){
      const btn = document.getElementById(btnId);
      const inp = document.getElementById(inputId);
      if(!btn || !inp) return;
      btn.addEventListener('click', ()=>{
        const hidden = inp.type === 'password';
        inp.type = hidden ? 'text' : 'password';
        btn.querySelector('.ms').textContent = hidden ? 'visibility_off' : 'visibility';
      });
    }
    attachToggle('togglePwd','pwd');
    attachToggle('toggleCPwd','cpwd');

    // === ØªÙˆÙ„ÙŠØ¯ Ø¨ÙŠØ§Ù†Ø§Øª
    const genAccountId = ()=> '99' + Math.floor(Math.random()*1e7).toString().padStart(7,'0'); // 9 Ø®Ø§Ù†Ø§Øª ÙŠØ¨Ø¯Ø£ Ø¨Ù€99
    const genInviteCode = (len=6)=>{
      const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let out=''; for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
      return out;
    };
    const genUsernameLocal = (len=7)=>{
      const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
      let out=''; for(let i=0;i<len;i++) out+=chars[Math.floor(Math.random()*chars.length)];
      return out;
    };
    async function freshUsernameSafe(){
      let cand = genUsernameLocal();
      try{
        for(let t=0;t<5;t++){
          const u = (t===0)? cand : genUsernameLocal();
          const snap = await get(ref(db, 'usernames/'+u));
          if(!snap.exists()) return u;
        }
      }catch(_){}
      return cand;
    }

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const nameI  = $("#name");
    const phoneI = $("#phone");
    const unameI = $("#uname");
    const pwdI   = $("#pwd");
    const cpwdI  = $("#cpwd");
    const regen  = $("#regenU");
    const cancel = $("#cancelBtn");
    const create = $("#createBtn");

    // Ø§Ù„Ø´ÙŠØª + Ø¹Ù†Ø§ØµØ±Ù‡
    const createdSheet = $("#createdSheet");
    const createdBack  = $("#createdBack");
    const c_name      = $("#c_name");
    const c_username  = $("#c_username");
    const c_phone     = $("#c_phone");
    const c_accountId = $("#c_accountId");
    const c_invite    = $("#c_invite");
    const c_password  = $("#c_password");
    const copyCreated = $("#copyCreated");
    const saveImg     = $("#saveImg");
    const waShare     = $("#waShare");
    const tgShare     = $("#tgShare");
    const closeCreated= $("#closeCreated");

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ø³Ù… Ù…Ø¨Ø¯Ø¦ÙŠ Ø«Ù… ÙØ­Øµ
    let usernameVar = genUsernameLocal();
    unameI.value = usernameVar;
    (async ()=>{ try{ usernameVar = await freshUsernameSafe(); unameI.value = usernameVar; }catch(_){}})();

    regen.addEventListener('click', async ()=>{
      regen.disabled = true;
      try{
        usernameVar = await freshUsernameSafe();
        unameI.value = usernameVar;
        toast('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯');
      }finally{ regen.disabled = false; }
    });

    cancel.addEventListener('click', ()=>{
      nameI.value=''; phoneI.value=''; pwdI.value=''; cpwdI.value='';
      toast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
    });

    function validPhoneLoose(v){ return (String(v||'').replace(/\D/g,'').length >= 7); }

    // === ÙØªØ­ Ù†Ø§ÙØ°Ø© "ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡" + Ù†Ø³Ø®/Ø­ÙØ¸/Ø¥Ø±Ø³Ø§Ù„
    function openCreatedSheet(user){
      // ØªØ¹Ø¨Ø¦Ø©
      c_name.textContent      = user.name || 'â€”';
      c_username.textContent  = user.username || 'â€”';
      c_phone.textContent     = user.phone || 'â€”';
      c_accountId.textContent = user.accountId || 'â€”';
      c_invite.textContent    = user.inviteCode || 'â€”';
      c_password.textContent  = user.password || 'â€”';

      const shareText =
`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ Dynex âœ…

Ø§Ù„Ø§Ø³Ù…: ${user.name || 'â€”'}
Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.username || 'â€”'}
Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: ${user.accountId || 'â€”'}
Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${user.phone || 'â€”'}
Ø±Ù…Ø² Ø§Ù„Ø¯Ø¹ÙˆØ©: ${user.inviteCode || 'â€”'}
ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${user.password || 'â€”'}`;

      copyCreated.onclick = async ()=>{
        try{ await navigator.clipboard.writeText(shareText); toast('ØªÙ… Ø§Ù„Ù†Ø³Ø®'); }catch{ toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®'); }
      };
      waShare.href = 'https://wa.me/?text=' + encodeURIComponent(shareText);
      tgShare.href = 'https://t.me/share/url?url=' + encodeURIComponent(location.origin) + '&text=' + encodeURIComponent(shareText);

      saveImg.onclick = async ()=>{
        try{
          const node = document.getElementById('createdCard');
          const canvas = await html2canvas(node, {scale:2, backgroundColor:'#ffffff'});
          const url = canvas.toDataURL('image/png');
          const a = document.createElement('a');
          a.href = url; a.download = `Dynex-Account-${user.accountId||'new'}.png`;
          document.body.appendChild(a); a.click(); a.remove();
        }catch(e){ console.warn(e); toast('ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©'); }
      };

      const closeFn = ()=>{ createdSheet.classList.remove('active'); createdBack.classList.remove('active'); };
      createdBack.onclick  = closeFn;
      closeCreated.onclick = closeFn;

      createdSheet.classList.add('active');
      createdBack.classList.add('active');
    }

    // === Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ)
    $("#createForm").addEventListener('submit', async (e)=>{
      e.preventDefault();

      [nameI, phoneI, pwdI, cpwdI].forEach(i=>i.classList.remove('error'));

      if(!nameI.value.trim()){ nameI.classList.add('error'); nameI.focus(); return toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…'); }
      if(!validPhoneLoose(phoneI.value)){ phoneI.classList.add('error'); phoneI.focus(); return toast('Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­'); }
      if((pwdI.value||'').length < 6){ pwdI.classList.add('error'); pwdI.focus(); return toast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© (6+)'); }
      if(pwdI.value !== cpwdI.value){ cpwdI.classList.add('error'); cpwdI.focus(); return toast('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†'); }

      // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      let finalUsername = (usernameVar||'').trim();
      if(!finalUsername || finalUsername.length < 3){
        try{ finalUsername = await freshUsernameSafe(); }catch(_){ finalUsername = genUsernameLocal(); }
        unameI.value = finalUsername;
        usernameVar = finalUsername;
      }

      const prev = create.textContent; create.disabled = true; create.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';

      try{
        const usersRef = ref(db, 'users');
        const newRef   = push(usersRef);
        const uid      = newRef.key;

        const accountId  = genAccountId();
        const inviteCode = genInviteCode();

        const userData = {
          uid,
          accountId,
          username: finalUsername,
          name: nameI.value.trim(),
          phone: phoneI.value.trim(),
          password: pwdI.value,         // Ù†Øµ ÙˆØ§Ø¶Ø­ (ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª)
          balance: 0,
          lockedAmount: 0,
          inviteCode,
          createdAt: serverTimestamp()
        };

        await set(newRef, userData);
        await set(ref(db, 'usernames/'+finalUsername), uid);
        await set(ref(db, 'invites/'+inviteCode), { uid, createdAt: serverTimestamp() });

        toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨');

        // âœ… Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† ØªØ­ÙˆÙŠÙ„)
        openCreatedSheet({
          ...userData,
          createdAt: Date.now()
        });

      }catch(err){
        console.error(err);
        toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§');
      }finally{
        create.disabled = false; create.textContent = prev;
      }
    });

    // ===== Ø²Ø± Ø§Ù„Ù„ØºØ© + Ø§Ù„Ø´ÙŠØª (Ù†ÙØ³ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„) =====
    if (typeof window.applyLang === 'function') {
      applyLang(localStorage.getItem('lang') || 'ar');
    }
    const sheet = document.getElementById('langSheet');
    const back  = document.getElementById('sheetBack');
    const fab   = document.getElementById('langBtn');
    const openSheet = ()=>{ sheet.classList.add('active'); back.classList.add('active'); };
    const closeSheet= ()=>{ sheet.classList.remove('active'); back.classList.remove('active'); };
    fab?.addEventListener('click', openSheet);
    back.addEventListener('click', closeSheet);
    document.querySelectorAll('.langs button').forEach(b=>{
      b.addEventListener('click', ()=>{
        if (typeof window.applyLang==='function'){ applyLang(b.dataset.setlang); }
        localStorage.setItem('lang', b.dataset.setlang||'ar');
        closeSheet();
      });
    });

    // âœ… Ø§Ø¹ØªØ¨Ø± Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø© Ø§Ù„Ø¢Ù† Ù„Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§ (Ù…Ø¹ fonts.ready Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰)
    if (window.__fontsReady) window.__fontsReady.finally(()=>{
      document.documentElement.classList.remove('app-wait');
    }); else {
      document.documentElement.classList.remove('app-wait');
    }
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(()=>console.log("âœ” Service Worker registered"))
        .catch(err=>console.error("âŒ Service Worker failed:", err));
    }
  </script>
  
  
  <script>
  // Ø¹Ù†Ø¯ Ù†Ù‡Ø§ÙŠØ© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©/Ø§Ù„Ø®Ø·ÙˆØ·: Ø£Ø¸Ù‡Ø± Ø§Ù„ØµÙØ­Ø©
  if (window.__fontsReady) {
    window.__fontsReady.finally(function(){
      document.documentElement.classList.remove('app-wait');
    });
  } else {
    document.documentElement.classList.remove('app-wait');
  }
</script>
  
  
</body>
</html>