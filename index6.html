<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex</title>

  <!-- خط وأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --gray:#C7C7C7; --accent:#F36523; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --top:54px; --radius:14px; --top-icon:#1E3A8A; --shadow:0 8px 16px rgba(0,0,0,.06);
      --pos:#16a34a; --neg:#f97316; --chip-bg:#fff; --chip-line:#e6e7ea;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff;min-height:100dvh;overflow-x:hidden}
    .appbar{position:fixed;top:0;inset-inline:0;height:var(--top);z-index:40;background:var(--gray);
      display:flex;align-items:center;justify-content:space-between;padding:4px 10px;box-shadow:0 1px 0 #bfbfbf}
    .accent-line{height:3px;background:var(--accent)}
    .btn{width:40px;height:40px;border-radius:12px;background:#fff;border:1px solid #d3d3d3;display:grid;place-items:center;cursor:pointer;color:var(--top-icon);position:relative;overflow:hidden}
    .btn.orange{color:var(--accent)}
    .ms{font-family:'Material Symbols Rounded';font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24;line-height:1}

    .page{width:min(460px,92vw);margin:0 auto;padding:14px 0 84px; padding-top:calc(var(--top) + 16px);}
    h1{margin:8px 10px 12px;font-size:20px}

    .filters{display:flex;flex-direction:column;gap:10px;padding:0 10px;margin-bottom:10px}
    .row{display:flex;align-items:center;gap:10px}
    .col{flex:1;display:flex;flex-direction:column;gap:6px}
    label{font-weight:800;font-size:12px;color:#374151}
    .input{padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff;color:var(--ink);font-family:inherit;width:100%}

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:8px 10px;border-radius:999px;background:var(--chip-bg);border:1px solid var(--chip-line);font-weight:800;cursor:pointer;font-size:12px;color:var(--ink)}
    .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}

    .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 10px;margin-bottom:10px}
    @media (min-width:420px){ .cards{grid-template-columns:repeat(3,1fr);} }
    .card{background:#f7f8fa;border:1px solid #e6e7ea;border-radius:16px;padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:4px}
    .card .title{font-weight:800;font-size:13px;color:#334155}
    .card .amount{font-weight:900;font-size:16px}
    .pos{color:var(--pos)} .neg{color:var(--neg)}

    .list{display:grid;gap:10px;padding:0 10px 10px}
    .tx{background:#fff;border:1px solid #e6e7ea;border-radius:16px;padding:12px;box-shadow:var(--shadow)}
    .between{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .tx .l{display:flex;align-items:center;gap:10px}
    .icon{width:36px;height:36px;border-radius:10px;background:#f3f4f6;border:1px solid #e5e7eb;display:grid;place-items:center;color:#0f274d}
    .tx .name{font-weight:800}
    .tx .meta{color:#64748b;font-size:12px;font-weight:800;margin-top:2px}
    .tx .amt{font-weight:900}
    .tx .cur{font-weight:800;color:#64748b;margin-inline-start:4px}
    .tx .more{margin-top:8px;color:#475569;font-size:12px;display:none}
    .tx.open .more{display:block}

    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;visibility:hidden;transition:.25s;z-index:60}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:16px 16px 0 0;box-shadow:0 -10px 28px rgba(0,0,0,.2);
      transform:translateY(100%);transition:.3s;z-index:61;padding:14px;border:1px solid #ececec;max-width:460px;margin:0 auto}
    .sheet.active{transform:translateY(0)}
    .sheet-backdrop.active{opacity:1;visibility:visible}
    .grab{width:40px;height:4px;border-radius:3px;background:#e5e7eb;margin:4px auto 12px}

    .langs{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .langs button{padding:10px;border:1px solid #e6e7ea;border-radius:12px;background:#fff;cursor:pointer;font-weight:800}

    .toast{position:fixed;bottom:78px;left:50%;transform:translateX(-50%) scale(.96);background:rgba(17,17,17,.92);color:#fff;padding:8px 12px;border-radius:10px;font-weight:800;font-size:12px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:70}
    .toast.show{opacity:1;transform:translateX(-50%) scale(1)}

    .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(0,0,0,.18);animation:ripple .6s linear;pointer-events:none}
    @keyframes ripple{to{transform:scale(3);opacity:0}}
    .ripple-container{position:relative;overflow:hidden}

    /* ===== إضافات الطباعة / PDF ===== */
    .export-actions{display:flex;gap:8px;padding:0 10px 10px}
    .xbtn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:800;cursor:pointer}
    .xbtn.primary{background:var(--accent);border-color:var(--accent);color:#fff}

    #printArea{display:none}
    #printArea.active{display:block}
    .pr-wrap{font-family:"Cairo",Arial,sans-serif; color:#0f172a; padding:16px; background:#fff}
    .pr-a4{width:794px; min-height:1123px; margin:0 auto; background:#fff}
    .pr-head{display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:10px;flex-direction:column}
    .pr-title{font-weight:900;font-size:20px}
    .pr-sub{color:#64748b;font-weight:800;font-size:12px}
    .pr-table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .pr-table th, .pr-table td{padding:10px 12px;background:#fff;border:1px solid #e5e7eb}
    .pr-table th{background:#f8fafc;color:#475569;text-align:right;font-weight:900}
    .pr-table td{font-weight:800}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:900;font-size:12px}
    .pill.done{color:#16a34a;border-color:#16a34a1a;background:#16a34a0d}
    .pill.pending{color:#f59e0b;border-color:#f59e0b1a;background:#f59e0b0d}
    .pill.rejected{color:#ef4444;border-color:#ef44441a;background:#ef44440d}

    @page { size: A4 portrait; margin: 10mm; }
    @media print{
      .appbar,.accent-line,.filters,.cards,.list,.export-actions{display:none !important}
      .sheet,.sheet-backdrop{display:none !important}
      #printArea{display:block}
      body{background:#fff}
    }
  </style>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e5e7eb">
  
  
  <link rel="icon" type="image/png" sizes="32x32" href="32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="16x16.png">
<link rel="shortcut icon" href="/favicon.ico">

<!-- iOS -->
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">

<!-- Android / PWA -->
<link rel="manifest" href="/site.webmanifest">

<!-- Safari pinned tab (اختياري) -->
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#e5e7eb">

<!-- ألوان النظام (اختياري) -->

<meta name="msapplication-TileColor" content="#e5e7eb">




</head>
<body>
  <!-- Appbar -->
  <header class="appbar">
    <button class="btn orange" id="backBtn" title="خروج">  <img src="ايقونةخروج.png" alt="back" width="24" height="24" loading="lazy"></button>
    <div class="row">
      <button class="btn" id="supportBtn" title="خدمة العملاء"><img src="ايقوناتتواصل.png" alt="support" width="24" height="24" loading="lazy"></button>
     <button class="btn orange" id="langBtn" title="تغيير اللغة">
  <img src="ايقونةترجمه.png" alt="translate" width="24" height="24" loading="lazy">
</button>
    </div>
  </header>
  <div class="accent-line"></div>

  <main class="page">
    <h1 id="pageTitle">التقارير</h1>

    <!-- فلاتر -->
    <div class="filters">
      <div class="row">
        <div class="col">
          <label id="lblFrom">من تاريخ</label>
          <input type="date" id="dateFrom" class="input">
        </div>
        <div class="col">
          <label id="lblTo">إلى تاريخ</label>
          <input type="date" id="dateTo" class="input">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label id="lblRange">النطاق الزمني</label>
          <select id="rangeSelect" class="input">
            <option value="all" selected id="optAll">الكل</option>
            <option value="today" id="optToday">اليوم</option>
            <option value="week" id="optWeek">هذا الأسبوع</option>
            <option value="month" id="optMonth">هذا الشهر</option>
            <option value="custom" id="optCustom">مخصص</option>
          </select>
        </div>
      </div>

      <div class="row" style="flex-wrap:wrap">
        <div class="chips" id="typeChips">
          <div class="chip active" data-type="all" id="chipAll">الكل</div>
          <div class="chip" data-type="deposit" id="chipDep">إيداع</div>
          <div class="chip" data-type="withdraw" id="chipWdr">سحب</div>
          <div class="chip" data-type="transfer" id="chipTrf">تحويل</div>
          <div class="chip" data-type="deposit_to" id="chipDepTo">إيداع إلى حساب</div>
          <div class="chip" data-type="p2p" id="chipP2P">P2P</div>
        </div>
      </div>
    </div>

    <!-- ملخص -->
    <div class="cards" id="summary">
      <div class="card"><div class="title" id="tSumDep">إجمالي الإيداعات</div><div class="amount pos" id="sumDeposit">0</div></div>
      <div class="card"><div class="title" id="tSumWdr">إجمالي السحوبات</div><div class="amount neg" id="sumWithdraw">0</div></div>
      <div class="card"><div class="title" id="tSumTrf">إجمالي التحويلات</div><div class="amount neg" id="sumTransfer">0</div></div>
      <div class="card"><div class="title" id="tSumDepTo">إجمالي إيداع إلى حساب</div><div class="amount pos" id="sumDepTo">0</div></div>
      <div class="card"><div class="title" id="tSumP2P">إجمالي P2P</div><div class="amount" id="sumP2P">0</div></div>
      <div class="card"><div class="title" id="tSumCount">عدد العمليات</div><div class="amount" id="sumCount">0</div></div>
    </div>

    <!-- أزرار الطباعة / PDF -->
    <div class="export-actions">
      <button id="btnPrint" class="xbtn">طباعة</button>
      <button id="btnPDF" class="xbtn primary">تصدير PDF</button>
    </div>

    <!-- القائمة -->
    <div class="list" id="txList"></div>
  </main>

  <!-- لوحة التقرير للطباعة / PDF -->
  <div id="printArea">
    <div class="pr-wrap pr-a4" id="prContent"></div>
  </div>

  <!-- Sheet: اللغة -->
  <div class="sheet-backdrop" id="sheetBack"></div>
  <div class="sheet" id="langSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>
    <div class="langs">
      <button data-setlang="ar" id="btnAr">العربية</button>
      <button data-setlang="en" id="btnEn">English</button>
    </div>
  </div>

  <!-- Sheet: تأكيد الخروج -->
  <div class="sheet-backdrop" id="sheetBackExit"></div>
  <div class="sheet" id="exitSheet">
    <div class="grab"></div>
    <h3 style="text-align:center;margin:6px 0 10px" id="exitTitle">تأكيد الخروج؟</h3>
    <div style="display:flex;gap:10px">
      <button class="btn ripple-container" id="exitNo" style="flex:1;border:1px solid var(--line)">إلغاء</button>
      <button class="btn ripple-container orange" id="exitYes" style="flex:1;border:1px solid var(--accent);background:var(--accent);color:#fff">خروج</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- i18n (إن وجد) -->
  <script src="i18n.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- html2pdf.js للتصدير إلى PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <script>
  (function(){
    /* ===== i18n بسيط داخل الصفحة (يُستخدم إذا لم يوفّر i18n.js دوال) ===== */
    const T = {
      ar: {
        reports: 'التقارير',
        reportsDual: 'التقارير / Reports',
        support: 'خدمة العملاء',
        changeLang: 'تغيير اللغة',
        from: 'من تاريخ',
        to: 'إلى تاريخ',
        range: 'النطاق الزمني',
        all: 'الكل',
        today: 'اليوم',
        week: 'هذا الأسبوع',
        month: 'هذا الشهر',
        custom: 'مخصص',
        chip: {deposit:'إيداع', withdraw:'سحب', transfer:'تحويل', deposit_to:'إيداع إلى حساب', p2p:'P2P'},
        sumDeposit: 'إجمالي الإيداعات',
        sumWithdraw: 'إجمالي السحوبات',
        sumTransfer: 'إجمالي التحويلات',
        sumDepTo: 'إجمالي إيداع إلى حساب',
        sumP2P: 'إجمالي P2P',
        sumCount: 'عدد العمليات',
        print: 'طباعة',
        exportPDF: 'تصدير PDF',
        noOps: 'لا توجد عمليات ضمن هذا النطاق.',
        printedAt: 'وقت الطباعة',
        rangeWord: 'النطاق',
        th: {idx:'#', op:'العملية', amount:'المبلغ', status:'الحالة', date:'التاريخ', class:'التصنيف', other:'الطرف الآخر'},
        status: {done:'تم', pending:'قيد الانتظار', rejected:'مرفوض'},
        role: {deposit:'المودِع', deposit_to:'المودِع', transfer:'المستلم', withdraw:'المركز', p2p:'الطرف'},
        exitTitle:'تأكيد الخروج؟',
        cancel:'إلغاء', exit:'خروج',
        toastPrintNone:'لا توجد بيانات لطباعتها',
        toastPdfNone:'لا توجد بيانات للتصدير'
      },
      en: {
        reports: 'Reports',
        reportsDual: 'التقارير / Reports',
        support: 'Support',
        changeLang: 'Change language',
        from: 'From date',
        to: 'To date',
        range: 'Time range',
        all: 'All',
        today: 'Today',
        week: 'This week',
        month: 'This month',
        custom: 'Custom',
        chip: {deposit:'Deposit', withdraw:'Withdraw', transfer:'Transfer', deposit_to:'Deposit to Account', p2p:'P2P'},
        sumDeposit: 'Total Deposits',
        sumWithdraw: 'Total Withdrawals',
        sumTransfer: 'Total Transfers',
        sumDepTo: 'Total Deposit to Account',
        sumP2P: 'Total P2P',
        sumCount: 'Operations Count',
        print: 'Print',
        exportPDF: 'Export PDF',
        noOps: 'No operations in this range.',
        printedAt: 'Printed at',
        rangeWord: 'Range',
        th: {idx:'#', op:'Operation', amount:'Amount', status:'Status', date:'Date', class:'Category', other:'Other party'},
        status: {done:'done', pending:'pending', rejected:'rejected'},
        role: {deposit:'Depositor', deposit_to:'Depositor', transfer:'Recipient', withdraw:'Center', p2p:'Peer'},
        exitTitle:'Confirm exit?',
        cancel:'Cancel', exit:'Exit',
        toastPrintNone:'Nothing to print',
        toastPdfNone:'Nothing to export'
      }
    };
    function curLang(){
      const l = (localStorage.getItem('lang')||'ar').toLowerCase();
      return (l==='en'?'en':'ar');
    }
    function tr(path){
      const l = curLang();
      return path.split('.').reduce((o,k)=> (o||{})[k], T[l]) || '';
    }
    function applyLangInline(){
      const l = curLang();
      document.documentElement.lang = l;
      document.getElementById('pageTitle').textContent = tr('reports');
      document.getElementById('lblFrom').textContent = tr('from');
      document.getElementById('lblTo').textContent = tr('to');
      document.getElementById('lblRange').textContent = tr('range');
      document.getElementById('optAll').textContent = tr('all');
      document.getElementById('optToday').textContent = tr('today');
      document.getElementById('optWeek').textContent = tr('week');
      document.getElementById('optMonth').textContent = tr('month');
      document.getElementById('optCustom').textContent = tr('custom');

      document.getElementById('chipAll').textContent = tr('all');
      document.getElementById('chipDep').textContent = tr('chip.deposit');
      document.getElementById('chipWdr').textContent = tr('chip.withdraw');
      document.getElementById('chipTrf').textContent = tr('chip.transfer');
      document.getElementById('chipDepTo').textContent = tr('chip.deposit_to');
      document.getElementById('chipP2P').textContent = tr('chip.p2p');

      document.getElementById('tSumDep').textContent = tr('sumDeposit');
      document.getElementById('tSumWdr').textContent = tr('sumWithdraw');
      document.getElementById('tSumTrf').textContent = tr('sumTransfer');
      document.getElementById('tSumDepTo').textContent = tr('sumDepTo');
      document.getElementById('tSumP2P').textContent = tr('sumP2P');
      document.getElementById('tSumCount').textContent = tr('sumCount');

      document.getElementById('btnPrint').textContent = tr('print');
      document.getElementById('btnPDF').textContent = tr('exportPDF');

      document.getElementById('exitTitle').textContent = tr('exitTitle');
      document.getElementById('exitNo').textContent = tr('cancel');
      document.getElementById('exitYes').textContent = tr('exit');
    }
    window.applyLang = function(lang){
      localStorage.setItem('lang', (lang==='en'?'en':'ar'));
      applyLangInline();
      render(); // لإعادة توليد القائمة بالنصوص الصحيحة
    };

    /* ===== UI helpers ===== */
    const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
    function ripple(ev){const t=ev.currentTarget||ev.target.closest('.ripple-container,.btn'); if(!t) return; const r=document.createElement('span'); const d=Math.max(t.clientWidth,t.clientHeight); const rect=t.getBoundingClientRect(); r.className='ripple'; r.style.width=r.style.height=d+'px'; r.style.left=(ev.clientX-rect.left-d/2)+'px'; r.style.top=(ev.clientY-rect.top-d/2)+'px'; const old=t.querySelector('.ripple'); if(old) old.remove(); t.appendChild(r); setTimeout(()=>r.remove(),600);}
    document.addEventListener('click',e=>{ if(e.target.closest('.ripple-container,.btn')) ripple(e); },true);
    function toast(msg){const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200);}

    /* ===== Nav & sheets ===== */
    $('#supportBtn').onclick=()=>window.open('https://t.me/artikarbot','_blank');
    const exitBack=$('#sheetBackExit'), exitSheet=$('#exitSheet');
    $('#backBtn').onclick=()=>{ exitBack.classList.add('active'); exitSheet.classList.add('active'); };
    $('#exitNo').onclick=()=>{ exitBack.classList.remove('active'); exitSheet.classList.remove('active'); };
    $('#exitYes').onclick=()=>{ window.location.replace('index1.html'); };
    exitBack.onclick=()=>$('#exitNo').click();

    const langBack=$('#sheetBack'), langSheet=$('#langSheet');
    $('#langBtn').onclick=()=>{ langBack.classList.add('active'); langSheet.classList.add('active'); };
    langBack.onclick=()=>{ langBack.classList.remove('active'); langSheet.classList.remove('active'); };
    $$('#langSheet [data-setlang]').forEach(b=>b.onclick=()=>{ const l=b.dataset.setlang; if(typeof window.applyLang==='function') window.applyLang(l); });

    /* ===== Date helpers ===== */
    const pad=n=>n<10?('0'+n):n;
    const fmtInput=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const state={type:'all',from:null,to:null,range:'all'};

    function setRange(v){
      state.range=v;
      const t=new Date(); t.setHours(0,0,0,0);
      let from=null,to=null;
      if(v==='today'){ from=new Date(t); to=new Date(t); to.setHours(23,59,59,999);}
      else if(v==='week'){ to=new Date(t); to.setHours(23,59,59,999); from=new Date(t); from.setDate(from.getDate()-6);}
      else if(v==='month'){ to=new Date(t); to.setHours(23,59,59,999); from=new Date(t.getFullYear(),t.getMonth(),1);}
      $('#dateFrom').value = from?fmtInput(from):'';
      $('#dateTo').value   = to?fmtInput(to):'';
      state.from=from; state.to=to;
    }
    function syncCustom(){
      const df=$('#dateFrom').value, dt=$('#dateTo').value;
      state.from = df? new Date(df+'T00:00:00') : null;
      state.to   = dt? new Date(dt+'T23:59:59') : null;
      $('#rangeSelect').value='custom'; state.range='custom';
      render();
    }
    $('#rangeSelect').onchange=e=>{ setRange(e.target.value); render(); };
    $('#dateFrom').onchange=syncCustom; $('#dateTo').onchange=syncCustom;
    $('#typeChips').onclick=(e)=>{ const c=e.target.closest('.chip'); if(!c) return; $('#typeChips').querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); c.classList.add('active'); state.type=c.dataset.type||'all'; render(); };
    setRange('all');

    /* ===== Firebase init ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5سWNHIHY8RU8g".replace('س','5'), /* حماية بسيطة من النسخ */
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db=firebase.database();

    /* ===== Session / profile ===== */
    const session = (function(){ try{ return JSON.parse(localStorage.getItem('dynex_session')||'null'); }catch(_){ return null; }})();
    if(!session || !session.uid){ toast(curLang()==='ar'?'الرجاء تسجيل الدخول':'Please log in'); setTimeout(()=>window.location.replace('index.html'),800); return; }
    const UID = String(session.uid||'');

    let USERNAME = (session.username||'')+'';
    let ACCOUNT_ID = (session.accountId||'')+'';
    async function loadProfile(){
      try{
        const s = await db.ref('users/'+UID).get();
        if(s.exists()){
          const v=s.val()||{};
          USERNAME = USERNAME || (v.username||'')+'';
          ACCOUNT_ID = ACCOUNT_ID || (v.accountId||'')+'';
        }
      }catch(_){}
      try{
        const s2 = await db.ref('p2pAccounts/'+UID).get();
        if(s2.exists()){
          const v=s2.val()||{};
          USERNAME = USERNAME || (v.username||'')+'';
          ACCOUNT_ID = ACCOUNT_ID || (v.accountId||'')+'';
        }
      }catch(_){}
      USERNAME = (USERNAME||'').trim();
      ACCOUNT_ID = (ACCOUNT_ID||'').toString().trim();
    }

    /* ===== Utils ===== */
    const first = (...vals)=> vals.find(v=> v!==undefined && v!==null && v!=='');
    const toNum = v => { const n = Number(v); return isFinite(n)? n : 0; };
    const toDate = v => {
      if (v==null) return new Date();
      if (typeof v==='number'){ return new Date(v < 1e12 ? v*1000 : v); }
      const ms = Date.parse(v); return isFinite(ms)? new Date(ms) : new Date();
    };
    const ensureId = (path, key, v) => String(first(v?.id, v?.ref, v?.txid, key, (path+':'+key)));
    async function getNode(path){
      try{ const s=await db.ref(path).get(); return s.exists()? (s.val()||{}) : null; }
      catch(_){ return null; }
    }
    function* entries(obj){
      if(!obj) return;
      if(Array.isArray(obj)){ for(let i=0;i<obj.length;i++) yield [String(i), obj[i]]; }
      else { for(const k of Object.keys(obj)) yield [k,obj[k]]; }
    }
    const cmp = (a,b)=> String(a||'').toLowerCase()===String(b||'').toLowerCase();

    /* ===== Loaders (نفس منطقك) ===== */
    async function loadWithdrawals(uid){
      const WITHDRAW_PATHS = [
        `users/${uid}/withdrawals`,
        `users/${uid}/withdraw`,
        `withdrawals/${uid}`,
        `withdrawRequests/${uid}`,
        `withdrawals`,
        `withdraw`,
        `withdrawRequests`,
        `payouts`,
        `adminOps/${uid}`
      ];
      const outMap = new Map();
      for(const p of WITHDRAW_PATHS){
        const data = await getNode(p);
        if(!data) continue;
        for(const [k,v0] of entries(data)){
          const v=v0||{};
          if(p.startsWith('adminOps/') && String(v.op||'').toLowerCase().indexOf('withdraw')===-1) continue;
          const uidOf = String(first(v.uid, v.user_id, v.userId, v.ownerUid, uid));
          const accId = String(first(v.accountId, v.account_id, v.accId||''));
          if(uidOf!==UID && (ACCOUNT_ID && accId!==ACCOUNT_ID)) continue;
          const id = ensureId(p,k,v); if(outMap.has(id)) continue;
          const amt = toNum(first(v.netAmount, v.amount, v.amt, v.usdt, v.value, v.after?.delta));
          const cur = first(v.currency,'USDT');
          const time= first(v.created_ts, v.ts, v.createdAt, v.created_at, v.at, v.time, v.date, v.after?.at);
          const stRaw = String(first(v.status, v.state, v.approved, v.result, '')).toLowerCase();
          const status = /approved|done|paid|success|accepted|true|1/.test(stRaw) ? 'done' :
                         /rejected|failed|no|false|0|cancel/.test(stRaw) ? 'rejected' : (stRaw||'pending');
          outMap.set(id,{ id, uid, type:'withdraw', amount: amt, currency: cur, at: toDate(time), status,
            note: v.address ? ('إلى: '+v.address) : (v.note||''), counter: v.address||'',
            method: first(v.network, v.chain, v.method, v.gateway, '') });
        }
      }
      return [...outMap.values()];
    }

    async function loadAccToAcc(uid){
      const ACC2ACC_PATHS = [
        `users/${uid}/transfers`,
        `transfers/${uid}`,
        `transfers`,
        `accountDeposits`,
        `accountTransfers`,
        `depositsBetweenAccounts`,
        `deposits_to_accounts`,
        `adminOps/${uid}`
      ];
      const outMap=new Map();
      for(const p of ACC2ACC_PATHS){
        const data = await getNode(p);
        if(!data) continue;
        for(const [k,v0] of entries(data)){
          const v=v0||{};
          if(p.startsWith('adminOps/') && !/transfer|account/i.test(String(v.op||''))) continue;

          const fromUid = String(first(v.fromUid, v.from_uid, v.fromUser, v.senderUid, v.sender_id, v.fromUserId, ''));
          const toUid   = String(first(v.toUid,   v.to_uid,   v.toUser,   v.receiverUid, v.receiver_id, v.toUserId,   ''));
          const fromAcc = String(first(v.fromAccountId, v.from_account_id, v.fromAccId, v.senderAccountId, v.from, v.src, ''));
          const toAcc   = String(first(v.toAccountId,   v.to_account_id,   v.toAccId,   v.receiverAccountId, v.to,   v.dst, ''));
          const fromUname = String(first(v.fromUsername, v.from_username, v.senderUsername, v.sender_name, ''));
          const toUname   = String(first(v.toUsername,   v.to_username,   v.receiverUsername, v.receiver_name, ''));

          const meSender   = (fromUid===UID) || (ACCOUNT_ID && fromAcc===ACCOUNT_ID) || (USERNAME && cmp(fromUname, USERNAME));
          const meReceiver = (toUid===UID)   || (ACCOUNT_ID && toAcc===ACCOUNT_ID)   || (USERNAME && cmp(toUname, USERNAME));
          if(!meSender && !meReceiver) continue;

          const id = ensureId(p,k,v); if(outMap.has(id)) continue;

          const amt = toNum(first(v.amount, v.amt, v.usdt, v.value, v.delta));
          const cur = first(v.currency,'USDT');
          const time= first(v.created_ts, v.ts, v.createdAt, v.created_at, v.at, v.time, v.date);
          const stRaw= String(first(v.status, v.state, v.result, 'done')).toLowerCase();
          const status= /reject|fail|cancel/.test(stRaw) ? 'rejected' :
                        /pending|wait|review/.test(stRaw) ? 'pending' : 'done';

          const type = meReceiver ? 'deposit_to' : 'transfer';
          const otherName = meReceiver
              ? first(v.fromName, v.from_name, v.senderName, v.sender_name, fromUname, fromAcc, fromUid)
              : first(v.toName,   v.to_name,   v.receiverName, v.receiver_name, toUname,   toAcc,   toUid);

          outMap.set(id, { id, uid, type, amount: amt, currency: cur, at: toDate(time), status,
            note: v.note||'', counter: (otherName||'')+'', method: first(v.method, v.channel, v.route, v.source, 'internal') });
        }
      }
      return [...outMap.values()];
    }

    async function loadAdminDeposits(uid){
      try{
        const snap = await db.ref('adminOps/'+uid).get();
        if(!snap.exists()) return [];
        const obj=snap.val()||{}; const out=[];
        Object.keys(obj).forEach(k=>{
          const v=obj[k]||{};
          if(String(v.op).toLowerCase()!=='deposit_balance') return;
          const afterAmt = v.after?.amount!=null ? +v.after.amount : null;
          const beforeAmt= v.before?.amount!=null ? +v.before.amount : null;
          const delta = (afterAmt!=null && beforeAmt!=null) ? (afterAmt - beforeAmt) : (v.amount!=null?+v.amount:afterAmt);
          const ts = v.after?.at || v.at || v.createdAt || Date.now();
          if(delta!=null){
            out.push({ id:k, uid, type:'deposit', amount:+delta, currency:(v.currency||'USDT'),
              at:new Date(+ts), status:'done', note:'', counter:'', method:'adminOps' });
          }
        });
        return out;
      }catch(_){ return []; }
    }

    async function tryPath(path){ try{ const s=await db.ref(path).get(); return s.exists()? (s.val()||{}) : null; }catch(_){ return null; } }
    async function loadP2P(uid){
      const out=[]; const paths=[ 'p2pTransactions/'+uid, 'users/'+uid+'/p2p', 'p2p/tx/'+uid ];
      for(const p of paths){
        const obj = await tryPath(p); if(!obj) continue;
        const arr = Array.isArray(obj)? obj.map((v,i)=>[i,v]) : Object.entries(obj);
        for(const [k,v] of arr){
          const val=v||{}; const ts = (val.created_ts ?? val.ts ?? val.createdAt ?? val.created_at ?? val.at ?? val.time ?? val.date);
          out.push({ id:val.id||String(k), uid:(val.uid||uid), type:'p2p',
            amount:+(val.amount ?? val.amt ?? val.value ?? 0), currency:(val.currency||'YER'),
            at:new Date(ts ? Date.parse(ts) : Date.now()), status:(val.status||'done'),
            note: val.note||'', counter: val.peer||val.phone||'', method: val.method||'p2p' });
        }
      }
      return out;
    }

    /* ===== Fetch all ===== */
    let ALL_ROWS=[]; let LAST_FILTERED=[];

    async function fetchAll(){
      ALL_ROWS=[]; await loadProfile();
      const [w, a2a, dAdmin, p2p] = await Promise.all([ loadWithdrawals(UID), loadAccToAcc(UID), loadAdminDeposits(UID), loadP2P(UID) ]);
      const map=new Map(); [...w, ...a2a, ...dAdmin, ...p2p].forEach(r=>{ if(!map.has(r.id)) map.set(r.id,r); });
      ALL_ROWS = [...map.values()].sort((a,b)=> b.at - a.at);
      render();
    }

    /* ===== Render ===== */
    function opLabel(t){
      const l = curLang();
      return (l==='en'
        ? (T.en.chip[t]||t)
        : (T.ar.chip[t]||t));
    }
    function inRange(d){ if(state.from && d < state.from) return false; if(state.to && d > state.to) return false; return true; }

    function render(){
      applyLangInline();

      const filtered = ALL_ROWS.filter(r=>{
        const okType = (state.type==='all') || (r.type===state.type);
        return okType && inRange(r.at);
      });
      LAST_FILTERED = filtered.slice();

      const sum = {deposit:0, withdraw:0, transfer:0, deposit_to:0, p2p:0, count:filtered.length};
      filtered.forEach(r=>{ sum[r.type]=(sum[r.type]||0)+(+r.amount||0); });
      $('#sumDeposit').textContent = (sum.deposit).toFixed(2);
      $('#sumWithdraw').textContent= (sum.withdraw).toFixed(2);
      $('#sumTransfer').textContent= (sum.transfer).toFixed(2);
      $('#sumDepTo').textContent   = (sum.deposit_to).toFixed(2);
      $('#sumP2P').textContent     = (sum.p2p).toFixed(2);
      $('#sumCount').textContent   = sum.count;

      const list = $('#txList');
      if(!filtered.length){ list.innerHTML=`<div class="card" style="grid-column:1/-1;text-align:center">${tr('noOps')}</div>`; return; }

      list.innerHTML = filtered.map(r=>{
        const d=r.at; const fmt=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        const signClass = (r.type==='deposit' || r.type==='deposit_to') ? 'pos' : 'neg';
        const noteParts=[];
        if(r.note) noteParts.push((curLang()==='ar'?'ملاحظة: ':'Note: ')+r.note);
        if(r.counter) noteParts.push((curLang()==='ar'?'طرف آخر: ':'Other: ')+`<b dir="ltr">${r.counter}</b>`);
        if(r.method) noteParts.push((curLang()==='ar'?'طريقة: ':'Method: ')+r.method);
        const moreHtml = noteParts.length? `<div class="more">${noteParts.join('<br>')}</div>` : '';
        const statusTxt = tr('status.'+(r.status||'done').toLowerCase()) || r.status;
        return `
          <div class="tx">
            <div class="between">
              <div class="l">
                <div class="icon"><span class="ms">${{'deposit':'arrow_downward','withdraw':'arrow_upward','transfer':'sync_alt','deposit_to':'account_balance','p2p':'groups'}[r.type]||'receipt_long'}</span></div>
                <div>
                  <div class="name">${opLabel(r.type)}</div>
                  <div class="meta">${fmt} • ${statusTxt}</div>
                </div>
              </div>
              <div class="r">
                <span class="amt ${signClass}">${(+r.amount||0).toFixed(2)}</span>
                <span class="cur">${r.currency||''}</span>
              </div>
            </div>
            ${moreHtml}
          </div>`;
      }).join('');

      $('#txList').querySelectorAll('.tx').forEach(el=>{ el.onclick = ()=> el.classList.toggle('open'); });
    }

    /* ===== بناء لوحة الطباعة / PDF ===== */
    function buildPrintArea(){
      const brandName = localStorage.getItem('company_name') || 'Dynex';
      // التاريخ بأرقام إنجليزية دائمًا
      const nowStr = new Date().toLocaleString('en-GB',{hour12:false});

      // نطاق التاريخ الظاهر
      const df = $('#dateFrom').value, dt = $('#dateTo').value;
      let rangeTxt = tr('all');
      if(df || dt){ rangeTxt = (df?df:'…') + ' → ' + (dt?dt:'…'); }
      else if(state.range==='today'){ rangeTxt=tr('today'); }
      else if(state.range==='week'){ rangeTxt=tr('week'); }
      else if(state.range==='month'){ rangeTxt=tr('month'); }

      const rows = LAST_FILTERED.map((r,i)=>{
        const d=r.at; const dstr=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        const roleKey = r.type==='transfer' ? 'transfer' : (r.type==='withdraw' ? 'withdraw' : (r.type==='deposit_to'?'deposit_to': (r.type==='deposit'?'deposit':'p2p')));
        const otherLabel = tr('role.'+roleKey);
        const otherVal = (r.type==='withdraw' ? (r.method||otherLabel) : (r.counter||'—'));
        const statusKey = (r.status||'done').toLowerCase();
        const statusTxt = tr('status.'+statusKey) || r.status;
        return `
          <tr>
            <td>${i+1}</td>
            <td>${opLabel(r.type)}</td>
            <td>${(+r.amount||0).toFixed(2)} ${r.currency||''}</td>
            <td><span class="pill ${statusKey}">${statusTxt}</span></td>
            <td>${dstr}</td>
            <td>${tr('th.class')}</td>
            <td dir="ltr">${otherVal}</td>
          </tr>`;
      }).join('');

      // رأس واحد فقط (لا تكرار)، العنوان ثنائي اللغة كما طلبت
      document.getElementById('prContent').innerHTML = `
        <div class="pr-head">
          <div class="pr-title" style="font-size:22px">${tr('reportsDual')}</div>
          <div class="pr-sub">${brandName}</div>
          <div class="pr-sub">${tr('printedAt')}: ${nowStr}</div>
          <div class="pr-sub">${tr('rangeWord')}: ${rangeTxt}</div>
        </div>
        <table class="pr-table">
          <thead>
            <tr>
              <th>${tr('th.idx')}</th>
              <th>${tr('th.op')}</th>
              <th>${tr('th.amount')}</th>
              <th>${tr('th.status')}</th>
              <th>${tr('th.date')}</th>
              <th>${tr('th.class')}</th>
              <th>${tr('th.other')}</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="7" style="text-align:center">${tr('noOps')}</td></tr>`}
          </tbody>
        </table>
      `;
    }

    /* ===== طباعة و PDF ===== */
    $('#btnPrint').onclick = ()=>{
      if(!LAST_FILTERED.length){ toast(tr('toastPrintNone')); return; }
      buildPrintArea(); window.print();
    };
    $('#btnPDF').onclick = ()=>{
      if(!LAST_FILTERED.length){ toast(tr('toastPdfNone')); return; }
      buildPrintArea();
      const opt = {
        margin: 10,
        filename: `report_${Date.now()}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor:'#ffffff' },
        jsPDF: { unit: 'px', format: [794,1123], orientation: 'portrait' },
        pagebreak: { mode: ['css','legacy'] }
      };
      html2pdf().from(document.getElementById('prContent')).set(opt).save();
    };

    // أول تحميل
    applyLangInline();
    fetchAll().catch(()=>toast('تعذّر جلب البيانات'));
  })();
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(()=>{})
        .catch(()=>{});
    }
  </script>

  
  
</body>
</html>