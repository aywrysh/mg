<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex</title>

  <!-- خطوط وأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- ✅ أيقونات Google محلية بدل الروابط الخارجية -->
  <style>
    @font-face{
      font-family:'Material Symbols Rounded';
      font-style:normal;
      font-weight:100 700;
      src:url('material-symbols-rounded.woff2') format('woff2');
      font-display:swap;
    }
  </style>

<style>
  :root{
    --gray:#C7C7C7; --accent:#F36523; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --top:54px; --radius:14px; --top-icon:#1E3A8A; --surface:#f7f8fa;
    --shadow:0 8px 16px rgba(0,0,0,.06);
  }

  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html, body{height:100%}
  body{
    margin:0;
    font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--ink);
    background:#fff;
    min-height:100dvh;
    overflow-x:hidden;
  }

  /* Appbar */
  .appbar{
    position:fixed;top:0;inset-inline:0;height:var(--top);z-index:40;background:var(--gray);
    display:flex;align-items:center;justify-content:space-between;padding:4px 10px;box-shadow:0 1px 0 #bfbfbf
  }
  .accent-line{height:3px;background:var(--accent)}
  .btn{
    width:40px;height:40px;border-radius:12px;background:#fff;border:1px solid #d3d3d3;
    display:grid;place-items:center;cursor:pointer;color:var(--top-icon);position:relative;overflow:hidden
  }
  .btn.orange{color:var(--accent)}

  /* تثبيت حجم الأيقونة لمنع الاهتزاز أثناء تحميل الخط */
  .ms{
    font-family:'Material Symbols Rounded';
    font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24;
    display:inline-block; width:24px; height:24px; font-size:24px; line-height:24px; vertical-align:middle;
  }

  /* Page — توسيط أفقي وثبات هوامش وراحة جانبية، مع تمركز عمودي ذكي */
  .page{
    width:min(520px, 92vw);
    margin-inline:auto;
    padding-inline:clamp(16px, 4vw, 22px);
    padding-top:calc(var(--top) + 16px + env(safe-area-inset-top));
    padding-bottom:calc(80px + env(safe-area-inset-bottom));
    min-height:calc(100dvh - var(--top));
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  /* عدم تمدّد العناصر الداخلية بشكل غير مرغوب */
  .page > *{flex:0 0 auto}

  /* تمركز عمودي فقط عندما الشاشة طويلة كفاية (بدون ما يخرّب التمرير) */
  @media (min-height: 680px){
    .page{justify-content:center}
  }

  h1{margin:6px 0 12px;font-size:20px}

  /* Cards & inputs */
  .card{
    background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px 16px; /* مساحة داخلية مريحة ثابتة */
    box-shadow:var(--shadow)
  }
  .row{display:flex;align-items:center;gap:10px}
  .muted{color:var(--muted)}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .input{
    display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;
    padding:10px 12px;background:#fff
  }
  .input input{border:none;outline:none;flex:1;font-family:inherit;font-size:14px}

  .chip{
    display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);
    border-radius:999px;background:#fff;font-weight:800
  }
  .btn-solid{padding:12px;border-radius:12px;border:1px solid var(--line);font-weight:800;cursor:pointer;background:#fff}
  .btn-solid.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .danger{color:#ef4444}

  /* Networks */
  .nets{display:grid;grid-template-columns:1fr;gap:10px;margin-top:6px}
  .net{
    display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:14px;background:#fff;cursor:pointer
  }
  .net input{accent-color:var(--accent)}
  .net .badge{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;color:#fff;font-weight:900}
  .b-trc{background:#27A17C}
  .b-erc{background:#627EEA}
  .b-bep{background:#F3BA2F;color:#111}

  /* Warning */
  .warn{
    display:flex;gap:10px;align-items:flex-start;background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12;padding:10px;border-radius:12px
  }

  /* Summary */
  .summary{display:grid;gap:8px}
  .kv{display:flex;align-items:center;justify-content:space-between}
  .kv b{font-weight:900}

  /* Balance mini card */
  .bal-mini .amt{font-weight:900;font-size:18px;line-height:1}
  .bal-mini .unit{font-weight:800;opacity:.8;margin-inline-start:4px}

  /* Sheet (language / password) */
  .sheet-backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;visibility:hidden;pointer-events:none;transition:.25s;z-index:60
  }
  .sheet{
    position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -10px 28px rgba(0,0,0,.2);
    transform:translateY(100%);transition:.3s;z-index:61;padding:14px;border:1px solid #ececec;max-width:520px;margin:0 auto
  }
  .sheet.active{transform:translateY(0)}
  .sheet-backdrop.active{opacity:1;visibility:visible;pointer-events:auto}
  .grab{width:40px;height:4px;border-radius:3px;background:#e5e7eb;margin:4px auto 12px}
  .sheet .langs{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .sheet .langs button{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:800}

  /* Toast + ripple */
  .toast{
    position:fixed;bottom:calc(78px + env(safe-area-inset-bottom));left:50%;
    transform:translateX(-50%) scale(.96);background:rgba(17,17,17,.92);color:#fff;
    padding:8px 12px;border-radius:10px;font-weight:800;font-size:12px;opacity:0;pointer-events:none;
    transition:opacity .25s, transform .25s;z-index:70
  }
  .toast.show{opacity:1;transform:translateX(-50%) scale(1)}
  .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(0,0,0,.18);animation:ripple .6s linear;pointer-events:none}
  @keyframes ripple{to{transform:scale(3);opacity:0}}
</style>
  
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e5e7eb">


<link rel="icon" type="image/png" sizes="32x32" href="32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="16x16.png">
<link rel="shortcut icon" href="/favicon.ico">

<!-- iOS -->
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">

<!-- Android / PWA -->
<link rel="manifest" href="/site.webmanifest">

<!-- Safari pinned tab (اختياري) -->
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#e5e7eb">

<!-- ألوان النظام (اختياري) -->

<meta name="msapplication-TileColor" content="#e5e7eb">


<!-- تحسين تحميل خط الأيقونات + منع وميضه وإخفاء الصفحة مؤقتًا -->
<!-- (أزلنا روابط جوجل للأيقونات لأنها أصبحت محلية) -->
<style>
  /* إخفاء الأيقونات مؤقتًا + إخفاء الصفحة لحين الجاهزية */
  html.icons-wait .ms,
  html.icons-wait .mi { visibility: hidden; }
  html.app-wait body { visibility: hidden; }
</style>


  
</head>
<body>

  <!-- Appbar -->
  <header class="appbar">
    <button class="btn orange" id="backBtn" title="خروج">  <img src="ايقونةخروج.png" alt="back" width="24" height="24" loading="lazy"></button>
    <div class="row">
      <button class="btn" id="supportBtn" title="خدمة العملاء"><img src="ايقوناتتواصل.png" alt="support" width="24" height="24" loading="lazy"></button>
     <button class="btn orange" id="langBtn" title="تغيير اللغة">
  <img src="ايقونةترجمه.png" alt="translate" width="24" height="24" loading="lazy">
</button>
    </div>
  </header>
  <div class="accent-line"></div>

  <main class="page">
    <!-- ✅ تثبيت النص ومنع رجوع "سحبدولار" -->
  <h1 id="pageTitle"> USDT</h1>

    <!-- بطاقة الرصيد الحالي -->
    <div class="card bal-mini" id="balCard">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="muted" data-i18n="current_balance">الرصيد الحالي</div>
          <div class="amt"><span id="balNow">--.-</span><span class="unit">USDT</span></div>
        </div>
       <button class="btn" id="refreshBal" title="تحديث">
  <img class="ms" src="تحديث.png" alt="تحديث" width="24" height="24" loading="lazy">
</button>
      </div>
    </div>

    <!-- تحذير -->
   <div class="warn card">
  <img class="ms" aria-hidden="true" src="اعتراض.png" alt="" width="24" height="24" loading="lazy">
  <div class="warn card">
    <img class="ms" aria-hidden="true" data-i18n-skip src="اعتراض.png" alt="" width="24" height="24" loading="lazy">
    <div>
      <div style="font-weight:900" data-i18n="warn_title">تنبيه مهم</div>
      <div class="muted" data-i18n="warn_body">
        أرسل فقط على الشبكة الصحيحة. التحويل على شبكة خاطئة قد يؤدي لفقدان الرصيد.
      </div>
    </div>
  </div>
</div>
      </div>
    </div>

    <!-- اختيار الشبكة -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b data-i18n="net_label">اختر الشبكة:</b>
        <span class="chip"><span class="ms"></span> <span>USDT</span></span>
      </div>
      <div class="nets" id="networks">
        <!-- TRC20 -->
        <label class="net ripple-container">
          <input type="radio" name="net" value="TRC20" checked>
          <div class="badge b-trc">TRC</div>
          <div>
            <div style="font-weight:900">TRC20 (TRON)</div>
            <div class="muted" data-i18n="net_trc_note">رسوم منخفضة، وصول سريع</div>
          </div>
        </label>
        <!-- ERC20 -->
        <label class="net ripple-container">
          <input type="radio" name="net" value="ERC20">
          <div class="badge b-erc">ERC</div>
          <div>
            <div style="font-weight:900">ERC20 (Ethereum)</div>
            <div class="muted" data-i18n="net_erc_note">رسوم أعلى، ازدحام محتمل</div>
          </div>
        </label>
        <!-- BEP20 -->
        <label class="net ripple-container">
          <input type="radio" name="net" value="BEP20">
          <div class="badge b-bep">BEP</div>
          <div>
            <div style="font-weight:900">BEP20 (BNB Smart Chain)</div>
            <div class="muted" data-i18n="net_bep_note">رسوم منخفضة، وصول سريع</div>
          </div>
        </label>
      </div>
    </div>

    <!-- نموذج السحب -->
    <div class="card" style="margin-top:10px">
      <div class="field">
        <label for="addr"><b data-i18n="addr_label">عنوان المحفظة</b></label>
        <div class="input"><span class="ms"></span><input id="addr" type="text" placeholder="TX... / 0x... / 0x..." /></div>
      </div>

      <div class="field">
        <label for="amount"><b data-i18n="amt_label">المبلغ</b></label>
        <div class="input"><span class="ms"></span><input id="amount" type="number" min="0" step="0.01" placeholder="0.00" /></div>
        <div class="muted" id="limits" data-i18n="limits_text">الحد الأدنى: — | الرسوم: —</div>
      </div>

      <div class="card" style="background:#f9fafb;border-style:dashed">
        <div class="summary">
          <div class="kv"><span data-i18n="sum_net">الشبكة</span><b id="sumNet">TRC20</b></div>
          <div class="kv"><span data-i18n="sum_fee">الرسوم</span><b id="sumFee">—</b></div>
          <div class="kv"><span data-i18n="sum_arrival">المبلغ الواصل</span><b id="sumRecv">—</b></div>
        </div>
      </div>

      <div class="row" style="gap:8px;margin-top:10px">
        <button class="btn-solid" id="clearBtn" style="flex:1" data-i18n="clear">مسح</button>
        <button class="btn-solid primary" id="submitBtn" style="flex:2" data-i18n="submit">تأكيد السحب</button>
      </div>
    </div>
  </main>

  <!-- شيت اللغة -->
  <div class="sheet-backdrop" id="sheetBack"></div>
  <div class="sheet" id="langSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>
    <div class="langs">
      <button class="btn-solid" data-setlang="ar">العربية</button>
      <button class="btn-solid" data-setlang="en">English</button>
    </div>
  </div>

  <!-- شيت تأكيد كلمة المرور -->
  <div class="sheet-backdrop" id="passBack"></div>
  <div class="sheet" id="passSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>
    <div class="field">
      <label><b>تأكيد كلمة المرور</b></label>
      <div class="input"><span class="ms">lock</span><input id="passInput" type="password" placeholder="••••••••" autocomplete="current-password"/></div>
    </div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button class="btn-solid" id="passCancel">إلغاء</button>
      <button class="btn-solid primary" id="passOk">تأكيد</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- مود الترجمة الموحد -->
  <script src="i18n.js"></script>

  <!-- ✅ Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    /* ===== helpers ===== */
    const $=s=>document.querySelector(s); const $$=s=>document.querySelectorAll(s);
    function ripple(ev){const t=ev.currentTarget||ev.target.closest('.ripple-container'); if(!t) return; const r=document.createElement('span'); const d=Math.max(t.clientWidth,t.clientHeight); const rect=t.getBoundingClientRect(); r.className='ripple'; r.style.width=r.style.height=d+'px'; r.style.left=(ev.clientX-rect.left-d/2)+'px'; r.style.top=(ev.clientY-rect.top-d/2)+'px'; const old=t.querySelector('.ripple'); if(old) old.remove(); t.appendChild(r); setTimeout(()=>r.remove(),600);}
    function toast(msg){const t=$("#toast"); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400);}
    document.querySelectorAll('.btn, .btn-solid, .net').forEach(el=>el.addEventListener('click', ripple));

    /* ===== language sheet ===== */
    const langSheet=$("#langSheet"), back=$("#sheetBack");
    $("#langBtn").addEventListener('click', ()=>{ langSheet.classList.add('active'); back.classList.add('active'); });
    back.addEventListener('click', ()=>{ langSheet.classList.remove('active'); back.classList.remove('active'); });
    $$('#langSheet [data-setlang]').forEach(b=>b.addEventListener('click', ()=>{
      const l=b.dataset.setlang; localStorage.setItem('lang', l);
      if(typeof window.applyLang==='function') window.applyLang(l); else { document.documentElement.lang=l; document.documentElement.dir=(l==='ar')?'rtl':'ltr'; }
      back.click();
    }));

    /* ===== header actions ===== */
    $("#backBtn").addEventListener('click', ()=>{ if(history.length>1) history.back(); else window.location.replace('index1.html'); });
    $("#supportBtn").addEventListener('click', ()=> window.open('https://t.me/artikarbot','_blank'));

    /* ===== Firebase ===== */
    const cfg = {
      apiKey:"AIzaSyBr3mtTHa_nJajn9H5N1V5سWNHIHY8RU8g",
      authDomain:"dynex-f4486.firebaseapp.com",
      databaseURL:"https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId:"dynex-f4486",
      storageBucket:"dynex-f4486.firebasestorage.app"
    };
    if(!firebase.apps.length) firebase.initializeApp(cfg);
    const db = firebase.database();

    /* ===== session ===== */
    const SESSION = (function(){ try{return JSON.parse(localStorage.getItem('dynex_session')||'null');}catch(_){return null;} })();
    if(!SESSION || !SESSION.uid){ toast('الرجاء تسجيل الدخول'); setTimeout(()=>{ window.location.replace('index.html'); }, 900); return; }
    const UID = SESSION.uid;

    /* ================== تحقق حد السحب عبر "العقد المقفل" ================== */
    async function hasMinLocked(uid, min){
      try{
        const uSnap = await firebase.database().ref('users/'+uid).get();
        const u = uSnap.val() || {};
        const locked = Number(u.lockedAmount || 0); // نعتمد على قيمة العقد المقفل
        return locked >= min;
      }catch(e){
        console.error('minLocked check error:', e);
        return false;
      }
    }
    /* ======================================================================= */

    /* ===== balance live ===== */
    let BAL = 0;
    function renderBal(){ $("#balNow").textContent = (Number(BAL)||0).toFixed(2); }
    db.ref('users/'+UID+'/balance').on('value', s=>{ BAL = Number(s.val()||0); renderBal(); }, err=>{ console.error(err); toast('تعذّر جلب الرصيد'); });
    $("#refreshBal").addEventListener('click', renderBal);

    /* ===== withdraw form ===== */
    const networks = {
      TRC20: { fee: 1.0,  min: 5,  regex: /^T[1-9A-HJ-NP-Za-km-z]{25,34}$/ },
      ERC20: { fee: 1.0,  min: 20, regex: /^0x[a-fA-F0-9]{40}$/ },
      BEP20: { fee: 1.0,  min: 5,  regex: /^0x[a-fA-F0-9]{40}$/ }
    }; // الرسوم = 1$ لكل الشبكات

    const addr=$("#addr"), amount=$("#amount"), limits=$("#limits");
    const sumNet=$("#sumNet"), sumFee=$("#sumFee"), sumRecv=$("#sumRecv");
    const submitBtn=$("#submitBtn"); const clearBtn=$("#clearBtn");

    function currentNet(){ const r = document.querySelector('input[name="net"]:checked'); return (r&&r.value)||'TRC20'; }
    function formatUSDT(n){ return (isFinite(n)? Number(n).toFixed(2) : '—') + ' USDT'; }

    function renderSummary(){
      const net = currentNet(); const cfg=networks[net];
      sumNet.textContent = net;
      const a = parseFloat(amount.value||'0')||0;
      const fee = a>0 ? cfg.fee : 0; const recv = Math.max(0, a - fee);
      sumFee.textContent  = formatUSDT(fee);
      sumRecv.textContent = formatUSDT(recv);
      limits.textContent  = `الحد الأدنى: ${cfg.min} USDT | الرسوم: ${cfg.fee} USDT`;
    }
    renderSummary();
    $$('input[name="net"]').forEach(r=>r.addEventListener('change', renderSummary));
    amount.addEventListener('input', renderSummary);
    clearBtn.addEventListener('click', ()=>{ addr.value=''; amount.value=''; renderSummary(); });

    function validate(){
      const net=currentNet(), cfg=networks[net];
      const a = parseFloat(amount.value||'0')||0;
      const ad = (addr.value||'').trim();
      if(!ad){ toast('أدخل العنوان'); return false; }
      if(!cfg.regex.test(ad)){ toast('شكل العنوان لا يطابق الشبكة المختارة'); return false; }
      if(a < cfg.min){ toast(`الحد الأدنى ${cfg.min} USDT`); return false; }
      if(a <= cfg.fee){ toast('المبلغ يجب أن يكون أكبر من الرسوم'); return false; }
      if(a > BAL){ toast('الرصيد غير كافٍ'); return false; }
      return true;
    }

    /* ===== password sheet ===== */
    const passSheet=$("#passSheet"), passBack=$("#passBack");
    const passInput=$("#passInput"), passOk=$("#passOk"), passCancel=$("#passCancel");
    function openPass(){ passInput.value=''; passSheet.classList.add('active'); passBack.classList.add('active'); setTimeout(()=>passInput.focus(),50); }
    function closePass(){ passSheet.classList.remove('active'); passBack.classList.remove('active'); }
    passCancel.addEventListener('click', closePass);
    passBack.addEventListener('click', closePass);

    /* ===== current lock (يمنع التعديل إذا في طلب جارٍ) ===== */
    const CURRENT_REF = db.ref('withdrawals/'+UID+'/current');
    let CURRENT_ID=null;
    CURRENT_REF.on('value', async s=>{
      CURRENT_ID = s.val() || null;
      if(CURRENT_ID){
        const rec = (await db.ref('withdrawals/'+UID+'/'+CURRENT_ID).get()).val()||{};
        lockForm(rec);
      }else{
        unlockForm();
      }
    });

    function lockForm(rec){
      // ثبّت الشبكة والعنوان والمبلغ ولا تسمح بالتغيير
      if(rec.network){ const r = document.querySelector(`input[name="net"][value="${rec.network}"]`); if(r){ r.checked=true; } }
      if(rec.address){ addr.value = rec.address; }
      if(rec.amount){ amount.value = Number(rec.amount).toFixed(2); }
      renderSummary();
      $$('input[name="net"]').forEach(r=>{ r.disabled=true; r.parentElement.style.opacity=.7; });
      addr.readOnly = true; amount.readOnly = true; clearBtn.disabled = true;
      submitBtn.disabled = true; submitBtn.textContent = 'طلب قيد المراجعة';
    }
    function unlockForm(){
      $$('input[name="net"]').forEach(r=>{ r.disabled=false; r.parentElement.style.opacity=1; });
      addr.readOnly = false; amount.readOnly = false; clearBtn.disabled = false;
      submitBtn.disabled = false; submitBtn.textContent = 'تأكيد السحب';
    }

    /* ===== submit flow (تعديل الاستدعاء هنا فقط) ===== */
    submitBtn.addEventListener('click', async ()=>{
      if(!validate()) return;

      // ✅ السحب يتطلب أن يكون "العقد المقفل" ≥ 30 USDT
      const ok = await hasMinLocked(UID, 30);
      if(!ok){
        toast('لا يمكنك السحب قبل أن يكون العقد المقفل 30 USDT أو أكثر');
        return;
      }

      openPass(); // بعد التحقق يفتح شيت كلمة المرور
    });

    passOk.addEventListener('click', async ()=>{
      const pass = (passInput.value||'').trim();
      if(!pass){ toast('أدخل كلمة المرور'); return; }
      try{
        // تحقق كلمة المرور
        const uSnap = await db.ref('users/'+UID).get();
        if(!uSnap.exists()){ toast('الحساب غير موجود'); return; }
        const user = uSnap.val()||{};
        if(String(user.password||'') !== String(pass)){ toast('كلمة المرور غير صحيحة'); return; }

        // نفّذ السحب
        await doWithdraw();
        closePass();
      }catch(e){
        console.error(e); toast('تعذّر التنفيذ');
      }
    });

    async function doWithdraw(){
      const net=currentNet(), cfg=networks[net];
      const ad=(addr.value||'').trim();
      const a = parseFloat(amount.value||'0')||0;
      const fee = cfg.fee;
      const recv = Math.max(0, a-fee);
      // transaction لخصم الرصيد
      const userRef = db.ref('users/'+UID);
      let committed=false;
      await userRef.transaction(cur=>{
        if(!cur) return cur;
        const bal = Number(cur.balance||0);
        if(a>bal) return; // يلغي
        return {...cur, balance: +(bal - a).toFixed(2)};
      }, (err, ok)=>{
        if(err) console.error(err);
        committed = !!ok;
      });
      if(!committed){ toast('الرصيد غير كافٍ'); return; }

      // أنشئ سجل السحب
      const listRef = db.ref('withdrawals/'+UID);
      const pushRef = listRef.push();
      const wid = pushRef.key;
      const rec = {
        id: wid, uid: UID, network: net, address: ad,
        amount: +a.toFixed(2), fee: +fee.toFixed(2), netAmount: +recv.toFixed(2),
        status: 'pending', createdAt: Date.now()
      };
      await pushRef.set(rec);
      await CURRENT_REF.set(wid); // قفل الشبكة/العنوان
      lockForm(rec);
      toast('تم إرسال طلب السحب');
    }

    // عبارات إضافية للترجمة لو ناقصة
    if (window.DynexI18N && typeof DynexI18N.addPairs==='function'){
      DynexI18N.addPairs([
        [' دولار','USDT '],
        ['الرصيد الحالي','Current Balance'],
        ['تحديث','Refresh'],
        ['تنبيه مهم','Important Notice'],
        ['أرسل فقط على الشبكة الصحيحة. التحويل على شبكة خاطئة قد يؤدي لفقدان الرصيد.','Send only on the correct network. Transfers on the wrong network may lead to loss of funds.'],
        ['اختر الشبكة:','Select network:'],
        ['عنوان المحفظة','Wallet address'],
        ['المبلغ','Amount'],
        ['الشبكة','Network'],
        ['الرسوم','Fees'],
        ['المبلغ الواصل','Net amount'],
        ['تأكيد السحب','Confirm withdrawal'],
        ['مسح','Clear'],
        ['تم إرسال طلب السحب','Withdrawal submitted'],
        ['أدخل العنوان','Enter address'],
        ['شكل العنوان لا يطابق الشبكة المختارة','Address format does not match the selected network'],
        ['الحد الأدنى','Minimum'],
        ['المبلغ يجب أن يكون أكبر من الرسوم','Amount must be greater than fees'],
        ['الرصيد غير كافٍ','Insufficient balance'],
        ['الرجاء تسجيل الدخول','Please sign in']
      ]);
    }

    // طبّق اللغة المحفوظة
    const L = localStorage.getItem('lang') || 'ar';
    if (typeof window.applyLang==='function'){ window.applyLang(L); }

  })();
  </script>
  
    <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
</script>

<!-- ✅ لو أي سكربت حاول يغيّر العنوان: رجّعه فوراً -->
<script>
(function(){
  const h1 = document.querySelector('[data-i18n="withdraw_title"]');
  if(!h1) return;
  const fix = ()=>{ if(h1.textContent.trim() !== 'سحب USDT'){ h1.textContent = 'سحب USDT'; } };
  fix();
  const mo = new MutationObserver(fix);
  mo.observe(h1, {childList:true, characterData:true, subtree:true});
})();
</script>

</body>
</html>