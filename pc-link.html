<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex | ربط الكمبيوتر</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --soft:#f8fafc;
      --accent:#f97316;
      --radius:22px;
      --shadow:0 16px 38px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"IBM Plex Sans Arabic",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background: radial-gradient(900px 500px at 50% -120px, rgba(249,115,22,.18), transparent 60%),
                  radial-gradient(700px 480px at 0% 30%, rgba(2,132,199,.10), transparent 60%),
                  #fff;
      color:var(--ink);
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:18px;
    }
    .wrap{width:min(680px, 96vw)}
    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
      backdrop-filter: blur(8px);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(180deg, rgba(249,115,22,.18), rgba(249,115,22,.06));
      border:1px solid rgba(249,115,22,.25);
      display:grid;place-items:center;
      font-weight:1000;color:var(--accent);
    }
    h1{margin:0;font-size:18px;font-weight:1000}
    .sub{margin:4px 0 0;color:var(--muted);font-weight:900;font-size:13px;line-height:1.6}

    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:1000;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:.12s;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#111;
      box-shadow:0 12px 22px rgba(249,115,22,.25);
    }
    .btn.ghost{background:var(--soft)}
    .grid{display:grid; grid-template-columns:1fr; gap:12px; margin-top:10px}
    .codeBox{
      background:var(--soft);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .code{
      font-size:26px;
      letter-spacing:3px;
      font-weight:1000;
      direction:ltr;
      unicode-bidi:bidi-override;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .hint{
      margin-top:2px;
      padding:12px;
      border:1px dashed rgba(15,23,42,.18);
      border-radius:18px;
      background:rgba(248,250,252,.8);
      color:var(--muted);
      font-weight:900;
      line-height:1.7;
      font-size:13px;
    }
    .danger{
      border-color:#fecaca!important;
      background:#fff1f2!important;
      color:#991b1b!important;
    }
    .toast{
      position:fixed; bottom:18px; left:50%;
      transform:translateX(-50%) scale(.96);
      background:rgba(17,17,17,.92); color:#fff;
      padding:9px 12px; border-radius:12px;
      font-weight:1000; font-size:12px;
      opacity:0; pointer-events:none;
      transition:opacity .25s, transform .25s;
      z-index:200;
    }
    .toast.show{opacity:1; transform:translateX(-50%) scale(1)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="brand">
          <div class="logo">Dx</div>
          <div>
            <h1>ربط الكمبيوتر</h1>
            <div class="sub">ولّد كود من هنا، ثم اكتبه في صفحة الكمبيوتر. وعند وصول طلب الربط سيظهر لك هنا موافقة/رفض.</div>
          </div>
        </div>
        <button class="btn ghost" id="backBtn" type="button">رجوع</button>
      </div>

      <div class="grid">
        <div class="codeBox">
          <div>
            <div style="font-weight:1000;color:#334155;font-size:12px;margin-bottom:6px">كود الربط</div>
            <div class="code" id="linkCode">—</div>
            <div style="margin-top:6px;color:#64748b;font-weight:900;font-size:12px" id="expiresLabel">—</div>
          </div>
          <div class="row">
            <button class="btn" id="copyBtn" type="button">نسخ</button>
            <button class="btn primary" id="newBtn" type="button">توليد كود</button>
          </div>
        </div>

        <div class="hint">
          ✅ الكود صالح لمدة <b>10 دقائق</b> فقط.<br>
          ✅ عند دخول الكمبيوتر بالكود سيظهر لك طلب موافقة هنا.<br>
          ⚠ لا تشارك الكود مع أي شخص.
        </div>

        <div id="warn" class="hint danger" style="display:none"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase (Compat CDN) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const toastEl = $('toast');
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 1400);
    }
    function readSession(){
      try{ return JSON.parse(localStorage.getItem('dynex_session')||'null'); }catch(_){ return null; }
    }
    function randCode(len=8){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out = "";
      for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    function showWarn(text){ $('warn').style.display='block'; $('warn').textContent=text; }
    function hideWarn(){ $('warn').style.display='none'; $('warn').textContent=''; }

    // ===== Paths =====
    // pc_links/<CODE> = { uid, accountId, createdAt, expiresAt, used:false }
    const PC_LINKS_PATH = "pc_links";
    // pc_link_requests/<UID>/<reqId> = { status:'pending', code, createdAt, device:{...} }
    const REQ_PATH_ROOT = "pc_link_requests";

    const TTL_MS = 10 * 60 * 1000; // 10 دقائق

    const linkCode = $('linkCode');
    const expiresLabel = $('expiresLabel');

    let lastExpiresAt = 0;
    let countdownTimer = null;

    function setExpires(expiresAt){
      lastExpiresAt = Number(expiresAt||0);
      if (countdownTimer) clearInterval(countdownTimer);
      const tick = ()=>{
        if(!lastExpiresAt){
          expiresLabel.textContent = '—';
          return;
        }
        const ms = lastExpiresAt - Date.now();
        if(ms <= 0){
          expiresLabel.textContent = 'انتهت صلاحية الكود';
          clearInterval(countdownTimer);
          countdownTimer = null;
          return;
        }
        const m = Math.floor(ms/60000);
        const s = Math.floor((ms%60000)/1000);
        expiresLabel.textContent = `متبقي: ${m}:${String(s).padStart(2,'0')}`;
      };
      tick();
      countdownTimer = setInterval(tick, 1000);
    }

    async function createCode(){
      hideWarn();
      const s = readSession();
      if(!s || !s.uid){
        showWarn("لا توجد جلسة مستخدم. لازم تسجّل دخول من الجوال أولاً.");
        return;
      }

      // توليد كود غير مكرر
      let code = randCode(8);
      let tries = 0;
      while(tries < 6){
        const snap = await db.ref(`${PC_LINKS_PATH}/${code}`).get();
        if(!snap.exists()) break;
        code = randCode(8);
        tries++;
      }

      const now = Date.now();
      const data = {
        uid: String(s.uid),
        accountId: String(s.accountId || ''),
        createdAt: now,
        expiresAt: now + TTL_MS,
        used: false
      };

      await db.ref(`${PC_LINKS_PATH}/${code}`).set(data);

      linkCode.textContent = code;
      setExpires(data.expiresAt);
      toast("تم توليد الكود");
    }

    async function copyCode(){
      const c = (linkCode.textContent || '').trim();
      if(!c || c === '—'){ toast("ولّد كود أولاً"); return; }
      try{ await navigator.clipboard.writeText(c); toast("تم النسخ"); }
      catch(_){ toast(c); }
    }

    $('newBtn').addEventListener('click', createCode);
    $('copyBtn').addEventListener('click', copyCode);
    $('backBtn').addEventListener('click', ()=>history.back());

    // توليد تلقائي عند فتح الصفحة
    createCode().catch(()=>{});

    // ==========================================================
    // ✅ داخل نفس الصفحة: استقبال طلب الربط من الكمبيوتر (موافقة/رفض)
    // ==========================================================
    (function pcRequestsWatcher(){
      const s = readSession();
      const UID = s && s.uid ? String(s.uid) : null;
      if(!UID) return;

      // UI
      const reqBack = document.createElement('div');
      reqBack.id = 'reqBack';
      reqBack.style.cssText = "position:fixed; inset:0; background:rgba(2,6,23,.46); opacity:0; visibility:hidden; transition:.2s; z-index:220;";
      document.body.appendChild(reqBack);

      const reqSheet = document.createElement('div');
      reqSheet.id = 'reqSheet';
      reqSheet.style.cssText = "position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.96); width:min(520px,94vw); background:#fff; border:1px solid #e5e7eb; border-radius:24px; box-shadow:0 20px 60px rgba(2,6,23,.20); padding:16px; z-index:221; opacity:0; visibility:hidden; transition:.2s;";
      reqSheet.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div style="display:flex;align-items:center;gap:10px">
            <div style="width:44px;height:44px;border-radius:16px;background:linear-gradient(180deg, rgba(249,115,22,.18), rgba(249,115,22,.06));border:1px solid rgba(249,115,22,.25);display:grid;place-items:center;font-weight:1000;color:#f97316">Dx</div>
            <div>
              <div style="font-weight:1000;font-size:14px">طلب ربط كمبيوتر</div>
              <div style="color:#64748b;font-weight:900;font-size:12px;line-height:1.5">يوجد جهاز كمبيوتر يحاول ربط حسابك الآن.</div>
            </div>
          </div>
          <button id="reqClose" class="btn ghost" type="button" style="padding:10px 12px">×</button>
        </div>

        <div style="margin-top:12px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:18px;padding:12px;">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>
              <div style="color:#64748b;font-weight:1000;font-size:12px">الكود</div>
              <div id="reqCode" style="font-weight:1000;letter-spacing:2px;direction:ltr">—</div>
            </div>
            <div>
              <div style="color:#64748b;font-weight:1000;font-size:12px">الوقت</div>
              <div id="reqTime" style="font-weight:1000;direction:ltr">—</div>
            </div>
          </div>
          <div style="margin-top:10px">
            <div style="color:#64748b;font-weight:1000;font-size:12px">معلومات الجهاز</div>
            <div id="reqDevice" style="font-weight:900;color:#0f172a;font-size:12px;line-height:1.7;direction:ltr">—</div>
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="reqReject" class="btn" type="button" style="flex:1;border-color:#fecaca;background:#fff1f2;color:#991b1b;font-weight:1000">رفض</button>
          <button id="reqApprove" class="btn primary" type="button" style="flex:1;font-weight:1000">موافقة</button>
        </div>

        <div style="margin-top:10px;color:#64748b;font-weight:900;font-size:12px;line-height:1.7">
          ⚠ إذا أنت ما طلبت ربط كمبيوتر، اضغط <b>رفض</b>.
        </div>
      `;
      document.body.appendChild(reqSheet);

      const reqClose   = reqSheet.querySelector('#reqClose');
      const reqApprove = reqSheet.querySelector('#reqApprove');
      const reqReject  = reqSheet.querySelector('#reqReject');
      const reqCodeEl  = reqSheet.querySelector('#reqCode');
      const reqTimeEl  = reqSheet.querySelector('#reqTime');
      const reqDeviceEl= reqSheet.querySelector('#reqDevice');

      function openReq(){
        reqBack.style.opacity='1'; reqBack.style.visibility='visible';
        reqSheet.style.opacity='1'; reqSheet.style.visibility='visible';
        reqSheet.style.transform='translate(-50%,-50%) scale(1)';
      }
      function closeReq(){
        reqBack.style.opacity='0'; reqBack.style.visibility='hidden';
        reqSheet.style.opacity='0'; reqSheet.style.visibility='hidden';
        reqSheet.style.transform='translate(-50%,-50%) scale(.96)';
      }
      reqBack.addEventListener('click', closeReq);
      reqClose.addEventListener('click', closeReq);

      function fmtTime(ts){
        try{ return new Date(Number(ts||0)).toLocaleString('ar-EG',{hour12:false}); }
        catch(_){ return ''; }
      }

      let currentReqRef = null;
      let currentReqId  = null;

      async function setStatus(status){
        if(!currentReqRef) return;
        try{
          await currentReqRef.update({ status, decidedAt: Date.now() });
          closeReq();
          toast(status==='approved' ? 'تمت الموافقة ✅' : 'تم الرفض ❌');
        }catch(e){
          console.error(e);
          toast('تعذّر تنفيذ العملية');
        }
      }

      reqApprove.addEventListener('click', ()=>setStatus('approved'));
      reqReject .addEventListener('click', ()=>setStatus('rejected'));

      // راقب آخر طلب pending
      db.ref(`${REQ_PATH_ROOT}/${UID}`)
        .orderByChild('createdAt')
        .limitToLast(1)
        .on('value', (snap)=>{
          if(!snap.exists()) return;

          let reqId=null, v=null;
          snap.forEach(ch=>{ reqId=ch.key; v=ch.val()||{}; });

          const st = String(v.status||'pending').toLowerCase();
          if(st !== 'pending') return;
          if(currentReqId === reqId) return;

          currentReqId = reqId;
          currentReqRef = db.ref(`${REQ_PATH_ROOT}/${UID}/${reqId}`);

          reqCodeEl.textContent = v.code || '—';
          reqTimeEl.textContent = fmtTime(v.createdAt || Date.now());

          const dev = v.device || {};
          const ua = (dev.ua || '').slice(0, 160);
          const info = [
            dev.platform ? ('platform: ' + dev.platform) : '',
            dev.lang ? ('lang: ' + dev.lang) : '',
            ua ? ('ua: ' + ua) : ''
          ].filter(Boolean).join(' | ');
          reqDeviceEl.textContent = info || '—';

          openReq();
          toast('طلب ربط جديد');
        });
    })();
  </script>
</body>
</html>