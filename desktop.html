<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex | ربط الكمبيوتر</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- ✅ Firebase (مرة واحدة فقط) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --line:rgba(226,232,240,.9);
      --soft:rgba(248,250,252,.92);
      --glass:rgba(255,255,255,.72);
      --accent:#f97316;
      --shadow:0 24px 80px rgba(2,6,23,.18);
      --shadow2:0 16px 45px rgba(2,6,23,.10);
      --radius:26px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"IBM Plex Sans Arabic",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink);
      min-height:100vh;
      overflow-x:hidden;
      background:#0b1220;
    }

    /* ✅ نخفي صفحة التسجيل بالكامل وقت الفحص */
    html.boot .shell{ display:none !important; }

    /* =========================
       ✅ مقدمة Splash (واتساب)
       ========================= */
    .splash{
      position:fixed; inset:0;
      background:#ffffff;
      display:grid;
      place-items:center;
      z-index:99999;
      transition:opacity .22s ease, visibility .22s ease;
    }
    .splash.hide{
      opacity:0;
      visibility:hidden;
      pointer-events:none;
    }
    .splashBox{
      width:min(520px, 92vw);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:16px;
      padding:26px 18px;
    }
    .sLogo{
      width:86px; height:86px;
      border-radius:26px;
      background:linear-gradient(180deg, rgba(249,115,22,.18), rgba(249,115,22,.06));
      border:1px solid rgba(249,115,22,.28);
      display:grid;
      place-items:center;
      overflow:hidden;
      box-shadow:0 18px 40px rgba(2,6,23,.10);
    }
    .sLogo img{
      width:64px; height:64px; object-fit:contain; display:block;
    }
    .sTitle{
      font-weight:1000;
      font-size:16px;
      color:#0f172a;
      letter-spacing:.2px;
    }
    .dashLine{
      width:min(420px, 86vw);
      height:12px;
      border-radius:999px;
      border:2px dashed rgba(15,23,42,.18);
      background:rgba(248,250,252,.9);
      position:relative;
      overflow:hidden;
    }
    .dashFill{
      position:absolute;
      inset:3px;
      width:35%;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(249,115,22,.95), rgba(249,115,22,.55));
      box-shadow:0 10px 20px rgba(249,115,22,.20);
      transform:translateX(0);
      animation:moveFill 1.05s ease-in-out infinite;
    }
    @keyframes moveFill{
      0%   { transform:translateX(-120%); width:30%; }
      50%  { transform:translateX(10%);   width:55%; }
      100% { transform:translateX(120%);  width:30%; }
    }
    .sHint{
      font-weight:900;
      font-size:12px;
      color:#64748b;
      text-align:center;
      line-height:1.7;
    }

    /* ===== خلفية 4 صور (من عندك) ===== */
    .bg4{
      position:fixed; inset:0;
      display:grid;
      grid-template-columns:1fr 1fr;
      grid-template-rows:1fr 1fr;
      gap:10px;
      padding:10px;
      z-index:-3;
    }
    .bg4 .p{
      border-radius:22px;
      overflow:hidden;
      position:relative;
      filter:saturate(1.12) contrast(1.05);
      background:#111827;
    }
    .bg4 .p::before{
      content:"";
      position:absolute; inset:0;
      background-size:cover;
      background-position:center;
      transform:scale(1.04);
    }
    /* غيّر أسماء الصور هنا لصورك */
    .bg4 .p.p1::before{ background-image:url(''); }
    .bg4 .p.p2::before{ background-image:url(''); }
    .bg4 .p.p3::before{ background-image:url(''); }
    .bg4 .p.p4::before{ background-image:url('logo.png'); }

    .bgOverlay{
      position:fixed; inset:0;
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(249,115,22,.28), transparent 55%),
        radial-gradient(900px 560px at 90% 30%, rgba(14,165,233,.20), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,.62), rgba(2,6,23,.62));
      backdrop-filter: blur(10px);
      z-index:-2;
    }
    .noise{
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E");
      opacity:.35;
      mix-blend-mode:overlay;
      pointer-events:none;
      z-index:-1;
    }

    /* ===== Layout ===== */
    .shell{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:28px;
    }
    .wrap{
      width:min(1120px, 96vw);
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:18px;
      align-items:stretch;
    }
    @media (max-width: 1020px){
      .wrap{grid-template-columns:1fr; width:min(720px,96vw);}
    }

    .card{
      background:var(--glass);
      border:1px solid rgba(255,255,255,.35);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .panel{
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.20);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      padding:18px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .brandL{display:flex;align-items:center;gap:12px}
    .logo{
      width:56px;height:56px;border-radius:18px;
      background:linear-gradient(180deg, rgba(249,115,22,.28), rgba(249,115,22,.06));
      border:1px solid rgba(249,115,22,.38);
      display:grid;place-items:center;
      font-weight:1000;color:var(--accent);
      font-size:18px;
      box-shadow:0 10px 22px rgba(249,115,22,.14) inset;
    }
    h1{margin:0;font-size:22px;font-weight:1000; letter-spacing:.2px}
    .sub{margin:6px 0 0;color:rgba(15,23,42,.78);font-weight:900;line-height:1.8;font-size:14px;max-width:60ch}

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.55);
      border:1px solid rgba(255,255,255,.40);
      font-weight:1000;
      color:#0f172a;
      direction:ltr;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#94a3b8;
      box-shadow:0 0 0 6px rgba(148,163,184,.18);
    }
    .dot.on{
      background:#22c55e;
      box-shadow:0 0 0 6px rgba(34,197,94,.18);
    }

    .box{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.35);
      border-radius:22px;
      background:rgba(248,250,252,.65);
      padding:14px;
    }
    .label{color:rgba(15,23,42,.70);font-weight:1000;font-size:12px;margin-bottom:8px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .input{
      flex:1;
      min-width:300px;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(226,232,240,.95);
      background:#fff;
      outline:none;
      font-size:18px;
      font-weight:1000;
      letter-spacing:2px;
      direction:ltr;
      box-shadow:0 10px 18px rgba(2,6,23,.06);
    }
    .btn{
      border:1px solid rgba(226,232,240,.95);
      background:#fff;
      color:var(--ink);
      padding:12px 14px;
      border-radius:16px;
      cursor:pointer;
      font-weight:1000;
      transition:.12s;
      user-select:none;
      box-shadow:0 10px 18px rgba(2,6,23,.06);
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.65;cursor:not-allowed;transform:none}
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#111;
      box-shadow:0 12px 26px rgba(249,115,22,.26);
    }

    .status{
      margin-top:12px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.40);
      background:rgba(255,255,255,.58);
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      min-height:74px;
      box-shadow:0 14px 30px rgba(2,6,23,.10);
    }
    .statusL{display:flex;align-items:center;gap:12px;min-width:0}
    .avatar{
      width:52px;height:52px;border-radius:18px;
      border:1px solid rgba(255,255,255,.65);
      background:#fff;
      overflow:hidden;
      flex:0 0 auto;
      box-shadow:0 10px 22px rgba(2,6,23,.08);
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .statusTextWrap{min-width:0}
    .statusTitle{
      font-weight:1000;
      font-size:13px;
      color:#0f172a;
      opacity:.9;
      margin-bottom:4px;
    }
    .statusText{
      font-weight:1000;
      color:#334155;
      line-height:1.6;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60ch;
    }
    .pill{
      padding:9px 11px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(226,232,240,.95);
      font-weight:1000;
      color:#111;
      direction:ltr;
      white-space:nowrap;
      box-shadow:0 10px 18px rgba(2,6,23,.06);
    }
    .ok{border-color:#bbf7d0!important;background:#f0fdf4!important;color:#166534!important}
    .no{border-color:#fecaca!important;background:#fff1f2!important;color:#991b1b!important}

    .help{
      border:1px solid rgba(255,255,255,.18);
      border-radius:22px;
      background:rgba(255,255,255,.22);
      padding:16px;
      color:#fff;
    }
    .help h2{margin:0 0 8px;font-size:16px;font-weight:1000}
    .help ol{margin:0;padding:0 18px;color:rgba(255,255,255,.86);font-weight:900;line-height:2}
    .footerNote{
      color:rgba(255,255,255,.86);
      font-weight:900;
      font-size:12px;
      line-height:1.8;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.16);
    }

    .kv{margin-top:10px;display:grid;grid-template-columns:1fr;gap:8px}
    .kv .item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:16px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;font-weight:900;
    }
    .kv .k{opacity:.85;font-size:12px}
    .kv .v{
      direction:ltr;font-size:12px;max-width:62%;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:.95;
    }
  </style>

  <!-- ✅ فعل وضع boot من البداية قبل ما يظهر أي شيء -->
  <script>
    document.documentElement.classList.add('boot');
  </script>
</head>

<body>
  <!-- ✅ Splash شاشة مقدمة -->
  <div class="splash" id="splash">
    <div class="splashBox">
      <div class="sLogo">
        <img src="logo.png" alt="Dynex">
      </div>
      <div class="sTitle">Dynex</div>
      <div class="dashLine" aria-hidden="true">
        <div class="dashFill"></div>
      </div>
      <div class="sHint" id="sHint">جاري الفحص…</div>
    </div>
  </div>

  <!-- خلفية 4 صور -->
  <div class="bg4" aria-hidden="true">
    <div class="p p1"></div>
    <div class="p p2"></div>
    <div class="p p3"></div>
    <div class="p p4"></div>
  </div>
  <div class="bgOverlay" aria-hidden="true"></div>
  <div class="noise" aria-hidden="true"></div>

  <div class="shell">
    <div class="wrap">

      <!-- Left: Login Card -->
      <div class="card">
        <div class="brand">
          <div class="brandL">
            <div class="logo">Dx</div>
            <div>
              <h1>تسجيل الدخول للكمبيوتر</h1>
              <div class="sub">أدخل كود الربط من الجوال. سيصلك طلب موافقة داخل صفحة الجوال (ربط الكمبيوتر).</div>
            </div>
          </div>
          <div class="chip" id="liveChip" title="حالة الصفحة">
            <span class="dot" id="liveDot"></span>
            <span id="liveTxt">READY</span>
          </div>
        </div>

        <div class="box">
          <div class="label">كود الربط</div>
          <div class="row">
            <input id="codeInput" class="input" placeholder="مثال: A8K3ZP2Q" maxlength="12" autocomplete="one-time-code" />
            <button id="sendBtn" class="btn primary" type="button">إرسال الطلب</button>
            <button id="resetBtn" class="btn" type="button">إعادة</button>
          </div>

          <!-- إشعار فخم + صورة -->
          <div id="status" class="status">
            <div class="statusL">
              <div class="avatar" title="صورة الإشعار">
                <img src="logo.png" alt="notify">
              </div>
              <div class="statusTextWrap">
                <div class="statusTitle">إشعار النظام</div>
                <div id="statusText" class="statusText">اكتب الكود ثم اضغط إرسال الطلب.</div>
              </div>
            </div>
            <span id="statusPill" class="pill">READY</span>
          </div>
        </div>
      </div>

      <!-- Right: Fancy Panel -->
      <div class="panel">
        <div class="help">
          <h2>طريقة الربط</h2>
          <ol>
            <li>افتح Dynex على الجوال.</li>
            <li>ادخل صفحة <b>ربط الكمبيوتر</b> وولّد كود.</li>
            <li>انسخ الكود والصقه هنا.</li>
            <li>سيظهر على الجوال طلب موافقة — عند الموافقة يتم تسجيل الدخول هنا تلقائيًا.</li>
          </ol>

          <div class="kv" style="margin-top:14px">
            <div class="item"><span class="k">Browser</span><span class="v" id="vBrowser">—</span></div>
            <div class="item"><span class="k">Platform</span><span class="v" id="vPlatform">—</span></div>
            <div class="item"><span class="k">Language</span><span class="v" id="vLang">—</span></div>
          </div>
        </div>

        <div class="footerNote">
          ⚠ إذا لم تكن أنت من طلب الربط لا توافق على الطلب.<br>
          ✅ استخدم كود جديد دائمًا ولا تشاركه مع أحد.
        </div>
      </div>

    </div>
  </div>

<script src="i18n.js"></script>





<script>
  (function(){
    const saved = (localStorage.getItem('lang') || 'ar').toLowerCase();
    const lang = saved.startsWith('en') ? 'en' : 'ar';

    // ضبط لغة الصفحة واتجاهها
    document.documentElement.setAttribute('lang', lang);
    document.documentElement.setAttribute('dir', lang === 'en' ? 'ltr' : 'rtl');

    // لو عندك applyLang داخل i18n.js
    if (typeof window.applyLang === 'function'){
      window.applyLang(lang);
    }
  })();
</script>







<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
    authDomain: "dynex-f4486.firebaseapp.com",
    databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
    projectId: "dynex-f4486",
    storageBucket: "dynex-f4486.firebasestorage.app"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const PC_LINKS_PATH = "pc_links";
  const REQ_ROOT = "pc_link_requests";
  const HOME_PAGE = "index100.html";

  // ✅✅ مسار جلسة الكمبيوتر في Firebase (عشان حذف الجلسة يطلع الكمبيوتر فوراً)
  const PC_SESS_PATH = "pc_sessions";

  // ✅ 15 يوم
  const SESSION_TTL_MS = 15 * 24 * 60 * 60 * 1000;

  // ✅✅ اسم جلسة الكمبيوتر فقط (مختلف عن الهاتف)
  const PC_SESSION_KEY = "dynex_pc_session";


  const splash = document.getElementById('splash');
  const sHint  = document.getElementById('sHint');

  const codeInput  = document.getElementById('codeInput');
  const sendBtn    = document.getElementById('sendBtn');
  const resetBtn   = document.getElementById('resetBtn');
  const statusText = document.getElementById('statusText');
  const statusPill = document.getElementById('statusPill');
  const statusBox  = document.getElementById('status');
  const liveDot = document.getElementById('liveDot');
  const liveTxt = document.getElementById('liveTxt');

  /* ==========================
     ✅✅ إضافة الترجمة (AR/EN)
     لا تغيّر شيء ثاني
     ========================== */
  const MSG = {
    ar: {
      sessionFound: 'تم العثور على جلسة — جاري الدخول…',
      noSession: 'لا توجد جلسة — افتح تسجيل الدخول',
      enterFirst: 'أدخل الكود أولاً',
      checking: 'جاري التحقق من الكود…',
      invalid: 'الكود غير صحيح',
      used: 'هذا الكود مستخدم من قبل',
      expired: 'انتهت صلاحية الكود — ولّد كود جديد من الجوال',
      bad: 'الكود غير صالح',
      pending: 'تم إرسال الطلب… بانتظار موافقة الجوال',
      approved: 'تمت الموافقة ✅ جاري تسجيل الدخول…',
      rejected: 'المستخدم لغى العملية ❌',
      dbError: 'تعذّر الاتصال بالقاعدة',
      readyHint: 'اكتب الكود ثم اضغط إرسال الطلب.'
    },
    en: {
      sessionFound: 'Session found — logging in…',
      noSession: 'No session — open login',
      enterFirst: 'Enter the code first',
      checking: 'Checking code…',
      invalid: 'Invalid code',
      used: 'This code has been used before',
      expired: 'Code expired — generate a new code from your phone',
      bad: 'Bad code',
      pending: 'Request sent… waiting for phone approval',
      approved: 'Approved ✅ Logging in…',
      rejected: 'User canceled ❌',
      dbError: 'Could not connect to database',
      readyHint: 'Enter the code then press Send request.'
    }
  };

  function getLang(){
    const saved = (localStorage.getItem('lang') || 'ar').toLowerCase();
    return saved.startsWith('en') ? 'en' : 'ar';
  }
  function t(key){
    const lang = getLang();
    return (MSG[lang] && MSG[lang][key]) || (MSG.ar[key] || key);
  }
  /* ========================== */

  function hideSplashShowLogin(){
    splash.classList.add('hide');
    document.documentElement.classList.remove('boot');
  }

  /* ==========================================================
     ✅✅ مراقبة جلسة الكمبيوتر في Firebase
     إذا الجوال عمل connected=false أو revokedAt -> يخرج الكمبيوتر فوراً
     ========================================================== */
  /* ==========================================================
   ✅✅ مراقبة جلسة الكمبيوتر في Firebase
   إذا الجوال عمل connected=false أو revokedAt -> يخرج الكمبيوتر فوراً
   ========================================================== */
let pcWatchOff = null;
function startPcSessionWatch(uid){
  const U = String(uid || '');
  if(!U) return;

  if(pcWatchOff){
    try{ pcWatchOff(); }catch(_){}
    pcWatchOff = null;
  }

  const ref = db.ref(`${PC_SESS_PATH}/${U}`);

  const kick = ()=>{
    try{ localStorage.removeItem(PC_SESSION_KEY); }catch(_){}
    // ✅ يرجع لصفحة إدخال الكود مباشرة
    window.location.replace(window.location.pathname + window.location.search);
  };

  const onValue = (snap)=>{
    const v = snap.val() || {};
    if(v.connected === false || v.revokedAt){
      kick();
    }
  };

  ref.on('value', onValue);
  pcWatchOff = ()=> ref.off('value', onValue);
}

/* ==========================
   ✅ فحص الجلسة وقت المقدمة
   ========================== */
(function bootCheck(){
  let ok = false;

  try{
    const raw = localStorage.getItem(PC_SESSION_KEY);
    if(raw){
      const sess = JSON.parse(raw);
      const now  = Date.now();
      const exp  = Number(sess?.expiresAt || 0);

      if(sess?.uid && exp > now){
        ok = true;
        startPcSessionWatch(sess.uid);
      } else {
        localStorage.removeItem(PC_SESSION_KEY);
      }
    }
  }catch(_){
    localStorage.removeItem(PC_SESSION_KEY);
  }

  if(ok){
    sHint.textContent = t('sessionFound');
    setTimeout(()=>window.location.replace(HOME_PAGE), 220);
  }else{
    sHint.textContent = t('noSession');
    setTimeout(hideSplashShowLogin, 240);
  }
})();

  function setStatus(text, pill, type){
    statusText.textContent = text;
    statusPill.textContent = pill;
    statusBox.classList.remove('ok','no');
    if(type==='ok') statusBox.classList.add('ok');
    if(type==='no') statusBox.classList.add('no');

    liveTxt.textContent = pill || 'READY';
    if(type==='ok') liveDot.classList.add('on');
    else liveDot.classList.remove('on');
  }

  function normalizeCode(s){
    return String(s||'').trim().replace(/\s+/g,'').toUpperCase();
  }

  function getDeviceInfo(){
    return {
      ua: navigator.userAgent || '',
      platform: navigator.platform || '',
      lang: navigator.language || ''
    };
  }

  (function fillDeviceCard(){
    const d = getDeviceInfo();
    document.getElementById('vBrowser').textContent  = (d.ua || '—').slice(0, 90);
    document.getElementById('vPlatform').textContent = (d.platform || '—').slice(0, 60);
    document.getElementById('vLang').textContent     = (d.lang || '—').slice(0, 20);
  })();

  let currentListenerOff = null;
  function stopListening(){
    if(currentListenerOff){
      try{ currentListenerOff(); }catch(_){}
      currentListenerOff = null;
    }
  }

  async function createDesktopSession(uid){
    const snap = await db.ref('users/' + uid).get();
    const user = snap.exists() ? (snap.val() || {}) : {};

    const now = Date.now();
    const sess = {
      uid: String(uid),
      accountId: user.accountId || null,
      name: user.name || '',
      username: user.username || '',
      phone: user.phone || '',
      loginAt: now,
      expiresAt: now + SESSION_TTL_MS
    };

    // ✅ حفظ جلسة الكمبيوتر
    localStorage.setItem(PC_SESSION_KEY, JSON.stringify(sess));

    // ✅ مهم جداً: احفظ كمان في المفتاح القديم عشان index100.html يشتغل
    
  }

  async function sendRequest(){
    stopListening();
    const code = normalizeCode(codeInput.value);
    if(!code){ setStatus(t('enterFirst'), 'EMPTY', 'no'); return; }

    sendBtn.disabled = true;
    setStatus(t('checking'), 'CHECK', '');

    try{
      const linkSnap = await db.ref(`${PC_LINKS_PATH}/${code}`).get();
      if(!linkSnap.exists()){
        setStatus(t('invalid'), 'INVALID', 'no');
        return;
      }

      const link = linkSnap.val() || {};
      const now = Date.now();

      if(link.used === true){
        setStatus(t('used'), 'USED', 'no');
        return;
      }

      if(Number(link.expiresAt || 0) < now){
        setStatus(t('expired'), 'EXPIRED', 'no');
        return;
      }

      const uid = String(link.uid || '');
      if(!uid){
        setStatus(t('bad'), 'BAD', 'no');
        return;
      }

      const reqRef = db.ref(`${REQ_ROOT}/${uid}`).push();
      const reqId = reqRef.key;

      await reqRef.set({
        status: 'pending',
        code: code,
        createdAt: now,
        device: getDeviceInfo()
      });

      setStatus(t('pending'), 'PENDING', '');

      const reqNode = db.ref(`${REQ_ROOT}/${uid}/${reqId}`);

      const onValue = async (snap)=>{
        if(!snap.exists()) return;
        const v = snap.val() || {};
        const st = String(v.status || 'pending').toLowerCase();

        if(st === 'approved'){
          setStatus(t('approved'), 'APPROVED', 'ok');

          try{
            await db.ref(`${PC_LINKS_PATH}/${code}`).update({
              used: true,
              usedAt: Date.now(),
              usedByRequest: reqId
            });
          }catch(_){}

          await createDesktopSession(uid);

          // ✅ ابدأ مراقبة جلسة الكمبيوتر بعد الدخول
          startPcSessionWatch(uid);

          setTimeout(()=>window.location.replace(HOME_PAGE), 350);
        }

        if(st === 'rejected'){
          setStatus(t('rejected'), 'REJECTED', 'no');
        }
      };

      reqNode.on('value', onValue);
      currentListenerOff = ()=> reqNode.off('value', onValue);

    }catch(e){
      console.error(e);
      setStatus(t('dbError'), 'ERROR', 'no');
    }finally{
      sendBtn.disabled = false;
    }
  }

  sendBtn.addEventListener('click', sendRequest);

  resetBtn.addEventListener('click', ()=>{
    stopListening();
    codeInput.value = '';
    setStatus(t('readyHint'), 'READY', '');
    codeInput.focus();
  });

  codeInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') sendRequest();
  });

  setStatus(t('readyHint'), 'READY', '');
</script>
</body>
</html>
