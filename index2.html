<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex – الإيداعات</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --gray:#C7C7C7;
      --accent:#F36523;
      --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --top:54px; --radius:16px; --top-icon:#1E3A8A;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff;min-height:100dvh;overflow-x:hidden}

    .appbar{position:fixed;top:0;inset-inline:0;height:var(--top);z-index:40;background:var(--gray);
      display:flex;align-items:center;justify-content:space-between;padding:4px 10px;box-shadow:0 1px 0 #bfbfbf}
    .accent-line{height:3px;background:var(--accent)}
    .btn{width:40px;height:40px;border-radius:12px;background:#fff;border:1px solid #d3d3d3;display:grid;place-items:center;cursor:pointer;color:var(--top-icon);position:relative;overflow:hidden}
    .btn.orange{color:var(--accent)}
    .ms{font-family:'Material Symbols Rounded';font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24;line-height:1}

    .page{width:min(520px,92vw);margin:0 auto;padding:14px 0 84px; padding-top:calc(var(--top) + 16px);}
    h1{margin:8px 10px 12px;font-size:20px}

    .actions{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:0 10px;margin-bottom:12px}
    .p2p{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:800;cursor:pointer;display:flex;align-items:center;gap:6px}
    .p2p .ms{color:var(--accent)}

    .nets{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:0 10px}
    @media (min-width:420px){ .nets{grid-template-columns:repeat(3,1fr);} }
    .net-card{
      background:#f7f8fa;border:1px solid #e6e7ea;border-radius:16px;padding:14px;
      display:flex;flex-direction:column;align-items:center;gap:10px;text-decoration:none;color:inherit;
      position:relative;overflow:hidden;box-shadow:0 8px 16px rgba(0,0,0,.06); transition:transform .12s, box-shadow .12s, border-color .12s;
    }
    .net-card:hover{transform:translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,.10); border-color:#f0b08f}
    .net-card img{width:44px;height:44px;object-fit:contain}
    .net-name{font-weight:800}
    .net-chain{font-size:12px;color:#64748b}

    .sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;visibility:hidden;transition:.25s;z-index:60}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -10px 28px rgba(0,0,0,.2);
      transform:translateY(100%);transition:.3s;z-index:61;padding:14px;border:1px solid #ececec}
    .sheet.active{transform:translateY(0)}
    .sheet-backdrop.active{opacity:1;visibility:visible}
    .grab{width:40px;height:4px;border-radius:3px;background:#e5e7eb;margin:4px auto 12px}
    .row{display:flex;align-items:center;gap:10px}
    .sheet .logo{width:42px;height:42px;border-radius:12px;background:#fff;display:grid;place-items:center;border:1px solid #e6e7ea;overflow:hidden}
    .sheet h3{margin:4px 0 2px}
    .badge{font-size:11px;color:#fff;background:var(--accent);padding:3px 8px;border-radius:999px;font-weight:800}

    .field{display:flex;align-items:center;gap:8px;background:#f9fafb;border:1px solid #e6e7ea;border-radius:12px;padding:10px}
    .field input{flex:1;border:none;background:transparent;outline:none;font-family:inherit}

    .cpy,.btn-orange,.btn-blue{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:800;display:flex;align-items:center;gap:6px
    }
    .btn-orange{background:var(--accent);border-color:var(--accent);color:#000}
    .btn-blue{background:#fff;border-color:#e3e3e3;color:#000}

    .qr{margin-top:12px;background:#fff;border:1px solid #e6e7ea;border-radius:16px;padding:14px;
        display:grid;place-items:center;min-height:220px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .qr img{width:220px;height:220px;object-fit:contain;border-radius:12px}
    .qr .ph{font-weight:800;font-size:12px;color:#ef4444;text-align:center}

    .hint{margin-top:8px;color:#64748b;font-size:12px}

    .exit-actions{display:flex;gap:10px;margin-top:8px}
    .exit-actions button{flex:1}

    .toast{position:fixed;bottom:78px;left:50%;transform:translateX(-50%) scale(.96);background:rgba(17,17,17,.92);color:#fff;
      padding:8px 12px;border-radius:10px;font-weight:800;font-size:12px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:70}
    .toast.show{opacity:1;transform:translateX(-50%) scale(1)}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(0,0,0,.18);animation:ripple .6s linear;pointer-events:none}
    @keyframes ripple{to{transform:scale(3);opacity:0}}
    .ripple-container{position:relative;overflow:hidden}
  </style>
  
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e5e7eb">
  
</head>
<body>

  <!-- الشريط العلوي -->
  <header class="appbar">
    <button class="btn ripple-container orange" id="backBtn" title="خروج"><span class="ms">arrow_back_ios_new</span></button>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn ripple-container" id="supportBtn" title="خدمة العملاء"><span class="ms">headset_mic</span></button>
      <button class="btn ripple-container orange" id="langBtn" title="تغيير اللغة" style="font-weight:800">؏</button>
    </div>
  </header>
  <div class="accent-line"></div>

  <main class="page">
    <h1>الإيداعات</h1>

    <div class="actions">
      <div style="color:#64748b;font-weight:700">اختر الشبكة:</div>
      <button class="p2p ripple-container" id="p2pBtn"><span class="ms">swap_horiz</span> P2P</button>
    </div>

    <div class="nets" id="nets"></div>
  </main>

  <!-- Sheet تفاصيل الشبكة -->
  <div class="sheet-backdrop" id="sheetBack"></div>
  <div class="sheet" id="netSheet" aria-modal="true" role="dialog">
    <div class="grab"></div>
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="logo"><img id="sheetLogo" src="" alt="" style="width:32px;height:32px;object-fit:contain"></div>
        <div>
          <h3 id="sheetName" style="margin:0"></h3>
          <div class="badge" id="sheetChain"></div>
        </div>
      </div>
      <button class="btn ripple-container" id="closeSheet" title="إغلاق"><span class="ms">close</span></button>
    </div>

    <!-- لا إنشاء كود، كله يدوي -->
    <div id="createWrap" class="row" style="display:none"></div>

    <div class="field" style="margin-top:10px">
      <input id="addr" readonly value="">
      <button class="cpy ripple-container" id="copyBtn"><span class="ms">content_copy</span> نسخ</button>
    </div>

    <div id="memoWrap" class="field" style="margin-top:10px;display:none">
      <input id="memo" readonly value="">
      <button class="cpy ripple-container" id="copyMemo"><span class="ms">content_copy</span> نسخ الميمو</button>
    </div>

    <div class="row" style="margin-top:10px;gap:8px">
      <button class="cpy ripple-container" id="toggleQr"><span class="ms">qr_code_2</span> إخفاء QR</button>
      <button class="cpy ripple-container" id="guide"><span class="ms">help</span> تعليمات</button>
    </div>
    <div class="qr" id="qrBox">
      <img id="qrImg" src="" alt="QR">
      <div class="ph" id="qrPh" style="display:none"></div>
    </div>

    <div class="row" style="margin-top:10px;gap:8px;justify-content:flex-start">
      <button class="btn-orange ripple-container" id="confirmBtn"><span class="ms">check_circle</span> تأكيد الإيداع</button>
    </div>

    <div class="hint">أرسل فقط على الشبكة الصحيحة. التحويل على شبكة خاطئة قد يؤدي لفقدان الرصيد.</div>
  </div>

  <!-- Sheet تأكيد الخروج -->    <div class="sheet-backdrop" id="sheetBackExit"></div>  
  <div class="sheet" id="exitSheet">  
    <div class="grab"></div>  
    <h3 style="text-align:center;margin:6px 0 10px">تأكيد الخروج؟</h3>  
    <div class="exit-actions">  
      <button class="btn-blue ripple-container" id="exitNo">إلغاء</button>  
      <button class="btn-orange ripple-container" id="exitYes">خروج</button>  
    </div>  
  </div>

  <!-- (جديد) Sheet اللغة -->
  <div class="sheet-backdrop" id="sheetBackLang"></div>
  <div class="sheet" id="langSheet">
    <div class="grab"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button class="btn-blue ripple-container" data-setlang="ar" id="btnAr">العربية</button>
      <button class="btn-blue ripple-container" data-setlang="en" id="btnEn">English</button>
    </div>
  </div>

  <!-- (جديد) Sheet التعليمات -->
  <div class="sheet-backdrop" id="sheetBackGuide"></div>
  <div class="sheet" id="guideSheet">
    <div class="grab"></div>
    <h3 style="margin:4px 0 8px">تعليمات سريعة</h3>
    <ol style="margin:0 0 10px 0;padding-inline-start:22px;color:#374151;font-weight:700;font-size:14px;line-height:1.6">
      <li>اختر الشبكة الصحيحة واضغط عليها.</li>
      <li>انسخ العنوان (والميمو إذا ظهر).</li>
      <li>حوّل المبلغ ثم اضغط <strong>تأكيد الإيداع</strong>.</li>
      <li>تفادي التحويل على شبكة خاطئة.</li>
    </ol>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button class="btn-blue ripple-container" id="guideOk">إغلاق</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="i18n.js"></script>

  <script>
    /* أكوادك اليدوية (فارغة افتراضيًا) */
    const PRESET_CODES = {
      bitcoin_btc: '0x972c53c22afd59d742df832ea21da13f9f1ba679',
      ethereum_erc20: '0x972c53c22afd59d742df832ea21da13f9f1ba679',
      tether_trc20:   'TLYpJ1MFnYesMetZFYV56oYBr6wW7oVy7u',
      tether_erc20:   '0x972c53c22afd59d742df832ea21da13f9f1ba679',
      tron_TRC20:     'TLYpJ1MFnYesMetZFYV56oYBr6wW7oVy7u',
      bnb_smart_chain_bep20: '0x972c53c22afd59d742df832ea21da13f9f1ba679',
      solana_sol:     '3UpHNNFwT4o5XguuxYsqf4PkT1FuzcwUCKY9MWY6RNKm',
      payeer_usd:     ''
    };

    /* تجاهل أي أكواد قديمة محفوظة، وامسحها مرة واحدة */
    const CLEAR_OLD_SAVED_ON_LOAD = true;

    const networks = [
      {name:'Bitcoin',  chain:'BEC20',     icon:'ايقوناة الشبكاة6.jpg', addr:'',            qr:'بارقكود2.png'},
      {name:'Ethereum', chain:'ERC20',   icon:'ايقوناة الشبكاة5.jpg', addr:'',            qr:'بارقكود3.png'},
      {name:'Tether',   chain:'TRC20',   icon:'ايقوناة الشبكاة4.jpg', addr:'',            qr:'بارقكود.png'},
      {name:'Tether',   chain:'ERC20',   icon:'ايقوناة الشبكاة4.jpg', addr:'',            qr:'بارقكود1.png'},
      {name:'Tron',     chain:'TRC20',     icon:'ايقوناة الشبكاة3.jpg', addr:'',            qr:'بارقكود4.png'},
      {name:'BNB Smart Chain', chain:'BEP20', icon:'ايقوناة الشبكاة2.jpg', addr:'', memo:'', qr:'بارقكود5.png'},
      {name:'Solana',   chain:'SOL',     icon:'ايقوناة الشبكاة1.jpg', addr:'',            qr:'بارقكود6.png'},
      {name:'Payeer',   chain:'USD',     icon:'ايقوناة الشبكاة.jpg',  addr:'P1131550839', qr:null }
    ];

    const netsBox = document.getElementById('nets');
    networks.forEach((n,i)=>{
      const a = document.createElement('a');
      a.className = 'net-card ripple-container';
      a.href = '#'; a.dataset.index = i;
      a.innerHTML = `
        <img src="${n.icon}" alt="${n.name}" onerror="this.style.opacity=.25">
        <div class="net-name">${n.name}</div>
        <div class="net-chain">${n.chain}</div>
      `;
      a.addEventListener('click', (e)=>{ e.preventDefault(); ripple(e); openNet(i); });
      netsBox.appendChild(a);
    });

    const back = document.getElementById('sheetBack');
    const sheet = document.getElementById('netSheet');
    const sheetLogo = document.getElementById('sheetLogo');
    const sheetName = document.getElementById('sheetName');
    const sheetChain = document.getElementById('sheetChain');
    const addr = document.getElementById('addr');
    const memoWrap = document.getElementById('memoWrap');
    const memo = document.getElementById('memo');
    const qrBox = document.getElementById('qrBox');
    const qrImg = document.getElementById('qrImg');
    const qrPh  = document.getElementById('qrPh');
    const toggleQrBtn = document.getElementById('toggleQr');
    const confirmBtn = document.getElementById('confirmBtn');

    /* ✅ اجعل المتغيّر عالمي عشان كود التأكيد يشوفه */
    window.currentNet = null;
    let qrVisible = true;

    const KEY_PREFIX = 'dnx_code_';
    const makeKey = (n)=> KEY_PREFIX + (n.name+'_'+n.chain).replace(/\s+/g,'_').toLowerCase();
    const keyOf   = (n)=> (n.name+'_'+n.chain).replace(/\s+/g,'_').toLowerCase();
    const getPreset = (n)=> PRESET_CODES[keyOf(n)] || '';

    if (CLEAR_OLD_SAVED_ON_LOAD) {
      try { networks.forEach(n=> localStorage.removeItem(makeKey(n))); } catch(_) {}
    }

    async function openNet(i){
      const n = networks[i];
      /* ✅ خزّنها على window بدل متغيّر محلي */
      window.currentNet = n;

      sheetLogo.src = n.icon;
      sheetName.textContent = n.name;
      sheetChain.textContent = n.chain;

      const preset = getPreset(n);
      addr.value = preset || n.addr || '';

      if(n.memo){ memoWrap.style.display=''; memo.value=n.memo; } else { memoWrap.style.display='none'; }

      if(n.qr){
        qrBox.style.display = 'grid';
        qrVisible = true;
        toggleQrBtn.style.display = '';
        toggleQrBtn.innerHTML = '<span class="ms">hide_image</span>  QR';

        const ok = await checkImage(n.qr);
        if(ok){ qrImg.src = n.qr; qrImg.style.display='block'; qrPh.style.display='none'; }
        else  { qrImg.style.display='none'; qrPh.textContent = 'ارفع صورة QR باسم: ' + n.qr + ' في نفس المجلد'; qrPh.style.display='block'; }
      }else{
        qrBox.style.display = 'none';
        toggleQrBtn.style.display = 'none';
      }

      sheet.classList.add('active'); back.classList.add('active');
    }
    function closeNet(){ sheet.classList.remove('active'); back.classList.remove('active'); }
    back.onclick = closeNet;
    document.getElementById('closeSheet').onclick = closeNet;

    toggleQrBtn.onclick = (e)=>{
      ripple(e);
      /* ✅ افحص window.currentNet */
      if(!window.currentNet || !window.currentNet.qr) return;
      qrVisible = !qrVisible;
      qrBox.style.display = qrVisible ? 'grid' : 'none';
      toggleQrBtn.innerHTML = qrVisible
        ? '<span class="ms">hide_image</span>  QR'
        : '<span class="ms">qr_code_2</span>  QR';
    };

    qrImg.onclick = ()=>{ if (qrImg.src) window.open(qrImg.src, '_blank'); };

    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }
    document.getElementById('copyBtn').onclick = async (e)=>{ ripple(e); try{ await navigator.clipboard.writeText(addr.value); toast('تم النسخ'); }catch(_){ toast(addr.value); } };
    document.getElementById('copyMemo').onclick = async (e)=>{ ripple(e); try{ await navigator.clipboard.writeText(memo.value); toast('تم النسخ'); }catch(_){ toast(memo.value); } };

    document.getElementById('p2pBtn').onclick = (e)=>{ ripple(e); window.location.href='index3.html'; };
    document.getElementById('supportBtn').onclick = ()=> window.open('https://t.me/artikarbot','_blank');

    /* ========== زر اللغة يفتح شيت اللغة ========== */
    const langSheet = document.getElementById('langSheet');
    const sheetBackLang = document.getElementById('sheetBackLang');
    document.getElementById('langBtn').onclick = (e)=>{ ripple(e); langSheet.classList.add('active'); sheetBackLang.classList.add('active'); };
    sheetBackLang.onclick = ()=>{ langSheet.classList.remove('active'); sheetBackLang.classList.remove('active'); };
    document.querySelectorAll('[data-setlang]').forEach(btn=>{
      btn.onclick = ()=>{ const L = btn.dataset.setlang; if (typeof applyLang==='function') applyLang(L); sheetBackLang.click(); };
    });

    // خروج
    const exitSheet = document.getElementById('exitSheet');
    const sheetBackExit = document.getElementById('sheetBackExit');
    document.getElementById('backBtn').onclick = (e)=>{ ripple(e); exitSheet.classList.add('active'); sheetBackExit.classList.add('active'); };
    function closeExit(){ exitSheet.classList.remove('active'); sheetBackExit.classList.remove('active'); }
    sheetBackExit.onclick = closeExit;
    document.getElementById('exitNo').onclick = (e)=>{ ripple(e); closeExit(); };
    document.getElementById('exitYes').onclick = (e)=>{ ripple(e); if(history.length>1){history.back();} else {window.location.replace('index1.html');} };

    function ripple(ev){
      const t = ev.currentTarget || (ev.target && ev.target.closest('.ripple-container')); if(!t) return;
      const r = document.createElement('span');
      const d = Math.max(t.clientWidth,t.clientHeight);
      const rect = t.getBoundingClientRect();
      r.className='ripple'; r.style.width=r.style.height=d+'px';
      r.style.left=(ev.clientX - rect.left - d/2)+'px';
      r.style.top =(ev.clientY - rect.top  - d/2)+'px';
      const old=t.querySelector('.ripple'); if(old) old.remove();
      t.appendChild(r); setTimeout(()=>r.remove(),600);
    }
    document.querySelectorAll('.ripple-container').forEach(el=>el.addEventListener('click', ripple));

    function checkImage(src){
      return new Promise(res=>{
        const img = new Image();
        img.onload = ()=>res(true);
        img.onerror = ()=>res(false);
        img.src = src + '?v=' + Date.now();
      });
    }

    /* ========== شيت التعليمات ========== */
    const guideBtn = document.getElementById('guide');
    const guideSheet = document.getElementById('guideSheet');
    const sheetBackGuide = document.getElementById('sheetBackGuide');
    const guideOk = document.getElementById('guideOk');

    guideBtn.onclick = (e)=>{ ripple(e); guideSheet.classList.add('active'); sheetBackGuide.classList.add('active'); };
    sheetBackGuide.onclick = ()=>{ guideSheet.classList.remove('active'); sheetBackGuide.classList.remove('active'); };
    guideOk.onclick = (e)=>{ ripple(e); sheetBackGuide.click(); };

  // دالة لإعادة تسمية العناصر الديناميكية حسب اللغة وحالة QR
  function relabelDeposits(lang){
    var toggle = document.getElementById('toggleQr');
    var guide  = document.getElementById('guide');
    var copy1  = document.getElementById('copyBtn');
    var copy2  = document.getElementById('copyMemo');

    var qrBox  = document.getElementById('qrBox');
    var isVisible = qrBox && qrBox.style.display !== 'none';

    if (toggle){
      toggle.innerHTML = '<span class="ms">'+(isVisible?'hide_image':'qr_code_2')+'</span> ' +
        (lang==='ar' ? (isVisible?'إخفاء QR':'إظهار QR') : (isVisible?'Hide QR':'Show QR'));
    }
    if (guide){
      guide.innerHTML = '<span class="ms">help</span> ' + (lang==='ar' ? 'تعليمات' : 'Guide');
    }
    if (copy1){
      copy1.innerHTML = '<span class="ms">content_copy</span> ' + (lang==='ar' ? 'نسخ' : 'Copy');
    }
    if (copy2){
      copy2.innerHTML = '<span class="ms">content_copy</span> ' + (lang==='ar' ? 'نسخ الميمو' : 'Copy memo');
    }
  }

  document.addEventListener('i18n:change', function(ev){
    relabelDeposits(ev.detail.lang || 'en');
  });

  (function(){
    var L = (window.DynexI18N && DynexI18N.current()) || localStorage.getItem('lang') || 'en';
    relabelDeposits(L);
  })();

  </script>

  <!-- ===== Firebase compat + حفظ تأكيد الإيداع ===== -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const session = (function(){
      try{ return JSON.parse(localStorage.getItem('dynex_session') || '{}'); }
      catch(_){ return {}; }
    })();
  </script>

  <script>
    (function(){
      const btn = document.getElementById('confirmBtn');
      if(!btn) return;

      btn.addEventListener('click', async (e)=>{
        ripple(e);

        // ✅ الآن بيشوف الشبكة المختارة لأننا حفظناها في window.currentNet
        if(!window.currentNet){
          const t=document.getElementById('toast'); t.textContent='اختر الشبكة أولاً'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200);
          return;
        }

        const addrEl = document.getElementById('addr');
        const memoEl = document.getElementById('memo');

        const payload = {
          uid:        session.uid || null,
          accountId:  session.accountId || null,
          name:       session.name || null,
          network:    String(window.currentNet.name || ''),
          chain:      String(window.currentNet.chain || ''),
          address:    (addrEl && addrEl.value) || window.currentNet.addr || null,
          memo:       (memoEl && memoEl.value) || window.currentNet.memo || null,
          createdAt:  firebase.database.ServerValue.TIMESTAMP,
          clientTime: Date.now()
        };

        const prevHTML = btn.innerHTML;
        btn.disabled = true;
        btn.style.opacity = .85;
        btn.innerHTML = '<span class="ms">hourglass_top</span> جارٍ التأكيد';

        try{
          const baseRef = session.uid ? db.ref('deposits/' + session.uid) : db.ref('deposits_unlinked');
          const newRef = baseRef.push();
          await newRef.set(payload);

          const t=document.getElementById('toast'); t.textContent='تم إرسال تأكيد الإيداع'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200);
          setTimeout(()=>{
            const c = document.getElementById('closeSheet');
            if(c) c.click();
          }, 600);
        }catch(err){
          console.error(err);
          const t=document.getElementById('toast'); t.textContent='تعذّر الحفظ، حاول مرة أخرى'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200);
        }finally{
          btn.disabled = false;
          btn.style.opacity = '';
          btn.innerHTML = prevHTML;
        }
      });
    })();
  </script>
  
    <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
</script>
  
  
</body>
</html>