<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex</title>

  <!-- خطوط وأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --gray:#C7C7C7; --accent:#F36523;
      --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --top:54px; --top-icon:#1E3A8A;
      --surface:#f7f8fa; --shadow:0 8px 16px rgba(0,0,0,.06);
      --ok:#16a34a;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff;min-height:100dvh;overflow-x:hidden}

    /* Appbar */
    .appbar{position:fixed;top:0;inset-inline:0;height:var(--top);z-index:40;background:var(--gray);
      display:flex;align-items:center;justify-content:space-between;padding:4px 10px;box-shadow:0 1px 0 #bfbfbf}
    .accent-line{height:3px;background:var(--accent)}
    .btn{width:40px;height:40px;border-radius:12px;background:#fff;border:1px solid #d3d3d3;display:grid;place-items:center;cursor:pointer;color:var(--top-icon);position:relative;overflow:hidden}
    .btn.orange{color:var(--accent)}
    .ms{font-family:'Material Symbols Rounded';font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24;line-height:1}

    /* Page */
    .page{width:min(520px,92vw);margin:0 auto;padding:14px 10px 84px; padding-top:calc(var(--top) + 16px);}
    h1{margin:6px 0 12px;font-size:20px}

    /* Cards */
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .opt{display:flex;align-items:center;gap:10px;border:1px solid var(--line);border-radius:14px;padding:10px;cursor:pointer;background:#fafafa}
    .opt input{width:18px;height:18px}
    .opt .flag{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#fff;border:1px solid var(--line)}
    .opt.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(243,101,35,.15);background:#fff}
    .hint{font-size:12px;color:var(--muted)}
    .preview{padding:14px;border:1px dashed #e5e7eb;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa)}

    /* Buttons / toast / ripple */
    .btn-solid{padding:11px 12px;border-radius:12px;border:1px solid var(--line);font-weight:800;cursor:pointer;background:#fff}
    .btn-solid.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .toast{position:fixed;bottom:78px;left:50%;transform:translateX(-50%) scale(.96);background:rgba(17,17,17,.92);color:#fff;
      padding:8px 12px;border-radius:10px;font-weight:800;font-size:12px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:70}
    .toast.show{opacity:1;transform:translateX(-50%) scale(1)}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(0,0,0,.18);animation:ripple .6s linear;pointer-events:none}
    @keyframes ripple{to{transform:scale(3);opacity:0}}
  </style>
  
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e5e7eb">


<link rel="icon" type="image/png" sizes="32x32" href="32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="16x16.png">
<link rel="shortcut icon" href="/favicon.ico">

<!-- iOS -->
<link rel="apple-touch-icon" sizes="180x180" href="icon.png">

<!-- Android / PWA -->
<link rel="manifest" href="/site.webmanifest">

<!-- Safari pinned tab (اختياري) -->
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#e5e7eb">

<!-- ألوان النظام (اختياري) -->

<meta name="msapplication-TileColor" content="#e5e7eb">
  
</head>
<body>

  <!-- Appbar -->
  <header class="appbar">
    <button class="btn orange" id="backBtn" title="خروج" data-i18n-title="back_title"><span class="ms">arrow_back_ios_new</span></button>
    <div class="row">
      <button class="btn" id="supportBtn" title="خدمة العملاء" data-i18n-title="support_title"><span class="ms">headset_mic</span></button>
     <button class="btn orange" id="langBtn" title="تغيير اللغة">
  <span class="ms">g_translate</span>
</button>
    </div>
  </header>
  <div class="accent-line"></div>

  <main class="page">
    <h1 data-i18n="title">لغة التطبيق</h1>

    <!-- اختيار اللغة -->
    <div class="card" style="margin-bottom:12px">
      <div class="row" style="gap:10px;align-items:stretch">
        <label class="opt" id="optAr">
          <input type="radio" name="lang" value="ar">
          <div class="flag">ع</div>
          <div>
            <div style="font-weight:900" data-i18n="arabic">العربية</div>
            <div class="hint" data-i18n="arabic_hint">اتجاه من اليمين لليسار</div>
          </div>
        </label>

        <label class="opt" id="optEn">
          <input type="radio" name="lang" value="en">
          <div class="flag">A</div>
          <div>
            <div style="font-weight:900" data-i18n="english">English</div>
            <div class="hint" data-i18n="english_hint">Left-to-Right layout</div>
          </div>
        </label>
      </div>
    </div>

    <!-- معاينة: يعرض اسم المستخدم الحقيقي -->
    <div class="card">
      <div class="preview" id="previewBox" dir="rtl" lang="ar">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
          <span class="ms" style="color:var(--accent)">account_circle</span>
          <b id="userName">اسم المستخدم</b>
        </div>
        <div class="hint" id="applyMsg">سيتم تطبيق اللغة على هذه الصفحة وصفحة السحب وعلى اسم المستخدم المعروض.</div>
      </div>
    </div>

    <!-- أزرار -->
    <div class="row" style="gap:10px; margin-top:12px">
      <button class="btn-solid" id="cancelBtn" style="flex:1" data-i18n="cancel">إلغاء</button>
      <button class="btn-solid primary" id="saveBtn" style="flex:1" data-i18n="save">حفظ</button>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <!-- i18n العام -->
  <script src="i18n.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
    function ripple(ev){const t=ev.currentTarget||ev.target.closest('.btn,.btn-solid,.opt'); if(!t) return; const r=document.createElement('span'); const d=Math.max(t.clientWidth,t.clientHeight); const rect=t.getBoundingClientRect(); r.className='ripple'; r.style.width=r.style.height=d+'px'; r.style.left=(ev.clientX-rect.left-d/2)+'px'; r.style.top=(ev.clientY-rect.top-d/2)+'px'; const old=t.querySelector('.ripple'); if(old) old.remove(); t.appendChild(r); setTimeout(()=>r.remove(),600);}
    document.addEventListener('click',e=>{ if(e.target.closest('.btn, .btn-solid, .opt')) ripple(e); });
    function toast(msg){const t=$("#toast"); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200);}

    // نصوص محلية
    const STR={
      ar:{back_title:'خروج',support_title:'خدمة العملاء',title:'لغة التطبيق',arabic:'العربية',arabic_hint:'اتجاه من اليمين لليسار',english:'English',english_hint:'Left-to-Right layout',cancel:'إلغاء',save:'حفظ',saved:'تم الحفظ',apply_msg:'سيتم تطبيق اللغة على هذه الصفحة وصفحة السحب وعلى اسم المستخدم المعروض.'},
      en:{back_title:'Exit',support_title:'Support',title:'App Language',arabic:'Arabic',arabic_hint:'Right-to-Left layout',english:'English',english_hint:'Left-to-Right layout',cancel:'Cancel',save:'Save',saved:'Saved',apply_msg:'Language will apply to this page, the withdrawal page, and to how your username appears.'}
    };
    function syncLocal(lang){
      const L=(lang==='en')?'en':'ar';
      $$('[data-i18n]').forEach(el=>{ const k=el.dataset.i18n; if(STR[L][k]!=null) el.textContent=STR[L][k]; });
      $$('[data-i18n-title]').forEach(el=>{ const k=el.dataset.i18nTitle; if(STR[L][k]!=null) el.setAttribute('title',STR[L][k]); });
      document.documentElement.lang=L; document.documentElement.dir=(L==='ar')?'rtl':'ltr';
      const pb=$('#previewBox'); pb.setAttribute('dir', (L==='ar')?'rtl':'ltr'); pb.setAttribute('lang', L);
      $('#applyMsg').textContent = STR[L].apply_msg;
    }
    function applyBoth(lang){ syncLocal(lang); if(typeof window.applyLang==='function'){ window.applyLang(lang); } }

    // تفعيل الحالة حسب المخزون
    const cur=localStorage.getItem('lang')||'ar';
    if(cur==='en'){ $('#optEn').classList.add('active'); $('#optEn input').checked=true; } else { $('#optAr').classList.add('active'); $('#optAr input').checked=true; }
    applyBoth(cur);

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // جلب اسم المستخدم الحقيقي من القاعدة (يركّز على p2pAccounts كما بالصورة)
    (async function showUsername(){
      const el = $('#userName');
      let session=null, uid=null, accountId=null, fallback=null;
      try{
        session = JSON.parse(localStorage.getItem('dynex_session')||'null') || null;
        uid = session?.uid || null;
        accountId = session?.accountId || null;
        fallback = session?.username || session?.name || 'اسم المستخدم';
      }catch(_){}
      el.textContent = fallback || 'اسم المستخدم'; // placeholder سريع

      async function tryGet(ref){
        try{ const s = await ref.get(); if(s.exists()){ return s.val(); } }catch(_){}
        return null;
      }

      // 1) p2pAccounts/{uid}/username
      if(uid){
        const v1 = await tryGet(db.ref('p2pAccounts/'+uid+'/username'));
        if(v1){ el.textContent = v1; return; }
      }

      // 2) users/{uid}/username
      if(uid){
        const v2 = await tryGet(db.ref('users/'+uid+'/username'));
        if(v2){ el.textContent = v2; return; }
      }

      // 3) بالبحث داخل p2pAccounts عن uid
      if(uid){
        try{
          const q = await db.ref('p2pAccounts').orderByChild('uid').equalTo(uid).limitToFirst(1).get();
          if(q.exists()){
            const first = Object.values(q.val())[0];
            if(first?.username){ el.textContent = first.username; return; }
          }
        }catch(_){}
      }

      // 4) بالبحث داخل p2pAccounts عن accountId (لو متوفر)
      if(accountId){
        try{
          const q2 = await db.ref('p2pAccounts').orderByChild('accountId').equalTo(String(accountId)).limitToFirst(1).get();
          if(q2.exists()){
            const first = Object.values(q2.val())[0];
            if(first?.username){ el.textContent = first.username; return; }
          }
        }catch(_){}
      }

      // 5) fallback: من الجلسة
      el.textContent = fallback || 'اسم المستخدم';
    })();

    // اختيار اللغة
    $$('.opt').forEach(op=>{
      op.addEventListener('click', ()=>{
        $$('.opt').forEach(o=>o.classList.remove('active'));
        op.classList.add('active');
        const val=op.querySelector('input').value;
        op.querySelector('input').checked=true;
        applyBoth(val);
      });
    });

    // أزرار
    $('#saveBtn').addEventListener('click', ()=>{
      const val = document.querySelector('input[name="lang"]:checked')?.value || 'ar';
      localStorage.setItem('lang', val);
      applyBoth(val);
      toast(STR[val].saved);
      setTimeout(()=> window.location.replace('index1.html#account'), 600);
    });
    $('#cancelBtn').addEventListener('click', ()=> window.location.replace('index1.html#account'));

    // الهيدر
    $('#backBtn').addEventListener('click', ()=> window.location.replace('index1.html#account'));
    $('#supportBtn').addEventListener('click', ()=> window.open('https://t.me/artikarbot','_blank'));

    // تبديل بالسهمين
    document.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowLeft' || e.key==='ArrowRight'){
        const current = document.querySelector('input[name="lang"]:checked')?.value || 'ar';
        const next = current==='ar' ? 'en' : 'ar';
        const el = next==='ar' ? $('#optAr') : $('#optEn');
        el.click();
      }
    });
  })();
  </script>
  
    <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
</script>
  
  
</body>
</html>